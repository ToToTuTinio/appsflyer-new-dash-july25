<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppsFlyer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-button.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f3f3f3;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #4F46E5;
            width: 0%;
            transition: width 0.3s ease;
        }
        /* Stats Table Improvements */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.92rem;
            margin-bottom: 1.2rem;
            background: #fff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .stats-table th, .stats-table td {
            padding: 0.28rem 0.13rem;
            border: 1px solid #e5e7eb;
            text-align: right;
            white-space: nowrap;
        }
        .stats-table th {
            background: #f3f4f6;
            font-weight: bold;
            color: #22223b;
            text-align: center;
        }
        .stats-table th.app-header {
            background: #e0e7ff;
            color: #3730a3;
            font-size: 1.1rem;
            text-align: left;
            padding-left: 1rem;
        }
        .stats-table td:first-child, .stats-table th:first-child {
            text-align: left !important;
            padding-left: 0.7rem;
            position: sticky;
            left: 0;
            background: #fff;
            z-index: 2;
            box-shadow: 2px 0 6px -2px rgba(60,60,100,0.10);
        }
        .stats-table th:first-child {
            background: #e0e7ff;
            z-index: 3;
            box-shadow: 2px 0 8px -2px rgba(60,60,100,0.13);
        }
        .stats-table {
            min-width: 900px;
        }
        .stats-table-container {
            overflow-x: auto;
            width: 100%;
        }
        .app-card {
            border: 1.5px solid #e5e7eb;
            border-radius: 1rem;
            margin-bottom: 2.5rem;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 2rem 1.5rem 2.5rem 1.5rem;
            transition: box-shadow 0.2s;
        }
        .app-card:hover {
            box-shadow: 0 6px 24px rgba(80,80,180,0.10);
        }
        .trend-graph {
            height: 260px;
            margin-top: 2.2rem;
        }
        @media (max-width: 900px) {
          .fraud-graph-container { min-width: 180px !important; }
        }
        @media (max-width: 600px) {
          .fraud-graph-container { min-width: 120px !important; }
        }
        /* Sticky metric column for stats table */
        .sticky-metric-col {
          position: sticky;
          left: 0;
          background: #eef2ff !important; /* indigo-50 */
          z-index: 3;
          border-right: 2px solid #e0e7ff;
          min-width: 120px;
          max-width: 220px;
          box-shadow: 2px 0 8px -2px rgba(60,60,100,0.10);
        }
        .fraud-app-card { background: #f8fafc; border-radius: 1rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(80,80,180,0.06); border: 1.5px solid #e0e7ff; }
        .fraud-app-header { background: #e0e7ff; color: #3730a3; font-size: 1.1rem; font-weight: bold; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem; border-bottom: 1.5px solid #c7d2fe; }
        .fraud-table { width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 0 0 1rem 1rem; overflow: hidden; }
        .fraud-table th { background: #f1f5f9; color: #334155; font-weight: 700; font-size: 0.95rem; padding: 0.7rem 1rem; text-align: left; }
        .fraud-table th.fraud-center, .fraud-table td.fraud-center { text-align: center !important; }
        .fraud-table td { padding: 0.7rem 1rem; font-size: 1rem; border-bottom: 1px solid #f1f5f9; }
        .fraud-table tr:last-child td { border-bottom: none; }
        .fraud-media-source { font-family: 'Menlo', 'Consolas', monospace; font-weight: 500; color: #475569; }
        .fraud-badge-pa { background: #fee2e2; color: #dc2626; font-weight: bold; border-radius: 9999px; padding: 0.25em 0.9em; font-size: 1rem; display: inline-block; }
        .fraud-badge-rt { background: #fef9c3; color: #ca8a04; font-weight: bold; border-radius: 9999px; padding: 0.25em 0.9em; font-size: 1rem; display: inline-block; }
        .fraud-table tr:nth-child(even) { background: #f9fafb; }
        .fraud-table tr:hover { background: #e0e7ff22; }
        
        /* Enhanced Apps Page Styles */
        .apps-row {
            transition: all 0.3s ease;
        }
        
        /* Enhanced Overview Page Animations */
        canvas {
            transition: opacity 0.3s ease-in-out;
        }
        
        .summary-card {
            transition: all 0.3s ease-in-out;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
        }
        
        /* Chart container enhancements */
        .chart-container {
            position: relative;
            overflow: hidden;
        }
        
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        
        .chart-container:hover::before {
            left: 100%;
        }
        
        /* Enhanced fraud table styling */
        .fraud-row {
            transition: all 0.2s ease-in-out;
        }
        
        .fraud-row:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* Professional fraud source filter styling */
        #fraud-source-app-filter {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        #fraud-source-app-filter:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        #fraud-source-app-filter:focus {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 2px rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        
        #fraud-source-app-filter option {
            padding: 12px 16px;
            font-weight: 600;
            color: #1f2937;
            background-color: white;
            border: none;
            margin: 2px 0;
        }
        
        #fraud-source-app-filter option:hover {
            background-color: #f8fafc;
            color: #4f46e5;
        }
        
        /* Enhanced fraud header layout */
        .fraud-header-controls {
            transition: all 0.3s ease-in-out;
        }
        
        @media (max-width: 1024px) {
            .fraud-header-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }
        
        /* Improved button styling for fraud actions */
        #run-fraud-10d-btn, #run-fraud-source-10d-btn {
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.1), 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        #run-fraud-10d-btn:hover, #run-fraud-source-10d-btn:hover {
            box-shadow: 0 12px 35px rgba(255, 255, 255, 0.15), 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        /* Enhanced fraud source cards layout */
        .fraud-source-card {
            transition: all 0.2s ease-in-out;
        }
        
        .fraud-source-card:hover {
            transform: translateY(-2px);
        }
        
        /* Responsive fraud metrics grid */
        @media (max-width: 768px) {
            .fraud-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .fraud-metrics-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
        
        /* Enhanced chart container improvements */
        .fraud-chart-container {
            min-height: 400px;
            max-height: 500px;
        }
        
        @media (max-width: 1024px) {
            .fraud-chart-container {
                min-height: 350px;
                max-height: 450px;
            }
        }
        
        @media (max-width: 768px) {
            .fraud-chart-container {
                min-height: 300px;
                max-height: 400px;
            }
        }
        
        @media (max-width: 480px) {
            .fraud-chart-container {
                min-height: 250px;
                max-height: 350px;
            }
        }
        
        /* Improved chart canvas styling */
        .fraud-source-chart {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border-radius: 0.75rem;
        }
        
        /* Source header improvements */
        .fraud-source-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        /* Responsive fraud source header */
        @media (max-width: 768px) {
            .fraud-source-header .flex {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .fraud-source-header .space-x-3 {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .fraud-source-header h3 {
                font-size: 1rem;
            }
            
            .fraud-source-header .bg-red-100 {
                font-size: 0.75rem;
                padding: 0.25rem 0.75rem;
            }
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 640px) {
            /* Responsive header */
            .main-header {
                padding: 1.5rem 1rem;
            }
            
            /* Responsive navigation */
            .nav-container {
                padding: 0.5rem;
            }
            
            /* Responsive card grids */
            .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: repeat(1, 1fr);
                gap: 1rem;
            }
            
            .grid.grid-cols-1.lg\:grid-cols-3 {
                grid-template-columns: repeat(1, 1fr);
                gap: 1rem;
            }
            
            /* Responsive text sizes */
            .text-4xl {
                font-size: 1.875rem;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            .text-2xl {
                font-size: 1.25rem;
            }
            
            /* Responsive chart containers */
            .h-56 {
                height: 12rem;
            }
            
            .h-64 {
                height: 14rem;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 475px) {
            /* Show tab text on very small screens */
            .nav-tab span {
                display: inline !important;
                font-size: 0.7rem;
            }
            
            .nav-tab {
                padding: 0.5rem 0.75rem;
            }
            
            .nav-tab svg {
                width: 1rem;
                height: 1rem;
            }
            
            /* Responsive padding for mobile */
            .px-4.sm\:px-6.lg\:px-8.xl\:px-20 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Mobile header adjustments */
            .header-title {
                font-size: 1.25rem;
            }
            
            /* Mobile card adjustments */
            .rounded-2xl, .rounded-3xl {
                border-radius: 1rem;
            }
            
            /* Mobile button adjustments */
            .header-button {
                padding: 0.5rem;
            }
            
            /* Mobile container adjustments */
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }
        
        /* Loading animation improvements */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Enhanced Header Styles */
        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-title {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .profile-button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .profile-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.1);
        }
        
        .logout-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .logout-button:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        /* Enhanced Navigation Tabs */
        .nav-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tab {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .nav-tab:hover::before {
            left: 100%;
        }
        
        .nav-tab:hover {
            color: #6366f1;
            transform: translateY(-1px);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .nav-tab.active:hover {
            background: linear-gradient(135deg, #5b5bd6 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }
        
        .nav-icon {
            transition: all 0.3s ease;
        }
        
        .nav-tab:hover .nav-icon {
            transform: scale(1.1);
        }
        
        .nav-tab.active .nav-icon {
            transform: scale(1.05);
        }
        .apps-row:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .apps-row.selected {
            background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%);
            border-left: 4px solid #6366f1;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-active {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }
        .status-inactive {
            background: linear-gradient(135deg, #fed7d7 0%, #fbb6ce 100%);
            color: #7f1d1d;
        }
        .event-input {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
        }
        .event-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: #ffffff;
        }
        .event-input.configured {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #ffffff 100%);
        }
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .hover-lift {
            transition: all 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .action-button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            color: #4a5568;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
        }
        .search-highlight {
            background: linear-gradient(135deg, #fef9c3 0%, #fde047 100%);
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            font-weight: 600;
        }
        .stats-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
    <div class="min-h-screen">
        <div class="container mx-auto px-4 py-6">
            <!-- Enhanced Header -->
            <div class="main-header rounded-3xl shadow-2xl p-6 mb-8 relative overflow-hidden">
                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute inset-0 bg-gradient-to-r from-white via-transparent to-white transform -skew-y-1"></div>
                </div>
                
                <div class="relative flex flex-col lg:flex-row justify-between items-center">
                    <!-- Logo and Title Section -->
                    <div class="flex items-center space-x-4 mb-4 lg:mb-0">
                        <div class="w-14 h-14 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center backdrop-blur-sm border border-white border-opacity-30">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div class="flex items-center space-x-3">
                        <div>
                                <h1 class="header-title text-2xl sm:text-3xl lg:text-4xl font-black tracking-tight">AppsFlyer Dashboard</h1>
                                <p class="text-blue-100 text-xs sm:text-sm font-medium mt-1">Performance Analytics & Fraud Protection</p>
                            </div>
                            
                            <!-- Compact Stamp Design -->
                            <div class="relative hidden sm:block">
                                <!-- Subtle Glow Effect -->
                                <div class="absolute inset-0 bg-gradient-to-br from-cyan-300 via-blue-300 to-purple-400 rounded-lg blur-sm opacity-60"></div>
                                
                                <!-- Main Stamp -->
                                <div class="relative bg-gradient-to-br from-cyan-200 via-blue-200 to-purple-300 rounded-lg px-2 py-1 sm:px-3 sm:py-2 border-2 border-dashed border-white/80 shadow-lg transform rotate-2 hover:rotate-3 transition-all duration-200 hover:scale-105">
                                    <!-- Inner Border -->
                                    <div class="absolute inset-1 border border-dashed border-white/60 rounded-sm"></div>
                                    
                                    <!-- Stamp Content -->
                                    <div class="relative text-center">
                                        <!-- Top Text -->
                                        <div class="text-blue-800 text-xs font-bold uppercase tracking-wide">
                                            LAST 10 DAYS
                                        </div>
                                        
                                        <!-- Bottom Badge -->
                                        <div class="text-purple-700 text-xs font-black mt-0.5">
                                            ðŸ“Š LIVE
                                        </div>
                                    </div>
                                    
                                    <!-- Small Authenticity Dot -->
                                    <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-white rounded-full border border-blue-400 flex items-center justify-center">
                                        <div class="w-1 h-1 bg-blue-500 rounded-full"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Actions -->
                    <div class="flex items-center space-x-3">
                        <!-- User Info -->
                        <div class="hidden sm:block text-right mr-4">
                            <p class="text-white text-sm font-medium">Welcome back!</p>
                            <p class="text-blue-100 text-xs">Last login: Today</p>
                        </div>
                        
                        <!-- Profile Button -->
                        <button onclick="switchTab('profile')" class="header-button profile-button px-3 py-2 sm:px-4 sm:py-3 lg:px-6 lg:py-3 rounded-2xl font-bold flex items-center space-x-1 sm:space-x-2 group">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <span class="hidden sm:inline">Profile</span>
                        </button>
                        
                        <!-- Logout Button -->
                        <button onclick="logout()" class="header-button logout-button px-3 py-2 sm:px-4 sm:py-3 lg:px-6 lg:py-3 rounded-2xl font-bold flex items-center space-x-1 sm:space-x-2 group">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Navigation Tabs -->
            <div class="nav-container rounded-3xl shadow-xl mb-8 p-2 relative overflow-hidden">
                <!-- Background Glow Effect -->
                <div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 opacity-5 blur-xl"></div>
                
                <div class="relative flex flex-wrap justify-center lg:justify-start space-x-1">
                    <button class="nav-tab tab-button active px-3 py-3 sm:px-4 sm:py-4 lg:px-6 lg:py-4 rounded-2xl font-bold text-xs sm:text-sm flex items-center space-x-1 sm:space-x-2 min-w-0" onclick="switchTab('overview')">
                        <svg class="nav-icon w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        <span class="hidden sm:inline">Overview</span>
                    </button>
                    <button class="nav-tab tab-button px-3 py-3 sm:px-4 sm:py-4 lg:px-6 lg:py-4 rounded-2xl font-bold text-xs sm:text-sm flex items-center space-x-1 sm:space-x-2 min-w-0" onclick="switchTab('apps')">
                        <svg class="nav-icon w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                        <span class="hidden sm:inline">Apps</span>
                    </button>
                    <button class="nav-tab tab-button px-3 py-3 sm:px-4 sm:py-4 lg:px-6 lg:py-4 rounded-2xl font-bold text-xs sm:text-sm flex items-center space-x-1 sm:space-x-2 min-w-0" onclick="switchTab('stats')">
                        <svg class="nav-icon w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="hidden sm:inline">Stats</span>
                    </button>
                    <button class="nav-tab tab-button px-3 py-3 sm:px-4 sm:py-4 lg:px-6 lg:py-4 rounded-2xl font-bold text-xs sm:text-sm flex items-center space-x-1 sm:space-x-2 min-w-0" onclick="switchTab('fraud')">
                        <svg class="nav-icon w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        <span class="hidden sm:inline">Fraud</span>
                    </button>
                    <button class="nav-tab tab-button px-3 py-3 sm:px-4 sm:py-4 lg:px-6 lg:py-4 rounded-2xl font-bold text-xs sm:text-sm flex items-center space-x-1 sm:space-x-2 min-w-0" onclick="switchTab('profile')">
                        <svg class="nav-icon w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span class="hidden sm:inline">Profile</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Overview Tab Content -->
        <div id="overview-tab" class="tab-content active px-4 sm:px-6 lg:px-8 xl:px-20">
            <!-- Performance Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-purple-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Total Impressions</h3>
                            <p id="overview-total-impressions" class="text-3xl font-bold text-purple-600 mt-1">0</p>
                            </div>
                        <div class="bg-purple-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            </div>
                        </div>
                    </div>
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-emerald-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Total Clicks</h3>
                            <p id="overview-total-clicks" class="text-3xl font-bold text-emerald-600 mt-1">0</p>
                </div>
                        <div class="bg-emerald-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-amber-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Total Installs</h3>
                            <p id="overview-total-installs" class="text-3xl font-bold text-amber-600 mt-1">0</p>
                        </div>
                        <div class="bg-amber-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-rose-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Conversion Rate</h3>
                            <p id="overview-conversion-rate" class="text-3xl font-bold text-rose-600 mt-1">0%</p>
                        </div>
                        <div class="bg-rose-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-8">
                <!-- Performance Trends Card -->
                <div class="bg-white rounded-3xl shadow-2xl p-6 border border-gray-100">
                    <!-- Hidden element for JavaScript updates -->
                    <span id="overview-last-updated" class="hidden"></span>
                    <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-6 shadow-inner border border-gray-100">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Impressions Chart -->
                            <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow duration-300 border border-purple-100">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-purple-700 flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                        Impressions
                                    </h3>
                                    <div class="bg-purple-100 rounded-full px-3 py-1">
                                        <span class="text-xs font-bold text-purple-700">10 Days</span>
                                    </div>
                                </div>
                                <div class="h-56 flex items-center justify-center relative">
                                    <canvas id="impressionsChart" height="200" class="w-full"></canvas>
                                    <div id="impressions-loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-lg" style="display: none;">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                                            <span class="text-sm text-purple-600 font-medium">Loading data...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Clicks Chart -->
                            <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow duration-300 border border-emerald-100">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-emerald-700 flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                                        </svg>
                                        Clicks
                                    </h3>
                                    <div class="bg-emerald-100 rounded-full px-3 py-1">
                                        <span class="text-xs font-bold text-emerald-700">10 Days</span>
                                    </div>
                                </div>
                                <div class="h-56 flex items-center justify-center relative">
                                    <canvas id="clicksChart" height="200" class="w-full"></canvas>
                                    <div id="clicks-loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-lg" style="display: none;">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-8 h-8 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin"></div>
                                            <span class="text-sm text-emerald-600 font-medium">Loading data...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Installs Chart -->
                            <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow duration-300 border border-amber-100">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-amber-700 flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                                        </svg>
                                        Installs
                                    </h3>
                                    <div class="bg-amber-100 rounded-full px-3 py-1">
                                        <span class="text-xs font-bold text-amber-700">10 Days</span>
                                    </div>
                                </div>
                                <div class="h-56 flex items-center justify-center relative">
                                    <canvas id="installsChart" height="200" class="w-full"></canvas>
                                    <div id="installs-loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-lg" style="display: none;">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-8 h-8 border-4 border-amber-200 border-t-amber-600 rounded-full animate-spin"></div>
                                            <span class="text-sm text-amber-600 font-medium">Loading data...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <div class="inline-flex items-center gap-2 bg-blue-50 rounded-full px-4 py-2 border border-blue-200">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="text-sm text-blue-700 font-medium">Data reflects the last run of the <strong>Last 10 Days</strong> report on the Stats page</span>
                        </div>
                    </div>
                </div>

                <!-- Fraud Protection Card -->
                <div class="bg-white rounded-3xl shadow-2xl p-6 border border-gray-100">
                    <!-- Hidden element for JavaScript updates -->
                    <span id="fraud-last-updated" class="hidden"></span>
                    <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl p-6 border border-red-100">
                        <div class="mb-4">
                            <h4 class="text-lg font-bold text-red-700 mb-2 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                                Top Fraudulent Sources
                            </h4>
                            <p class="text-sm text-red-600 mb-4">Suspicious traffic sources identified by our fraud protection system</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-inner">
                        <div id="bad-sources-list"></div>
                            <div id="bad-sources-empty" class="text-center py-8" style="display:none;">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
                                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                    </div>
                                    <div class="text-center">
                                        <h4 class="text-lg font-bold text-green-700 mb-1">All Clear! ðŸŽ‰</h4>
                                        <p class="text-sm text-green-600">No suspicious sources detected</p>
                                        <p class="text-xs text-gray-500 mt-2">Run the 'Fraud Per Source' report to get latest data</p>
                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Performing Apps Card -->
                <div class="bg-white rounded-3xl shadow-2xl p-6 border border-gray-100">
                    <!-- Hidden element for JavaScript updates -->
                    <span id="top-apps-last-updated" class="hidden"></span>
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl p-6 border border-yellow-100">
                        <div class="mb-4">
                            <h4 class="text-lg font-bold text-yellow-700 mb-2 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                Event Performance Leaders
                            </h4>
                            <p class="text-sm text-yellow-600 mb-4">Apps ranked by total event conversions over the last 10 days</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-inner overflow-hidden">
                    <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gradient-to-r from-yellow-100 to-orange-100 border-b border-yellow-200">
                                        <tr>
                                            <th class="px-6 py-4 text-left text-sm font-bold text-yellow-800 uppercase tracking-wider">
                                                <div class="flex items-center gap-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                    </svg>
                                                    App Name
                                                </div>
                                            </th>
                                            <th class="px-6 py-4 text-center text-sm font-bold text-yellow-800 uppercase tracking-wider" id="event1-header">
                                                <div class="flex items-center justify-center gap-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                    </svg>
                                                    Event 1
                                                </div>
                                            </th>
                                            <th class="px-6 py-4 text-center text-sm font-bold text-yellow-800 uppercase tracking-wider" id="event2-header">
                                                <div class="flex items-center justify-center gap-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                    </svg>
                                                    Event 2
                                                </div>
                                            </th>
                                            <th class="px-6 py-4 text-center text-sm font-bold text-yellow-800 uppercase tracking-wider">
                                                <div class="flex items-center justify-center gap-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                    </svg>
                                                    Total Events
                                                </div>
                                            </th>
                                    </tr>
                                </thead>
                                    <tbody id="top-apps-list" class="bg-white divide-y divide-gray-100">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Export Overview Data Button -->
                <div class="flex justify-center mt-8">
                    <button id="export-overview-btn" onclick="exportOverviewData()" class="bg-green-50 hover:bg-green-100 border border-green-200 text-green-600 px-8 py-4 rounded-2xl text-base font-semibold transition duration-200 flex items-center space-x-3 hover:border-green-300 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Export Overview Data</span>
                    </button>
                </div>

            </div>
        </div>

        <!-- Apps Tab Content -->
        <div id="apps-tab" class="tab-content px-4 sm:px-6 lg:px-8 xl:px-20">
            <!-- Enhanced Header with Gradient Background -->
            <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 rounded-3xl shadow-2xl p-6 mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
                    <div class="text-white">
                        <h2 class="text-4xl font-extrabold mb-2 bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">
                            ðŸš€ AppsFlyer Applications
                        </h2>
                        <p class="text-blue-100 text-lg font-medium">Manage your mobile app portfolio with ease</p>
                        <div class="text-blue-200 text-sm font-normal mt-2" id="apps-last-updated"></div>
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <button id="get-apps-btn" onclick="fetchApps()" 
                                class="bg-white text-indigo-600 hover:bg-blue-50 px-8 py-3 rounded-2xl flex items-center shadow-xl transition-all duration-300 transform hover:scale-105 font-bold">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            <span>Sync Apps</span>
                            <div class="loading-spinner ml-2"></div>
                        </button>
                        <button id="get-events-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-3 rounded-2xl flex items-center shadow-xl transition-all duration-300 transform hover:scale-105 font-bold">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <span>Get Events</span>
                            <div id="get-events-spinner" class="loading-spinner ml-2" style="display:none;"></div>
                            <span id="get-events-timer" class="ml-2 text-xs text-emerald-200"></span>
                        </button>
                    </div>
                </div>
                </div>

            <!-- Enhanced Progress Bar -->
            <div class="progress-bar mb-6 bg-gray-200 rounded-full h-2 overflow-hidden shadow-inner">
                <div class="progress-bar-fill bg-gradient-to-r from-indigo-500 to-purple-500 h-full rounded-full transition-all duration-500 ease-out"></div>
                </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-indigo-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Total Apps</h3>
                            <p id="app-count" class="text-3xl font-bold text-indigo-600 mt-1">0</p>
                        </div>
                        <div class="bg-indigo-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-emerald-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Active Apps</h3>
                            <p id="active-app-count" class="text-3xl font-bold text-emerald-600 mt-1">0</p>
                        </div>
                        <div class="bg-emerald-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-amber-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">With Events</h3>
                            <p id="configured-app-count" class="text-3xl font-bold text-amber-600 mt-1">0</p>
                        </div>
                        <div class="bg-amber-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 border-rose-500 hover:shadow-2xl transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Last Sync</h3>
                            <p id="last-sync-time" class="text-lg font-bold text-rose-600 mt-1">Never</p>
                        </div>
                        <div class="bg-rose-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Apps Sync Loading State (visible to all users) -->
            <div id="apps-sync-loading-state" class="mb-8" style="display: none;">
                <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 rounded-3xl shadow-2xl p-8 border-2 border-blue-100 relative overflow-hidden">
                    <!-- Animated background pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 transform -skew-y-1"></div>
                    </div>
                    
                    <!-- Content -->
                    <div class="relative z-10 text-center">
                        <!-- Hourglass Animation -->
                        <div class="mb-6">
                            <div class="relative inline-block">
                                <!-- Hourglass SVG with animation -->
                                <div class="w-20 h-20 mx-auto mb-4 relative">
                                    <svg class="w-full h-full animate-spin" style="animation-duration: 2s;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 2v6h.01L6 8.01 10.99 13 6 17.99V18H6v4h12v-4h-.01L18 17.99 13.01 13 18 8.01V8h.01L18 2H6z" stroke="url(#gradient-sync)" stroke-width="2" fill="none"/>
                                        <defs>
                                            <linearGradient id="gradient-sync" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#3B82F6"/>
                                                <stop offset="50%" style="stop-color:#8B5CF6"/>
                                                <stop offset="100%" style="stop-color:#EC4899"/>
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                    <!-- Sand particles animation -->
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="w-2 h-2 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                                        <div class="w-1 h-1 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full animate-bounce ml-1" style="animation-delay: 0.2s;"></div>
                                        <div class="w-1 h-1 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full animate-bounce ml-1" style="animation-delay: 0.4s;"></div>
                                    </div>
                                </div>
                                
                                <!-- Pulsing ring -->
                                <div class="absolute inset-0 rounded-full border-4 border-blue-200 animate-ping"></div>
                            </div>
                        </div>
                        
                        <!-- Loading Text -->
                        <div class="mb-6">
                            <h3 class="text-3xl font-bold text-gray-800 mb-2">
                                <span id="loading-text">ðŸ”„ Syncing Your Apps Now</span>
                            </h3>
                            <p class="text-gray-600 text-lg">Please wait while we fetch your data from AppsFlyer...</p>
                            <div class="mt-2 text-sm text-blue-600 font-medium">
                                <span id="sync-message">Establishing connection with AppsFlyer...</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mb-6 max-w-md mx-auto">
                            <div class="bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                                <div id="sync-progress-bar" class="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-full transition-all duration-1000 ease-out shadow-lg" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-500 mt-2">
                                <span id="sync-status-text">Connecting to AppsFlyer...</span>
                                <span id="sync-progress-text">0%</span>
                            </div>
                        </div>
                        
                        <!-- Timer and Status -->
                        <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-6 mb-4">
                            <!-- Timer -->
                            <div class="inline-flex items-center space-x-2 bg-blue-100 rounded-full px-4 py-2 shadow-md">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-blue-700 font-medium">Time elapsed: <span id="sync-timer">00:00</span></span>
                            </div>
                            
                            <!-- Status Badge -->
                            <div class="inline-flex items-center space-x-2 bg-green-100 rounded-full px-4 py-2 shadow-md">
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-green-700 font-medium">System Active</span>
                            </div>
                        </div>
                        
                        <!-- Info Message -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                            <div class="text-blue-800 font-medium mb-1">ðŸ“± For All Users</div>
                            <div class="text-blue-700 text-sm">
                                Apps are currently being synced from AppsFlyer. This process is visible to all users and will complete automatically.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Search and Filter Section -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
                <div class="flex flex-col lg:flex-row items-start lg:items-center space-y-4 lg:space-y-0 lg:space-x-4">
                    <div class="flex-1 relative">
                        <input type="text" id="search-apps" placeholder="Search apps by name or ID..." 
                               class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-gray-50 hover:bg-white transition-all duration-300">
                        <svg class="absolute left-4 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="status-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 hover:bg-white transition-all duration-300">
                            <option value="">All Status</option>
                            <option value="active">Active Only</option>
                            <option value="inactive">Inactive Only</option>
                        </select>
                        <button id="toggle-view-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-xl flex items-center transition-all duration-300">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                            </svg>
                            <span>Table View</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Apps Table -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-indigo-50 to-purple-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                                        </svg>
                                        <span>App ID</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                        </svg>
                                        <span>App Name</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span>Status</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                        <span>Event 1</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                        <span>Event 2</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <div class="flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                                        </svg>
                                        <span>Actions</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="apps-list" class="bg-white divide-y divide-gray-200">
                            <!-- Apps will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="apps-empty-state" class="hidden text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No apps found</h3>
                    <p class="text-gray-500 mb-4">Get started by syncing your apps from AppsFlyer</p>
                    <button onclick="fetchApps()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300">
                        Sync Apps Now
                    </button>
                </div>
                </div>

            <!-- Enhanced Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-between items-center mt-8 space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-4">
                    <button id="select-all-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-300">
                        Select All
                    </button>
                    <button id="bulk-activate-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300">
                        Bulk Activate
                    </button>
                </div>
                <button id="save-all-events-btn" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-12 py-4 rounded-2xl text-lg font-bold shadow-xl transition-all duration-300 transform hover:scale-105">
                    ðŸ’¾ SAVE ALL CHANGES
                </button>
            </div>

            <!-- Enhanced Footer -->
            <div class="flex flex-col sm:flex-row justify-between items-center mt-8 pt-6 border-t border-gray-200 space-y-4 sm:space-y-0">
                <div class="text-sm text-gray-500">
                    <span>Last updated: </span>
                    <span id="apps-timestamp" class="font-medium">Never</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="export-apps-btn" onclick="exportAppsData()" class="bg-green-50 hover:bg-green-100 border border-green-200 text-green-600 px-6 py-3 rounded-xl text-sm font-semibold transition duration-200 flex items-center space-x-2 hover:border-green-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Export Apps</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Tab Content -->
        <div id="stats-tab" class="tab-content px-4 sm:px-6 lg:px-8 xl:px-20">
                        <div class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 rounded-3xl shadow-2xl border border-indigo-100 overflow-hidden">
                <!-- Enhanced Title Header -->
                <div class="bg-gradient-to-r from-indigo-600 via-indigo-700 to-purple-700 px-12 py-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                        <!-- Left: Title & Badge -->
                        <div class="flex items-center space-x-6 mb-6 lg:mb-0">
                            <div class="bg-white/20 backdrop-blur-sm p-4 rounded-2xl border border-white/30">
                                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                </div>
                            <div>
                                <h1 class="text-4xl lg:text-5xl font-bold text-white mb-2">Stats Analytics</h1>
                                                                <div class="flex items-center space-x-3">

                                    <button id="run-report-10d-btn" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-5 py-2 rounded-full font-bold text-sm shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 border border-orange-400/50 backdrop-blur-sm flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        <span>Generate Report</span>
                                    </button>
                </div>
                </div>
                        </div>
                        
                        <!-- Right: Search & Controls -->
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <div class="relative">
                                <input type="text" id="app-search-filter" placeholder="Search campaigns..." 
                                       class="w-full sm:w-72 pl-12 pr-4 py-3 border border-white/30 rounded-xl bg-white/90 backdrop-blur-sm text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-white/50 text-sm font-medium">
                                                                  <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                      <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="bg-white/20 backdrop-blur-sm border border-white/30 px-4 py-3 rounded-xl">
                                <div class="flex items-center space-x-2 text-white">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <span id="app-count-display" class="font-semibold text-sm">0 campaigns</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Content Area -->
                <div class="p-6">

                <!-- Stats Report Loading State (visible to all users) -->
                <div id="stats-report-loading-state" class="mb-8" style="display: none;">
                    <div class="bg-gradient-to-br from-orange-50 via-red-50 to-pink-50 rounded-3xl shadow-2xl p-8 border-2 border-orange-100 relative overflow-hidden">
                        <!-- Animated background pattern -->
                        <div class="absolute inset-0 opacity-10">
                            <div class="absolute inset-0 bg-gradient-to-r from-orange-400 via-red-500 to-pink-500 transform -skew-y-1"></div>
                        </div>
                        
                        <!-- Content -->
                        <div class="relative z-10 text-center">
                            <!-- Analytics Icon Animation -->
                            <div class="mb-6">
                                <div class="relative inline-block">
                                    <!-- Chart/Analytics SVG with animation -->
                                    <div class="w-20 h-20 mx-auto mb-4 relative">
                                        <svg class="w-full h-full animate-pulse" style="animation-duration: 1.5s;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="url(#gradient-stats)" stroke-width="2.5" fill="none"/>
                                            <defs>
                                                <linearGradient id="gradient-stats" x1="0%" y1="0%" x2="100%" y2="100%">
                                                    <stop offset="0%" style="stop-color:#F97316"/>
                                                    <stop offset="50%" style="stop-color:#EF4444"/>
                                                    <stop offset="100%" style="stop-color:#EC4899"/>
                                                </linearGradient>
                                            </defs>
                                        </svg>
                                        <!-- Data flow animation -->
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-gradient-to-br from-orange-400 to-red-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                                            <div class="w-1 h-1 bg-gradient-to-br from-red-400 to-pink-500 rounded-full animate-bounce ml-1" style="animation-delay: 0.3s;"></div>
                                            <div class="w-1 h-1 bg-gradient-to-br from-pink-400 to-red-500 rounded-full animate-bounce ml-1" style="animation-delay: 0.6s;"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Pulsing ring -->
                                    <div class="absolute inset-0 rounded-full border-4 border-orange-200 animate-ping"></div>
                                </div>
                            </div>
                            
                            <!-- Loading Text -->
                            <div class="mb-6">
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">
                                    <span id="stats-loading-text">ðŸ“Š Generating Your Report</span>
                                </h3>
                                <p class="text-gray-600 text-lg">Please wait while we analyze your app performance data...</p>
                                <div class="mt-2 text-sm text-orange-600 font-medium">
                                    <span id="stats-sync-message">Initializing report generation...</span>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-6 max-w-md mx-auto">
                                <div class="bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                                    <div id="stats-sync-progress-bar" class="h-full bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 rounded-full transition-all duration-1000 ease-out shadow-lg" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-sm text-gray-500 mt-2">
                                    <span id="stats-sync-status-text">Preparing report generation...</span>
                                    <span id="stats-sync-progress-text">0%</span>
                                </div>
                            </div>
                            
                            <!-- Timer and Status -->
                            <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-6 mb-4">
                                <!-- Timer -->
                                <div class="inline-flex items-center space-x-2 bg-orange-100 rounded-full px-4 py-2 shadow-md">
                                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-orange-700 font-medium">Time elapsed: <span id="stats-sync-timer">00:00</span></span>
                                </div>
                                
                                <!-- Status Badge -->
                                <div class="inline-flex items-center space-x-2 bg-green-100 rounded-full px-4 py-2 shadow-md">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-green-700 font-medium">System Processing</span>
                                </div>
                            </div>
                            
                            <!-- Info Message -->
                            <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                                <div class="text-orange-800 font-medium mb-1">ðŸ“ˆ For All Users</div>
                                <div class="text-orange-700 text-sm">
                                    Analytics report is being generated. This process is visible to all users and will complete automatically.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Stats Content -->
                <div id="stats-content-10d" class="stats-range-content">
                    <div id="stats-data-10d" class="space-y-8"></div>
                </div>
                <div id="stats-loading" class="text-center py-16" style="display:none;">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-green-600 mb-4"></div>
                    <div class="text-gray-600 text-lg font-semibold">Loading analytics data...</div>
                    <div class="text-gray-500 text-sm mt-2">This may take a few moments</div>
                </div>
                <div id="stats-error" class="text-center py-16" style="display:none;">
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-8 max-w-md mx-auto">
                        <div class="text-red-600 text-lg font-semibold mb-2">âš ï¸ Error loading data</div>
                        <div class="text-red-500 text-sm">Please try again or contact support if the issue persists.</div>
                    </div>
                </div>
                <div class="flex justify-center space-x-4 mt-10">
                    <button id="export-stats-btn" onclick="exportStatsData()" class="bg-green-50 hover:bg-green-100 border border-green-200 text-green-600 px-6 py-3 rounded-xl text-sm font-semibold transition duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Export Stats</span>
                    </button>
                    <button id="clear-stats-cache-btn" class="bg-red-50 hover:bg-red-100 border border-red-200 text-red-600 px-6 py-3 rounded-xl text-sm font-semibold transition duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span>Clear Cache</span>
                    </button>
                </div>
                </div>
            </div>
        </div>

        <!-- Fraud Tab Content -->
        <div id="fraud-tab" class="tab-content px-4 sm:px-6 lg:px-8 xl:px-20">
                        <div class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 rounded-3xl shadow-2xl border border-indigo-100 overflow-hidden">
                <!-- Comprehensive Fraud Header -->
                                <div class="bg-gradient-to-r from-indigo-600 via-blue-700 to-purple-700 px-12 py-8">
                    <div class="flex flex-col xl:flex-row xl:items-center xl:justify-between space-y-6 xl:space-y-0">
                        <!-- Left: Title, Period & Action Button -->
                        <div class="flex flex-col lg:flex-row lg:items-center lg:space-x-8 space-y-4 lg:space-y-0">
                            <!-- Title Section -->
                            <div class="flex items-center space-x-6">
                                <div class="bg-white/20 backdrop-blur-sm p-4 rounded-2xl border border-white/30">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                </div>
                                <div>
                                    <h1 class="text-4xl lg:text-5xl font-bold text-white mb-3">Fraud Protection</h1>

                    </div>
                    </div>
                            
                            <!-- Action Controls (context-aware) -->
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                                <!-- Analytics Controls (shown only on Analytics tab) -->
                                <div id="fraud-analytics-controls" class="flex space-x-3">
                                    <button id="run-fraud-10d-btn" class="bg-white/20 hover:bg-white/30 text-white px-8 py-4 rounded-2xl font-bold text-base shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-white/30 backdrop-blur-sm flex items-center space-x-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                        </svg>
                                        <span>Generate Report</span>
                                    </button>
                                    <button id="force-refresh-fraud-btn" class="bg-red-500/20 hover:bg-red-500/30 text-white px-6 py-4 rounded-2xl font-bold text-base shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-red-400/30 backdrop-blur-sm flex items-center space-x-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Force Refresh</span>
                                    </button>
                </div>
                                                        
                                <!-- Per Source Controls (shown only on Per Source tab) -->
                                <div id="fraud-source-controls" class="flex flex-col lg:flex-row items-stretch lg:items-center space-y-3 lg:space-y-0 lg:space-x-4" style="display:none;">
                                    <!-- Professional Campaign Filter -->
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
                                            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                    </div>
                                        <select id="fraud-source-app-filter" class="w-80 lg:w-96 pl-12 pr-4 py-4 border-2 border-white/60 rounded-2xl bg-white/98 backdrop-blur-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-white/80 focus:border-white/80 focus:bg-white text-sm font-semibold shadow-2xl hover:bg-white hover:shadow-3xl transition-all duration-300 cursor-pointer appearance-none">
                                            <option value="" style="color: #1f2937; background-color: white; font-weight: 600; padding: 8px 12px;">ðŸŽ¯ Choose a campaign to analyze sources</option>
                                        </select>
                                        <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                        </div>
                        </div>
                                    
                                    <!-- Analyze Sources Button -->
                                    <button id="run-fraud-source-10d-btn" class="bg-white/20 hover:bg-white/30 text-white px-8 py-4 rounded-2xl font-bold text-base shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-white/30 backdrop-blur-sm flex items-center space-x-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Refresh View</span>
                                    </button>
                    </div>
                        </div>
                        </div>
                                                
                        <!-- Right: Sub-tab Navigation -->
                        <div class="flex space-x-3">
                            <button id="fraud-analytics-tab-btn" class="bg-white/20 backdrop-blur-sm text-white px-6 py-3 rounded-xl font-semibold text-sm border border-white/30 hover:bg-white/30 transition-all duration-200 flex items-center space-x-2" onclick="switchFraudSubTab('analytics')">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <span>Analytics</span>
                            </button>
                            <button id="fraud-source-tab-btn" class="bg-white/10 backdrop-blur-sm text-white/70 px-6 py-3 rounded-xl font-semibold text-sm border border-white/20 hover:bg-white/20 hover:text-white transition-all duration-200 flex items-center space-x-2" onclick="switchFraudSubTab('source')">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                <span>Per Source</span>
                            </button>
                    </div>
                        </div>
                        </div>
                
                <!-- Content Area -->
                <div class="p-6">

                <!-- Fraud Report Loading State (visible to all users) -->
                <div id="fraud-report-loading-state" class="mb-8" style="display: none;">
                    <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 rounded-3xl shadow-2xl p-8 border-2 border-indigo-100 relative overflow-hidden">
                        <!-- Animated background pattern -->
                        <div class="absolute inset-0 opacity-10">
                            <div class="absolute inset-0 bg-gradient-to-r from-indigo-400 via-purple-500 to-blue-500 transform -skew-y-1"></div>
                        </div>
                        
                        <!-- Content -->
                        <div class="relative z-10 text-center">
                            <!-- Security Shield Animation -->
                            <div class="mb-6">
                                <div class="relative inline-block">
                                    <!-- Shield/Security SVG with animation -->
                                    <div class="w-20 h-20 mx-auto mb-4 relative">
                                        <svg class="w-full h-full animate-pulse" style="animation-duration: 1.8s;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke="url(#gradient-fraud)" stroke-width="2.5" fill="none"/>
                                            <defs>
                                                <linearGradient id="gradient-fraud" x1="0%" y1="0%" x2="100%" y2="100%">
                                                    <stop offset="0%" style="stop-color:#6366F1"/>
                                                    <stop offset="50%" style="stop-color:#8B5CF6"/>
                                                    <stop offset="100%" style="stop-color:#3B82F6"/>
                                                </linearGradient>
                                            </defs>
                                        </svg>
                                        <!-- Security scan animation -->
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                                            <div class="w-1 h-1 bg-gradient-to-br from-purple-400 to-blue-500 rounded-full animate-bounce ml-1" style="animation-delay: 0.4s;"></div>
                                            <div class="w-1 h-1 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full animate-bounce ml-1" style="animation-delay: 0.8s;"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Pulsing ring -->
                                    <div class="absolute inset-0 rounded-full border-4 border-indigo-200 animate-ping"></div>
                                </div>
                            </div>
                            
                            <!-- Loading Text -->
                            <div class="mb-6">
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">
                                    <span id="fraud-loading-text">ðŸ›¡ï¸ Analyzing Security Threats</span>
                                </h3>
                                <p class="text-gray-600 text-lg">Please wait while we scan for fraudulent activities...</p>
                                <div class="mt-2 text-sm text-indigo-600 font-medium">
                                    <span id="fraud-sync-message">Initializing fraud detection systems...</span>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-6 max-w-md mx-auto">
                                <div class="bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                                    <div id="fraud-sync-progress-bar" class="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-blue-500 rounded-full transition-all duration-1000 ease-out shadow-lg" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-sm text-gray-500 mt-2">
                                    <span id="fraud-sync-status-text">Preparing security analysis...</span>
                                    <span id="fraud-sync-progress-text">0%</span>
                                </div>
                            </div>
                            
                            <!-- Timer and Status -->
                            <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-6 mb-4">
                                <!-- Timer -->
                                <div class="inline-flex items-center space-x-2 bg-indigo-100 rounded-full px-4 py-2 shadow-md">
                                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-indigo-700 font-medium">Time elapsed: <span id="fraud-sync-timer">00:00</span></span>
                                </div>
                                
                                <!-- Status Badge -->
                                <div class="inline-flex items-center space-x-2 bg-green-100 rounded-full px-4 py-2 shadow-md">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-green-700 font-medium">Security Scanning</span>
                                </div>
                            </div>
                            
                            <!-- Info Message -->
                            <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 text-center">
                                <div class="text-indigo-800 font-medium mb-1">ðŸ”’ For All Users</div>
                                <div class="text-indigo-700 text-sm">
                                    Fraud protection analysis is running. This security scan is visible to all users and will complete automatically.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                                    
                                    <!-- Fraud Protection Sub-page -->
                    <div id="fraud-analytics-subtab">
                        
                        <!-- Fraud Protection Content -->
                        <div id="fraud-content-10d" class="fraud-range-content">
                            <div id="fraud-data-10d" class="space-y-8"></div>
                    </div>
                        
                                                <!-- Loading and Error States -->
                        <div id="fraud-loading" class="text-center py-16" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-indigo-600 mb-4"></div>
                            <div class="text-gray-600 text-lg font-semibold">Loading fraud protection...</div>
                            <div class="text-gray-500 text-sm mt-2">Analyzing security data</div>
                        </div>
                        <div id="fraud-error" class="text-center py-16" style="display:none;">
                            <div class="bg-red-50 border border-red-200 rounded-2xl p-8 max-w-md mx-auto">
                                <div class="text-red-600 text-lg font-semibold mb-2">âš ï¸ Error loading data</div>
                                <div class="text-red-500 text-sm">Please try again or contact support if the issue persists.</div>
                        </div>
                    </div>
                    </div>
                    
                                    <!-- Fraud Per Source Sub-page -->
                    <div id="fraud-source-subtab" style="display:none;">
                        
                                                <!-- Fraud Per Source Content -->
                        <div id="fraud-source-content-10d" class="fraud-source-range-content">
                            <div id="fraud-source-loading-10d" class="text-center py-16" style="display:none;">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-indigo-600 mb-4"></div>
                                <div class="text-gray-600 text-lg font-semibold">Analyzing fraud sources...</div>
                                <div class="text-gray-500 text-sm mt-2">Processing security data by source</div>
                    </div>
                            <div id="fraud-source-error-10d" class="text-center py-16" style="display:none;">
                                <div class="bg-red-50 border border-red-200 rounded-2xl p-8 max-w-md mx-auto">
                                    <div class="text-red-600 text-lg font-semibold mb-2">âš ï¸ Error loading data</div>
                                    <div class="text-red-500 text-sm">Please try again or contact support if the issue persists.</div>
                </div>
                </div>
                            <div id="fraud-source-data-10d" class="space-y-8"></div>
                </div>
                        
                        <!-- General Loading States -->
                        <div id="fraud-source-loading" class="text-center py-16" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-indigo-600 mb-4"></div>
                            <div class="text-gray-600 text-lg font-semibold">Loading fraud per source data...</div>
                        </div>
                        <div id="fraud-source-error" class="text-center py-16" style="display:none;">
                            <div class="bg-red-50 border border-red-200 rounded-2xl p-8 max-w-md mx-auto">
                                <div class="text-red-600 text-lg font-semibold mb-2">âš ï¸ Error loading source data</div>
                                <div class="text-red-500 text-sm">Please try again or contact support if the issue persists.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export and Clear Cache Buttons -->
                    <div class="flex justify-center space-x-4 mt-10">
                        <button id="export-fraud-btn" onclick="exportFraudData()" class="bg-green-50 hover:bg-green-100 border border-green-200 text-green-600 px-6 py-3 rounded-xl text-sm font-semibold transition duration-200 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Export Fraud Data</span>
                        </button>
                        <button id="clear-fraud-cache-btn" class="bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-600 px-6 py-3 rounded-xl text-sm font-semibold transition duration-200 flex items-center space-x-2 hover:border-indigo-300 hover:text-indigo-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            <span>Clear Cache</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tab Content -->
        <div id="profile-tab" class="tab-content px-4 sm:px-6 lg:px-8 xl:px-20">
            <!-- Enhanced Profile Container -->
            <div class="min-h-screen bg-gradient-to-br from-gray-100 via-blue-50 to-gray-100 p-6">
                <!-- Lighter Background Elements -->
                <div class="absolute inset-0 overflow-hidden pointer-events-none">
                    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-cyan-200/30 rounded-full blur-3xl animate-pulse"></div>
                    <div class="absolute top-3/4 right-1/4 w-96 h-96 bg-purple-200/30 rounded-full blur-3xl animate-pulse delay-1000"></div>
                    <div class="absolute top-1/2 left-1/2 w-96 h-96 bg-blue-200/30 rounded-full blur-3xl animate-pulse delay-2000"></div>
                </div>
                
                <!-- Profile Header -->
                <div class="relative z-10 max-w-5xl mx-auto">
                    <div class="text-center mb-12">
                        <div class="relative inline-block">
                            <!-- Profile Avatar -->
                            <div class="w-36 h-36 mx-auto mb-8 relative">
                                <div class="w-full h-full bg-gradient-to-br from-cyan-400 via-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-2xl ring-4 ring-cyan-400/50 animate-pulse">
                                    <svg class="w-18 h-18 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                </div>
                                <!-- Status Indicator -->
                                <div class="absolute bottom-2 right-2 w-8 h-8 bg-green-400 rounded-full border-4 border-white flex items-center justify-center shadow-lg">
                                    <div class="w-3 h-3 bg-green-500 rounded-full animate-ping"></div>
                                </div>
                            </div>
                            
                            <!-- Welcome Text -->
                            <h1 class="text-5xl lg:text-6xl font-bold bg-gradient-to-r from-cyan-600 via-blue-600 to-purple-600 bg-clip-text text-transparent mb-4 drop-shadow-lg">
                                User Profile
                            </h1>
                            <p class="text-gray-700 text-xl font-medium">Manage your account settings and preferences</p>
                        </div>
                    </div>
                    
                    <!-- Profile Cards Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        
                        <!-- Agency Account Card -->
                        <div class="group relative">
                            <div class="absolute inset-0 bg-gradient-to-r from-purple-200 to-blue-200 rounded-2xl blur opacity-75 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="relative bg-white/95 backdrop-blur-md border-2 border-purple-300/50 rounded-2xl p-6 hover:bg-white/98 transition-all duration-300 transform hover:scale-105 shadow-2xl">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800">Agency Account</h3>
                                        <p class="text-gray-600 text-base font-medium">Your organization details</p>
                        </div>
                        </div>
                                
                                <div id="agency-display" class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span id="agency-name" class="text-xl font-bold text-gray-800 bg-gray-100 px-4 py-2 rounded-lg border border-gray-300">N/A</span>
                                        <button id="edit-agency-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-5 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center space-x-2 border border-purple-400 shadow-lg hover:shadow-xl">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            <span>Edit</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="agency-edit" class="space-y-4" style="display:none;">
                                    <input id="agency-input" type="text" class="w-full px-4 py-3 bg-gray-50 border-2 border-purple-300 rounded-xl text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium" placeholder="Enter agency name">
                                    <div class="flex space-x-3">
                                        <button id="save-agency-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-3 rounded-xl font-bold transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Save</span>
                                        </button>
                                        <button id="cancel-agency-btn" class="px-4 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-xl font-bold transition-all duration-200">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- API Key Card -->
                        <div class="group relative">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-200 to-cyan-200 rounded-2xl blur opacity-75 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="relative bg-white/95 backdrop-blur-md border-2 border-blue-300/50 rounded-2xl p-6 hover:bg-white/98 transition-all duration-300 transform hover:scale-105 shadow-2xl">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                        </svg>
                    </div>
                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800">API Key</h3>
                                        <p class="text-gray-600 text-base font-medium">Your access credentials</p>
                        </div>
                        </div>
                                
                                <div id="api-key-display" class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span id="api-key" class="font-mono text-sm text-gray-800 bg-gray-100 px-4 py-2 rounded-lg truncate max-w-xs border border-gray-300">N/A</span>
                                        <button id="edit-api-key-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center space-x-2 border border-blue-400 shadow-lg hover:shadow-xl">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            <span>Edit</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="api-key-edit" class="space-y-4" style="display:none;">
                                    <input id="api-key-input" type="text" class="w-full px-4 py-3 bg-gray-50 border-2 border-blue-300 rounded-xl text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm font-medium" placeholder="Enter API key">
                                    <div class="flex space-x-3">
                                        <button id="save-api-key-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-3 rounded-xl font-bold transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Save</span>
                                        </button>
                                        <button id="cancel-api-key-btn" class="px-4 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-xl font-bold transition-all duration-200">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Email Card -->
                        <div class="group relative">
                            <div class="absolute inset-0 bg-gradient-to-r from-emerald-200 to-teal-200 rounded-2xl blur opacity-75 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="relative bg-white/95 backdrop-blur-md border-2 border-emerald-300/50 rounded-2xl p-6 hover:bg-white/98 transition-all duration-300 transform hover:scale-105 shadow-2xl">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                        </svg>
                    </div>
                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800">Email Address</h3>
                                        <p class="text-gray-600 text-base font-medium">Your contact information</p>
                        </div>
                        </div>
                                
                                <div id="user-email-display" class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span id="user-email" class="font-mono text-sm text-gray-800 bg-gray-100 px-4 py-2 rounded-lg border border-gray-300">N/A</span>
                                        <button id="edit-user-email-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center space-x-2 border border-emerald-400 shadow-lg hover:shadow-xl">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            <span>Edit</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="user-email-edit" class="space-y-4" style="display:none;">
                                    <input id="user-email-input" type="email" class="w-full px-4 py-3 bg-gray-50 border-2 border-emerald-300 rounded-xl text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-mono text-sm font-medium" placeholder="Enter email address">
                                    <div class="flex space-x-3">
                                        <button id="save-user-email-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-3 rounded-xl font-bold transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Save</span>
                                        </button>
                                        <button id="cancel-user-email-btn" class="px-4 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-xl font-bold transition-all duration-200">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Password Card -->
                        <div class="group relative">
                            <div class="absolute inset-0 bg-gradient-to-r from-red-200 to-pink-200 rounded-2xl blur opacity-75 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="relative bg-white/95 backdrop-blur-md border-2 border-red-300/50 rounded-2xl p-6 hover:bg-white/98 transition-all duration-300 transform hover:scale-105 shadow-2xl">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                    </div>
                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800">Password</h3>
                                        <p class="text-gray-600 text-base font-medium">Your account security</p>
                        </div>
                        </div>
                                
                                <div id="user-password-display" class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span id="user-password" class="font-mono text-lg text-gray-800 bg-gray-100 px-4 py-2 rounded-lg border border-gray-300">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                                        <button id="edit-user-password-btn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center space-x-2 border border-red-400 shadow-lg hover:shadow-xl">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            <span>Change</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="user-password-edit" class="space-y-4" style="display:none;">
                                    <input id="user-password-input" type="password" class="w-full px-4 py-3 bg-gray-50 border-2 border-red-300 rounded-xl text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 font-mono text-sm font-medium" placeholder="Enter new password">
                                    <div class="flex space-x-3">
                                        <button id="save-user-password-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-3 rounded-xl font-bold transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <span>Save</span>
                                        </button>
                                        <button id="cancel-user-password-btn" class="px-4 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-xl font-bold transition-all duration-200">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Information Section -->
                    <div class="relative">
                        <div class="absolute inset-0 bg-gradient-to-r from-indigo-200 to-purple-200 rounded-2xl blur opacity-75"></div>
                        <div class="relative bg-white/95 backdrop-blur-md border-2 border-indigo-300/50 rounded-2xl p-6 shadow-2xl">
                            <div class="text-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-4">Account Information</h3>
                                <p class="text-gray-600 text-lg mb-8 max-w-2xl mx-auto font-medium">
                                    Your profile contains sensitive information that helps us provide personalized analytics and secure access to your AppsFlyer dashboard. 
                                    Keep your credentials safe and up to date.
                                </p>
                                
                                <!-- Status Indicators -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-8">
                                    <div class="bg-gray-100 rounded-xl p-6 border border-gray-300 hover:bg-gray-200 transition-all duration-200">
                                        <div class="text-emerald-500 font-bold text-sm uppercase tracking-wide">Status</div>
                                        <div class="text-gray-800 font-bold text-xl mt-2">Active</div>
                                    </div>
                                    <div class="bg-gray-100 rounded-xl p-6 border border-gray-300 hover:bg-gray-200 transition-all duration-200">
                                        <div class="text-blue-500 font-bold text-sm uppercase tracking-wide">Plan</div>
                                        <div class="text-gray-800 font-bold text-xl mt-2">Professional</div>
                                    </div>
                                    <div class="bg-gray-100 rounded-xl p-6 border border-gray-300 hover:bg-gray-200 transition-all duration-200">
                                        <div class="text-purple-500 font-bold text-sm uppercase tracking-wide">Region</div>
                                        <div class="text-gray-800 font-bold text-xl mt-2">Global</div>
                                    </div>
                                    <div class="bg-gray-100 rounded-xl p-6 border border-gray-300 hover:bg-gray-200 transition-all duration-200">
                                        <div class="text-orange-500 font-bold text-sm uppercase tracking-wide">Last Login</div>
                                        <div class="text-gray-800 font-bold text-xl mt-2">Today</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Center - Administrative Controls -->
                    <div class="relative mt-12">
                        <div class="bg-gradient-to-br from-white via-gray-50 to-indigo-50 rounded-3xl shadow-2xl p-8 border border-indigo-100 relative overflow-hidden">
                            <!-- Background decoration -->
                            <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 via-transparent to-green-500/5"></div>
                            <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-green-200/20 to-emerald-200/20 rounded-full transform translate-x-32 -translate-y-32"></div>
                            <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-indigo-200/20 to-blue-200/20 rounded-full transform -translate-x-24 translate-y-24"></div>
                            
                            <div class="relative z-10">
                                <div class="text-center mb-8">
                                    <div class="flex justify-center mb-4">
                                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 rounded-2xl shadow-lg">
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                </div>
            </div>
                                    <h3 class="text-3xl font-bold text-gray-900 mb-2">
                                        <span class="bg-gradient-to-r from-indigo-700 to-purple-700 bg-clip-text text-transparent">
                                            âš™ï¸ Action Center
                                        </span>
                                    </h3>
                                    <p class="text-gray-600 mb-8">Administrative controls for your dashboard operations</p>
                                </div>
                                
                                <!-- Get All Stats Section -->
                                <div class="mb-8">
                                    <div class="bg-white rounded-2xl shadow-xl p-6 border border-green-100">
                                        <div class="text-center mb-6">
                                            <button id="get-all-stats-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-10 py-4 rounded-2xl font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-3 mx-auto transform hover:scale-105">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                </svg>
                                                <span class="text-lg">Get All Stats</span>
                                            </button>
                                        </div>
                                        
                                        <!-- Auto-run Status Info -->
                                        <div class="bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-xl p-5 shadow-sm">
                                            <div class="flex items-center justify-center gap-2 mb-3">
                                                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span class="text-base font-semibold text-emerald-800">Auto-Run Status</span>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                <div class="bg-white rounded-lg p-3 shadow-sm">
                                                    <div class="text-gray-600 font-medium mb-1">Last RUN:</div>
                                                    <div id="last-run-time" class="text-emerald-700 font-semibold">Never</div>
                                                </div>
                                                <div class="bg-white rounded-lg p-3 shadow-sm">
                                                    <div class="text-gray-600 font-medium mb-1">Next RUN:</div>
                                                    <div id="next-run-countdown" class="text-emerald-700 font-mono font-bold text-lg">--:--:--</div>
                                                </div>
                                            </div>
                                            <div class="text-center mt-4">
                                                <span id="auto-run-status" class="inline-flex items-center gap-2 bg-emerald-100 text-emerald-800 px-4 py-2 rounded-full text-sm font-medium">
                                                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                                    Auto-run every 6 hours
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Raw Data Export Section -->
                                <div class="max-w-4xl mx-auto mb-8">
                                    <div class="bg-white rounded-2xl shadow-xl p-8 border border-blue-100">
                                        <div class="text-center mb-8">
                                            <div class="flex justify-center mb-4">
                                                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4 rounded-2xl shadow-lg">
                                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                    </svg>
                                                </div>
                                            </div>
                                            <h3 class="text-3xl font-bold text-gray-900 mb-3">
                                                <span class="bg-gradient-to-r from-blue-700 to-indigo-700 bg-clip-text text-transparent">
                                                    ðŸ“Š Raw Data Export
                                                </span>
                                            </h3>
                                            <p class="text-gray-600 mb-6">Export complete raw data reports from your AppsFlyer cache</p>
                                            <div class="text-sm text-gray-500 bg-gray-50 rounded-lg p-3 mb-6">
                                                <strong>Note:</strong> These exports contain the complete raw data from your last report generation (last 10 days). 
                                                If you need fresh data, please run "Get All Stats" first.
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <!-- Stats Raw Data Export -->
                                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-xl font-bold text-gray-800 mb-2">Stats Raw Data</h4>
                                                    <p class="text-gray-600 text-sm mb-4">Complete stats report with impressions, clicks, installs, and events</p>
                                                    <button onclick="exportRawStatsData()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export Stats</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Fraud Raw Data Export -->
                                            <div class="bg-gradient-to-br from-red-50 to-rose-50 border border-red-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-rose-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-xl font-bold text-gray-800 mb-2">Fraud Raw Data</h4>
                                                    <p class="text-gray-600 text-sm mb-4">Complete fraud report with blocked installs, clicks, and sources</p>
                                                    <button onclick="exportRawFraudData()" class="bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export Fraud</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- AppsFlyer Original Raw Data Export -->
                                <div class="max-w-7xl mx-auto mb-12">
                                    <div class="bg-white rounded-2xl shadow-xl p-8 border border-purple-100">
                                        <div class="text-center mb-8">
                                            <div class="flex justify-center mb-4">
                                                <div class="bg-gradient-to-r from-purple-500 to-violet-600 p-4 rounded-2xl shadow-lg">
                                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                    </svg>
                                                </div>
                                            </div>
                                            <h3 class="text-3xl font-bold text-gray-900 mb-3">
                                                <span class="bg-gradient-to-r from-purple-700 to-violet-700 bg-clip-text text-transparent">
                                                    ðŸ”§ Original AppsFlyer Raw Data
                                                </span>
                                            </h3>
                                            <p class="text-gray-600 mb-6">Export original, unmodified CSV data directly from AppsFlyer API endpoints</p>
                                            <div class="text-sm text-gray-500 bg-gray-50 rounded-lg p-3 mb-6">
                                                <strong>Note:</strong> These exports contain the original raw CSV data from AppsFlyer APIs before any processing by our system. 
                                                Data is available after running "Get All Stats" or generating fraud reports.
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <!-- Daily Report -->
                                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">Daily Report</h4>
                                                    <p class="text-gray-600 text-xs mb-3">Impressions, clicks, installs by date</p>
                                                    <button onclick="exportRawDailyReport()" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Blocked Installs RT -->
                                            <div class="bg-gradient-to-br from-red-50 to-rose-50 border border-red-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-rose-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">Blocked Installs RT</h4>
                                                    <p class="text-gray-600 text-xs mb-3">Real-time blocked installs</p>
                                                    <button onclick="exportRawBlockedInstalls()" class="bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Detection (PA) -->
                                            <div class="bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-amber-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">Detection (PA)</h4>
                                                    <p class="text-gray-600 text-xs mb-3">Post-attribution detection</p>
                                                    <button onclick="exportRawDetection()" class="bg-gradient-to-r from-orange-500 to-amber-600 hover:from-orange-600 hover:to-amber-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Blocked In-App Events -->
                                            <div class="bg-gradient-to-br from-purple-50 to-violet-50 border border-purple-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-violet-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">Blocked Events</h4>
                                                    <p class="text-gray-600 text-xs mb-3">Blocked in-app events</p>
                                                    <button onclick="exportRawBlockedEvents()" class="bg-gradient-to-r from-purple-500 to-violet-600 hover:from-purple-600 hover:to-violet-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Fraud Post-InApps -->
                                            <div class="bg-gradient-to-br from-pink-50 to-rose-50 border border-pink-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.882-.833-2.652 0L4.162 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">Fraud Post-InApps</h4>
                                                    <p class="text-gray-600 text-xs mb-3">Fraud post-install events</p>
                                                    <button onclick="exportRawFraudPostInApps()" class="bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Blocked Clicks -->
                                            <div class="bg-gradient-to-br from-cyan-50 to-blue-50 border border-cyan-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">Blocked Clicks</h4>
                                                    <p class="text-gray-600 text-xs mb-3">Blocked clicks report</p>
                                                    <button onclick="exportRawBlockedClicks()" class="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Blocked Install Postbacks -->
                                            <div class="bg-gradient-to-br from-teal-50 to-green-50 border border-teal-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">Blocked Postbacks</h4>
                                                    <p class="text-gray-600 text-xs mb-3">Blocked install postbacks</p>
                                                    <button onclick="exportRawBlockedPostbacks()" class="bg-gradient-to-r from-teal-500 to-green-600 hover:from-teal-600 hover:to-green-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- In-App Events -->
                                            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300">
                                                <div class="text-center">
                                                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V1a1 1 0 011-1h2a1 1 0 011 1v18a1 1 0 01-1 1H4a1 1 0 01-1-1V1a1 1 0 011-1h2a1 1 0 011 1v3"/>
                                                        </svg>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-gray-800 mb-2">In-App Events</h4>
                                                    <p class="text-gray-600 text-xs mb-3">In-app events report</p>
                                                    <button onclick="exportRawInAppEvents()" class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105 text-sm">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                        </svg>
                                                        <span>Export</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Danger Zone -->
                                <div class="max-w-md mx-auto">
                                    <div class="bg-white rounded-2xl shadow-xl p-6 border border-red-100">
                                        <div class="text-center">
                                            <div class="mb-4">
                                                <div class="inline-flex items-center gap-2 text-red-600 mb-3">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.882-.833-2.652 0L4.162 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                                    </svg>
                                                    <span class="text-sm font-bold uppercase tracking-wide">Danger Zone</span>
                                                </div>
                                            </div>
                                            <button id="clear-backend-cache-btn" class="bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 mx-auto transform hover:scale-105">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                                <span class="text-sm">Clear Backend Data</span>
                                            </button>
                                            <div class="mt-3 text-xs text-red-600 bg-red-50 rounded-lg p-2">
                                                <div class="font-medium">âš ï¸ WARNING</div>
                                                <div>This action cannot be undone</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // At the top of the <script> section, add:
        window._chartInstances = window._chartInstances || {};

        // Fallback for fetchedApps
        window.fetchedApps = window.fetchedApps || [];

        // Add a helper to disable/enable all fetch buttons
        function setFetchButtonsDisabled(disabled) {
            document.getElementById('get-apps-btn').disabled = disabled;
            document.getElementById('get-events-btn').disabled = disabled;
            // DO NOT disable date-range-tab buttons anymore
            document.querySelectorAll('[id^="run-report-"]').forEach(btn => btn.disabled = disabled);
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Activate selected tab button
            event.target.classList.add('active');
        }

        // Enhanced fetchApps function with integrated loading state
        fetchApps = function() {
            // Prevent concurrent calls
            if (isFetchingApps) {
                console.log('fetchApps already in progress, skipping...');
                return;
            }
            
            isFetchingApps = true;
            const button = document.getElementById('get-apps-btn');
            const spinner = button.querySelector('.loading-spinner');
            
            // Helper function to reset state
            function resetAppsFetchState() {
                isFetchingApps = false;
                hideSyncLoadingState();
                button.disabled = false;
                spinner.style.display = 'none';
                button.querySelector('span').textContent = 'Sync Apps';
            }
            
            // Show loading state on page
            showSyncLoadingState();
            
            // Disable button with original spinner
            button.disabled = true;
            spinner.style.display = 'inline-block';
            button.querySelector('span').textContent = 'Syncing...';

            fetch('/get_apps')
                .then(response => response.text())
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        resetAppsFetchState();
                        document.getElementById('app-count').textContent = 'Error parsing data. Please try again.';
                        showErrorToast('Error parsing data. Please try again.');
                        return;
                    }

                    if (data.status === 'processing') {
                        updateSyncProgress(90, 'Data is being processed...', 'Almost ready! Processing your apps...');
                        setTimeout(() => {
                            resetAppsFetchState();
                        document.getElementById('app-count').textContent = "Please wait a few minutes for the data to be ready.";
                            showInfoToast('Data is being processed. Please try again in a few minutes.');
                        }, 2000);
                        setTimeout(fetchApps, 30000);
                        return;
                    }

                    // Success - complete the progress
                    updateSyncProgress(100, 'Complete!', 'Successfully synced your apps!');
                    
                    setTimeout(() => {
                        resetAppsFetchState();

                    if (data.error) {
                        document.getElementById('app-count').textContent = `Error: ${data.error}`;
                            showErrorToast(`Error: ${data.error}`);
                        return;
                    }

                    // Ensure each app has the is_active property set
                    window.fetchedApps = data.apps.map(app => ({
                        ...app,
                        is_active: typeof app.is_active === 'boolean' ? app.is_active : true
                    }));
                    
                    // Update localStorage with the latest data
                    localStorage.setItem('fetchedApps', JSON.stringify(window.fetchedApps));
                    
                    // Render the apps list
                    renderAppsList(window.fetchedApps);
                    
                    // Update UI elements
                    document.getElementById('app-count').textContent = data.count;
                    document.getElementById('apps-last-updated').textContent = data.fetch_time ? `(Last updated: ${data.fetch_time})` : '';

                    // Show a toast message indicating data source
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    
                    // Check if all apps are active
                    const allAppsActive = window.fetchedApps.every(app => app.is_active);
                    
                    if (data.used_cache) {
                        toast.textContent = 'Using cached data (contains inactive apps)';
                    } else {
                        toast.textContent = allAppsActive ? 
                            'Fetched fresh data from AppsFlyer (all apps are active)' : 
                            'Fetched fresh data from AppsFlyer';
                    }
                    
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                    }, 1500); // Give time to show completion
                })
                .catch(error => {
                    console.error('Error fetching apps:', error);
                    resetAppsFetchState();
                    document.getElementById('app-count').textContent = 'Error fetching apps. Please try again.';
                    showErrorToast('Error fetching apps. Please try again.');
                });
        }
        
        // Loading state management functions
        let syncTimer;
        let syncStartTime;
        let syncProgressInterval;
        
        function showSyncLoadingState() {
            const loadingState = document.getElementById('apps-sync-loading-state');
            const mainContent = document.querySelectorAll('#apps-tab .bg-white.rounded-2xl, #apps-tab .flex.flex-col.sm\\:flex-row.justify-between');
            
            // Show loading state
            loadingState.style.display = 'block';
            
            // Hide main content (search, table, action buttons)
            mainContent.forEach(element => {
                if (!element.closest('#apps-sync-loading-state')) {
                    element.style.display = 'none';
                }
            });
            
            // Reset all elements
            document.getElementById('sync-progress-bar').style.width = '0%';
            document.getElementById('sync-progress-text').textContent = '0%';
            document.getElementById('sync-status-text').textContent = 'Connecting to AppsFlyer...';
            document.getElementById('sync-timer').textContent = '00:00';
            document.getElementById('loading-text').textContent = 'ðŸ”„ Syncing Your Apps Now';
            document.getElementById('sync-message').textContent = 'Establishing connection with AppsFlyer...';
            
            // Start timer
            syncStartTime = Date.now();
            syncTimer = setInterval(updateSyncTimer, 1000);
            
            // Start progress animation
            startProgressAnimation();
        }
        
        function hideSyncLoadingState() {
            const loadingState = document.getElementById('apps-sync-loading-state');
            const mainContent = document.querySelectorAll('#apps-tab .bg-white.rounded-2xl, #apps-tab .flex.flex-col.sm\\:flex-row.justify-between');
            
            // Hide loading state
            loadingState.style.display = 'none';
            
            // Show main content again
            mainContent.forEach(element => {
                if (!element.closest('#apps-sync-loading-state')) {
                    element.style.display = '';
                }
            });
            
            // Clear timers
            if (syncTimer) {
                clearInterval(syncTimer);
                syncTimer = null;
            }
            if (syncProgressInterval) {
                clearInterval(syncProgressInterval);
                syncProgressInterval = null;
            }
        }
        
        function updateSyncTimer() {
            const elapsed = Date.now() - syncStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('sync-timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function startProgressAnimation() {
            let progress = 0;
            const messages = [
                { progress: 20, status: 'Authenticating with AppsFlyer...', message: 'Establishing secure connection...' },
                { progress: 40, status: 'Fetching app data...', message: 'Downloading your mobile apps...' },
                { progress: 60, status: 'Processing app information...', message: 'Organizing and validating data...' },
                { progress: 80, status: 'Finalizing sync...', message: 'Almost there! Preparing your apps...' }
            ];
            
            syncProgressInterval = setInterval(() => {
                progress += Math.random() * 15 + 5; // Random progress between 5-20%
                
                if (progress >= 85) {
                    clearInterval(syncProgressInterval);
                    progress = 85; // Cap at 85% until real completion
                }
                
                // Update progress bar
                updateSyncProgress(progress);
                
                // Update messages based on progress
                for (const msgData of messages) {
                    if (progress >= msgData.progress && progress < msgData.progress + 20) {
                        document.getElementById('sync-status-text').textContent = msgData.status;
                        document.getElementById('sync-message').textContent = msgData.message;
                        break;
                    }
                }
                
                // Update loading text occasionally with emojis
                if (Math.random() < 0.3) {
                    const loadingTexts = [
                        'ðŸ”„ Syncing Your Apps Now',
                        'ðŸ“± Loading Mobile Apps...',
                        'â±ï¸ Almost Ready!',
                        'ðŸš€ Getting Your Apps...',
                        'ðŸ”— Connecting to AppsFlyer...'
                    ];
                    const randomText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];
                    document.getElementById('loading-text').textContent = randomText;
                }
            }, 1000);
        }
        
        function updateSyncProgress(progress, status, message) {
            progress = Math.min(100, Math.max(0, progress));
            
            document.getElementById('sync-progress-bar').style.width = `${progress}%`;
            document.getElementById('sync-progress-text').textContent = `${Math.round(progress)}%`;
            
            if (status) {
                document.getElementById('sync-status-text').textContent = status;
            }
            
            if (message) {
                document.getElementById('sync-message').textContent = message;
            }
        }
        
        // Toast notification functions
        function showErrorToast(message) {
            showToast(message, 'error');
        }
        
        function showInfoToast(message) {
            showToast(message, 'info');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        // Add flags to prevent concurrent calls
        let isFetchingApps = false;
        let isFetchingFraudReport = false;
        
        // Comprehensive dashboard refresh function
        function refreshAllDashboardData() {
            console.log('Refreshing all dashboard data...');
            
            // Refresh overview data (main charts and metrics)
            fetchOverviewData();
            
            // Refresh top performing apps
            fetchTopPerformingApps();
            
            // Force refresh stats page if it's currently active
            const statsTab = document.getElementById('stats-tab');
            if (statsTab && statsTab.classList.contains('active')) {
                console.log('Refreshing stats page...');
                setTimeout(() => {
                    fetch('/get_subpage_10d')
                        .then(r => r.json())
                        .then(data => {
                            if (data && data.apps && data.apps.length > 0) {
                                renderStatsAppsForRange('10d', data.apps);
                            }
                        })
                        .catch(e => console.warn('Error refreshing stats page:', e));
                }, 200);
            }
            
            // Force refresh fraud page if it's currently active
            const fraudTab = document.getElementById('fraud-tab');
            if (fraudTab && fraudTab.classList.contains('active')) {
                console.log('Refreshing fraud page...');
                setTimeout(() => {
                    fetch('/get_fraud_subpage_10d')
                        .then(r => r.json())
                        .then(data => {
                            if (data && data.apps && data.apps.length > 0) {
                                // Populate Analytics tab
                                renderFraudAll(data, '10d');
                                
                                // Also populate Source tab with the same data
                                fraudSourceDataCache['10d'] = data;
                                console.log('Populated fraud source cache from Get All Stats');
                            }
                        })
                        .catch(e => console.warn('Error refreshing fraud page:', e));
                }, 200);
            }
            
            console.log('Dashboard refresh completed');
        }

        // Stats Report Loading state management functions
        let statsReportTimer;
        let statsReportStartTime;
        let statsReportProgressInterval;
        
        function showStatsReportLoadingState() {
            const loadingState = document.getElementById('stats-report-loading-state');
            const mainContent = document.querySelectorAll('#stats-tab .stats-range-content, #stats-tab #stats-loading, #stats-tab #stats-error, #stats-tab .flex.justify-center');
            
            // Show loading state
            loadingState.style.display = 'block';
            
            // Hide main content (stats data, search, etc.)
            mainContent.forEach(element => {
                if (!element.closest('#stats-report-loading-state')) {
                    element.style.display = 'none';
                }
            });
            
            // Reset all elements
            document.getElementById('stats-sync-progress-bar').style.width = '0%';
            document.getElementById('stats-sync-progress-text').textContent = '0%';
            document.getElementById('stats-sync-status-text').textContent = 'Preparing report generation...';
            document.getElementById('stats-sync-timer').textContent = '00:00';
            document.getElementById('stats-loading-text').textContent = 'ðŸ“Š Generating Your Report';
            document.getElementById('stats-sync-message').textContent = 'Initializing report generation...';
            
            // Start timer
            statsReportStartTime = Date.now();
            statsReportTimer = setInterval(updateStatsReportTimer, 1000);
            
            // Start progress animation
            startStatsReportProgressAnimation();
        }
        
        function hideStatsReportLoadingState() {
            const loadingState = document.getElementById('stats-report-loading-state');
            const mainContent = document.querySelectorAll('#stats-tab .stats-range-content, #stats-tab #stats-loading, #stats-tab #stats-error, #stats-tab .flex.justify-center');
            
            // Hide loading state
            loadingState.style.display = 'none';
            
            // Show main content again
            mainContent.forEach(element => {
                if (!element.closest('#stats-report-loading-state')) {
                    element.style.display = '';
                }
            });
            
            // Clear timers
            if (statsReportTimer) {
                clearInterval(statsReportTimer);
                statsReportTimer = null;
            }
            if (statsReportProgressInterval) {
                clearInterval(statsReportProgressInterval);
                statsReportProgressInterval = null;
            }
        }
        
        function updateStatsReportTimer() {
            const elapsed = Date.now() - statsReportStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('stats-sync-timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function startStatsReportProgressAnimation() {
            let progress = 0;
            const messages = [
                { progress: 15, status: 'Connecting to data sources...', message: 'Establishing connections to AppsFlyer API...' },
                { progress: 30, status: 'Fetching app performance data...', message: 'Downloading analytics for your campaigns...' },
                { progress: 50, status: 'Processing metrics and KPIs...', message: 'Calculating impressions, clicks, and conversions...' },
                { progress: 70, status: 'Analyzing performance trends...', message: 'Generating insights and recommendations...' },
                { progress: 85, status: 'Finalizing report...', message: 'Preparing your analytics dashboard...' }
            ];
            
            statsReportProgressInterval = setInterval(() => {
                progress += Math.random() * 10 + 3; // Random progress between 3-13%
                
                if (progress >= 90) {
                    clearInterval(statsReportProgressInterval);
                    progress = 90; // Cap at 90% until real completion
                }
                
                // Update progress bar
                updateStatsReportProgress(progress);
                
                // Update messages based on progress
                for (const msgData of messages) {
                    if (progress >= msgData.progress && progress < msgData.progress + 15) {
                        document.getElementById('stats-sync-status-text').textContent = msgData.status;
                        document.getElementById('stats-sync-message').textContent = msgData.message;
                        break;
                    }
                }
                
                // Update loading text occasionally with emojis
                if (Math.random() < 0.3) {
                    const loadingTexts = [
                        'ðŸ“Š Generating Your Report',
                        'ðŸ“ˆ Analyzing Performance...',
                        'â±ï¸ Almost Ready!',
                        'ðŸš€ Processing Data...',
                        'ðŸ” Gathering Insights...'
                    ];
                    const randomText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];
                    document.getElementById('stats-loading-text').textContent = randomText;
                }
            }, 2000); // Update every 2 seconds for report generation
        }
        
        function updateStatsReportProgress(progress, status, message) {
            progress = Math.min(100, Math.max(0, progress));
            
            document.getElementById('stats-sync-progress-bar').style.width = `${progress}%`;
            document.getElementById('stats-sync-progress-text').textContent = `${Math.round(progress)}%`;
            
            if (status) {
                document.getElementById('stats-sync-status-text').textContent = status;
            }
            
            if (message) {
                document.getElementById('stats-sync-message').textContent = message;
            }
        }
        
        // Stats toast notification functions
        function showStatsErrorToast(message) {
            showStatsToast(message, 'error');
        }
        
        function showStatsSuccessToast(message) {
            showStatsToast(message, 'success');
        }
        
        function showStatsToast(message, type = 'info') {
            const toast = document.createElement('div');
            let bgColor;
            switch(type) {
                case 'error': bgColor = 'bg-red-600'; break;
                case 'success': bgColor = 'bg-green-600'; break;
                default: bgColor = 'bg-orange-600'; break;
            }
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Fraud Report Loading state management functions
        let fraudReportTimer;
        let fraudReportStartTime;
        let fraudReportProgressInterval;
        
        function showFraudReportLoadingState() {
            const loadingState = document.getElementById('fraud-report-loading-state');
            const mainContent = document.querySelectorAll('#fraud-tab .fraud-range-content, #fraud-tab .fraud-source-range-content, #fraud-tab #fraud-loading, #fraud-tab #fraud-error, #fraud-tab #fraud-source-loading, #fraud-tab #fraud-source-error, #fraud-tab .flex.justify-center');
            
            // Show loading state
            loadingState.style.display = 'block';
            
            // Hide main content (fraud data, etc.)
            mainContent.forEach(element => {
                if (!element.closest('#fraud-report-loading-state')) {
                    element.style.display = 'none';
                }
            });
            
            // Reset all elements
            document.getElementById('fraud-sync-progress-bar').style.width = '0%';
            document.getElementById('fraud-sync-progress-text').textContent = '0%';
            document.getElementById('fraud-sync-status-text').textContent = 'Preparing security analysis...';
            document.getElementById('fraud-sync-timer').textContent = '00:00';
            document.getElementById('fraud-loading-text').textContent = 'ðŸ›¡ï¸ Analyzing Security Threats';
            document.getElementById('fraud-sync-message').textContent = 'Initializing fraud detection systems...';
            
            // Start timer
            fraudReportStartTime = Date.now();
            fraudReportTimer = setInterval(updateFraudReportTimer, 1000);
            
            // Start progress animation
            startFraudReportProgressAnimation();
        }
        
        function hideFraudReportLoadingState() {
            const loadingState = document.getElementById('fraud-report-loading-state');
            const mainContent = document.querySelectorAll('#fraud-tab .fraud-range-content, #fraud-tab .fraud-source-range-content, #fraud-tab #fraud-loading, #fraud-tab #fraud-error, #fraud-tab #fraud-source-loading, #fraud-tab #fraud-source-error, #fraud-tab .flex.justify-center');
            
            // Hide loading state
            loadingState.style.display = 'none';
            
            // Show main content again
            mainContent.forEach(element => {
                if (!element.closest('#fraud-report-loading-state')) {
                    element.style.display = '';
                }
            });
            
            // Clear timers
            if (fraudReportTimer) {
                clearInterval(fraudReportTimer);
                fraudReportTimer = null;
            }
            if (fraudReportProgressInterval) {
                clearInterval(fraudReportProgressInterval);
                fraudReportProgressInterval = null;
            }
        }
        
        function updateFraudReportTimer() {
            const elapsed = Date.now() - fraudReportStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('fraud-sync-timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function startFraudReportProgressAnimation() {
            let progress = 0;
            const messages = [
                { progress: 20, status: 'Connecting to security systems...', message: 'Establishing secure connections to fraud detection APIs...' },
                { progress: 40, status: 'Scanning for malicious activity...', message: 'Analyzing traffic patterns and behavior...' },
                { progress: 60, status: 'Processing threat intelligence...', message: 'Evaluating blocked installs and suspicious events...' },
                { progress: 80, status: 'Generating security report...', message: 'Compiling fraud protection metrics and insights...' }
            ];
            
            fraudReportProgressInterval = setInterval(() => {
                progress += Math.random() * 12 + 4; // Random progress between 4-16%
                
                if (progress >= 88) {
                    clearInterval(fraudReportProgressInterval);
                    progress = 88; // Cap at 88% until real completion
                }
                
                // Update progress bar
                updateFraudReportProgress(progress);
                
                // Update messages based on progress
                for (const msgData of messages) {
                    if (progress >= msgData.progress && progress < msgData.progress + 20) {
                        document.getElementById('fraud-sync-status-text').textContent = msgData.status;
                        document.getElementById('fraud-sync-message').textContent = msgData.message;
                        break;
                    }
                }
                
                // Update loading text occasionally with security emojis
                if (Math.random() < 0.3) {
                    const loadingTexts = [
                        'ðŸ›¡ï¸ Analyzing Security Threats',
                        'ðŸ”’ Scanning for Fraud...',
                        'âš¡ Almost Secure!',
                        'ðŸš¨ Detecting Threats...',
                        'ðŸ” Deep Security Scan...'
                    ];
                    const randomText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];
                    document.getElementById('fraud-loading-text').textContent = randomText;
                }
            }, 2500); // Update every 2.5 seconds for fraud analysis
        }
        
        function updateFraudReportProgress(progress, status, message) {
            progress = Math.min(100, Math.max(0, progress));
            
            document.getElementById('fraud-sync-progress-bar').style.width = `${progress}%`;
            document.getElementById('fraud-sync-progress-text').textContent = `${Math.round(progress)}%`;
            
            if (status) {
                document.getElementById('fraud-sync-status-text').textContent = status;
            }
            
            if (message) {
                document.getElementById('fraud-sync-message').textContent = message;
            }
        }
        
        // Fraud toast notification functions
        function showFraudErrorToast(message) {
            showFraudToast(message, 'error');
        }
        
        function showFraudSuccessToast(message) {
            showFraudToast(message, 'success');
        }
        
        function showFraudInfoToast(message) {
            showFraudToast(message, 'info');
        }
        
        function showFraudInfoToast(message) {
            showFraudToast(message, 'info');
        }
        
        function showFraudToast(message, type = 'info') {
            const toast = document.createElement('div');
            let bgColor;
            switch(type) {
                case 'error': bgColor = 'bg-red-600'; break;
                case 'success': bgColor = 'bg-green-600'; break;
                default: bgColor = 'bg-indigo-600'; break;
            }
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function showCredentialToast(message, type = 'info') {
            const toast = document.createElement('div');
            let bgColor, icon;
            switch(type) {
                case 'error': 
                    bgColor = 'bg-red-600'; 
                    icon = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                    break;
                case 'success': 
                    bgColor = 'bg-green-600'; 
                    icon = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                    break;
                default: 
                    bgColor = 'bg-indigo-600'; 
                    icon = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    break;
            }
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-300 flex items-center gap-3`;
            toast.innerHTML = `
                <div class="flex-shrink-0">${icon}</div>
                <div class="flex-1">
                    <div class="font-semibold">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="text-sm opacity-90">${message}</div>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto-close after delay
            const delay = type === 'error' ? 6000 : 4000;
            setTimeout(() => {
                toast.style.transform = 'translateY(100%)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, delay);
        }

        function logout() {
            fetch('/logout')
                .then(() => {
                    window.location.href = '/';
                });
        }

        // Check authentication status
        function checkAuth() {
            fetch('/check-auth')
                .then(response => {
                    if (!response.ok) {
                        window.location.href = '/';
                    }
                });
        }

        // Check auth status periodically
        setInterval(checkAuth, 30000);
        checkAuth();

        // --- Stats Tab Logic ---
        // Persistent stats data for the 10d range
        const statsData = {
            '10d': null
        };

        // Load stats data from localStorage
        function loadStatsData() {
            const savedData = localStorage.getItem('statsData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                if (parsedData['10d']) {
                    statsData['10d'] = parsedData['10d'];
                }
                return statsData;
            }
            return null;
        }

        // Save stats data to localStorage
        function saveStatsData(data, range) {
            if (range === '10d') {
            statsData[range] = data;
            localStorage.setItem('statsData', JSON.stringify(statsData));
        }
        }

        // Initialize stats page with 10d data
        function initializeStatsPage() {
            // Load cached data on page load
            fetch('/get_subpage_10d')
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.apps && data.apps.length > 0) {
                            setTimeout(() => {
                            renderStatsAppsForRange('10d', data.apps);
                                document.getElementById('stats-error').style.display = 'none';
                            }, 80);
                        } else {
                        document.getElementById('stats-data-10d').innerHTML = '<div class="text-gray-400 py-4 text-center">No cached stats data available. Please run a report to load data.</div>';
                            document.getElementById('stats-error').style.display = '';
                        }
                    })
                    .catch(() => {
                    document.getElementById('stats-data-10d').innerHTML = '<div class="text-red-500 py-4 text-center">Error loading stats data.</div>';
                        document.getElementById('stats-error').style.display = '';
                    });
            }

        // Initialize the stats page
        initializeStatsPage();

        // Setup RUN REPORT button for 10d range only
        const btn = document.getElementById('run-report-10d-btn');
            if (btn) {
                btn.onclick = function() {
                console.log('RUN REPORT clicked for 10d range');
                    console.log('fetchedApps:', window.fetchedApps);
                    if (!window.fetchedApps || !window.fetchedApps.length) {
                        alert('No apps loaded. Please click Get Apps first.');
                        return;
                    }
                runStatsReport('10d');
            };
        }

        // App Search Filter Functionality
        let allStatsApps = [];
        
        function initializeAppSearchFilter() {
            const searchInput = document.getElementById('app-search-filter');
            const appCountDisplay = document.getElementById('app-count-display');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    filterStatsApps(searchTerm);
                });
            }
            
            // Update app count display
            function updateAppCount(count) {
                if (appCountDisplay) {
                    appCountDisplay.textContent = `${count} campaign${count !== 1 ? 's' : ''}`;
                }
            }
            
            // Filter apps based on search term
            function filterStatsApps(searchTerm) {
                const container = document.getElementById('stats-data-10d');
                const appSections = container.querySelectorAll('.bg-white.rounded-3xl');
                let visibleCount = 0;
                
                appSections.forEach(section => {
                    const appName = section.querySelector('h2')?.textContent?.toLowerCase() || '';
                    const appId = section.querySelector('[class*="font-mono"]')?.textContent?.toLowerCase() || '';
                    
                    const isVisible = searchTerm === '' || 
                                    appName.includes(searchTerm) || 
                                    appId.includes(searchTerm);
                    
                    if (isVisible) {
                        section.style.display = '';
                        visibleCount++;
            } else {
                        section.style.display = 'none';
                    }
                });
                
                updateAppCount(visibleCount);
                
                // Show/hide no results message
                let noResultsMsg = container.querySelector('#no-search-results');
                if (visibleCount === 0 && searchTerm !== '') {
                    if (!noResultsMsg) {
                        noResultsMsg = document.createElement('div');
                        noResultsMsg.id = 'no-search-results';
                        noResultsMsg.className = 'text-center py-16';
                        noResultsMsg.innerHTML = `
                            <div class="bg-gray-100 rounded-2xl p-8 max-w-md mx-auto">
                                <div class="text-gray-600 text-lg font-semibold mb-2">ðŸ” No Campaigns Found</div>
                                <div class="text-gray-500 text-sm">No campaigns match your search criteria. Try a different search term.</div>
                            </div>
                        `;
                        container.appendChild(noResultsMsg);
                    }
                    noResultsMsg.style.display = '';
                } else if (noResultsMsg) {
                    noResultsMsg.style.display = 'none';
                }
            }
            
            // Initialize with current campaigns count
            setTimeout(() => {
                const container = document.getElementById('stats-data-10d');
                const appSections = container ? container.querySelectorAll('.bg-white.rounded-3xl') : [];
                updateAppCount(appSections.length);
            }, 500);
        }
        
        // Initialize search filter when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAppSearchFilter);
        } else {
            initializeAppSearchFilter();
        }
        function runStatsReport(range) {
            // Only handle 10d range
            if (range !== '10d') return;
            
            // Show beautiful loading state
            showStatsReportLoadingState();
            
            setFetchButtonsDisabled(true);
            
            let eventSelections = JSON.parse(localStorage.getItem('eventSelections') || '{}');
            
            // Failsafe timer to ensure loading state is always hidden
            const failsafeTimer = setTimeout(() => {
                console.warn('Stats report failsafe timer triggered - forcing loading state to close');
                completeStatsReport(null, 'Timeout - please try again');
            }, 900000); // 15 minutes failsafe
            
            // Helper function to complete the stats report
            function completeStatsReport(result, error) {
                clearTimeout(failsafeTimer);
                
                if (result) {
                    // Success - complete the progress
                    updateStatsReportProgress(100, 'Complete!', 'Report generated successfully!');
                    
                    setTimeout(() => {
                        hideStatsReportLoadingState();
                        setFetchButtonsDisabled(false);
                        
                        // Save and render data
                        saveStatsData(result, range);
                        renderStatsAppsForRange(range, result.apps || []);
                        
                        // Comprehensive data refresh
                        setTimeout(() => {
                            refreshAllDashboardData();
                        }, 100);
                        
                        showStatsSuccessToast('Report generated successfully!');
                        console.log('Stats report completed successfully');
                    }, 1500); // Give time to show completion
                } else {
                    // Error or timeout
                    hideStatsReportLoadingState();
                    setFetchButtonsDisabled(false);
                    const errorElem = document.getElementById('stats-error');
                    if (errorElem) {
                        errorElem.textContent = error || 'Unknown error occurred';
                        errorElem.style.display = '';
                    }
                    showStatsErrorToast(error || 'Error generating report');
                    console.error('Stats report failed:', error);
                }
            }
            
            // Start the report generation
            fetch('/start-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    apps: window.fetchedApps,
                    period: 'last10',
                    selected_events: eventSelections
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'processing') {
                    // Start polling for status (legacy async mode)
                    pollReportStatus(data.job_id, range, completeStatsReport);
                } else if (data.status === 'completed' && data.result) {
                    // Direct completion (new synchronous mode)
                    completeStatsReport(data.result);
                } else if (data.error) {
                    // Error occurred
                    completeStatsReport(null, `Error: ${data.error}`);
                } else {
                    // Unknown response format
                    console.log('Unknown response format:', data);
                    completeStatsReport(null, 'Unexpected response format. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error in stats report:', error);
                completeStatsReport(null, 'Error starting report generation. Please try again.');
            });
        }

        function pollReportStatus(jobId, range, completeCallback) {
            fetch(`/report-status/${jobId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'completed') {
                        // Report is ready - use callback to complete
                        if (completeCallback) {
                            completeCallback(data.result);
                        } else {
                            // Fallback for legacy calls
                            updateStatsReportProgress(100, 'Complete!', 'Report generated successfully!');
                            setTimeout(() => {
                                hideStatsReportLoadingState();
                        setFetchButtonsDisabled(false);
                        saveStatsData(data.result, range);
                        renderStatsAppsForRange(range, data.result.apps || []);
                        fetchOverviewData();
                        fetchTopPerformingApps();
                                showStatsSuccessToast('Report generated successfully!');
                            }, 1500);
                        }
                    } else if (data.status === 'failed') {
                        // Report generation failed
                        if (completeCallback) {
                            completeCallback(null, 'Error generating report. Please try again.');
                        } else {
                            // Fallback for legacy calls
                            hideStatsReportLoadingState();
                        setFetchButtonsDisabled(false);
                            const errorElem = document.getElementById('stats-error');
                        if (errorElem) {
                            errorElem.textContent = "Error generating report. Please try again.";
                            errorElem.style.display = '';
                            }
                            showStatsErrorToast('Error generating report. Please try again.');
                        }
                    } else if (data.status === 'processing') {
                        // Still processing, poll again after 5 seconds
                        setTimeout(() => pollReportStatus(jobId, range, completeCallback), 5000);
                    }
                })
                .catch(error => {
                    console.error('Error polling report status:', error);
                    if (completeCallback) {
                        completeCallback(null, 'Error checking report status. Please try again.');
                    } else {
                        // Fallback for legacy calls
                        hideStatsReportLoadingState();
                    setFetchButtonsDisabled(false);
                        const errorElem = document.getElementById('stats-error');
                    if (errorElem) {
                        errorElem.textContent = "Error checking report status. Please try again.";
                        errorElem.style.display = '';
                        }
                        showStatsErrorToast('Error checking report status. Please try again.');
                    }
                });
        }

        // Enhanced renderStatsAppsForRange with modern UI
        function renderStatsAppsForRange(range, apps) {
            const container = document.getElementById(`stats-data-${range}`);
            container.innerHTML = '';
            
            if (!apps || apps.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="bg-gray-100 rounded-2xl p-8 max-w-md mx-auto">
                            <div class="text-gray-600 text-lg font-semibold mb-2">ðŸ“Š No Data Available</div>
                            <div class="text-gray-500 text-sm">Please run a report to view analytics data.</div>
                        </div>
                    </div>`;
                return;
            }

            apps.forEach((app, index) => {
                const section = document.createElement('div');
                section.className = 'bg-white rounded-3xl shadow-2xl p-8 mb-8 border border-indigo-100 hover:shadow-3xl transition-all duration-300 hover:border-indigo-200';
                
                // Enhanced app header with improved design
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex flex-col xl:flex-row xl:items-center xl:justify-between mb-8 pb-8 border-b border-indigo-100';
                
                // Left side - Enhanced App info
                const appInfo = document.createElement('div');
                appInfo.className = 'mb-6 xl:mb-0 xl:flex-1';
                appInfo.innerHTML = `
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl p-6 border border-indigo-100">
                        <div class="flex items-center space-x-4 mb-3">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h2 class="text-2xl font-bold text-gray-900 truncate">${app.app_name}</h2>
                                <div class="flex items-center mt-1">
                                    <span class="text-sm text-gray-500 font-medium">Campaign ID:</span>
                                    <span class="ml-2 text-sm font-mono text-indigo-600 bg-indigo-100 px-2 py-1 rounded-lg">${app.app_id}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Right side - Enhanced Totals with better centering
                const quickMetrics = document.createElement('div');
                quickMetrics.className = 'xl:flex-1 xl:ml-8';
                
                if (app.table && app.table.length > 0) {
                    const totalImpressions = app.table.reduce((sum, row) => sum + (row.impressions || 0), 0);
                    const totalClicks = app.table.reduce((sum, row) => sum + (row.clicks || 0), 0);
                    const totalInstalls = app.table.reduce((sum, row) => sum + (row.installs || 0), 0);
                    
                    // Calculate event totals
                    let eventTotalsHtml = '';
                    if (app.selected_events && app.selected_events.length > 0) {
                        const eventTotals = [];
                        
                        app.selected_events.forEach((event, index) => {
                            if (event) {
                                const total = app.table.reduce((sum, row) => sum + (row[event] || 0), 0);
                                const eventIcon = index === 0 ? 'âš¡' : index === 1 ? 'ðŸŽ¯' : 'ðŸ”¥';
                                
                                // Define colors more explicitly for each event
                                let iconColor, textColor, numberColor;
                                if (index === 0) {
                                    iconColor = '#f97316'; // orange-500
                                    textColor = '#ea580c'; // orange-600  
                                    numberColor = '#c2410c'; // orange-700
                                } else if (index === 1) {
                                    iconColor = '#6366f1'; // indigo-500
                                    textColor = '#4f46e5'; // indigo-600
                                    numberColor = '#4338ca'; // indigo-700
                                } else {
                                    iconColor = '#ec4899'; // pink-500
                                    textColor = '#db2777'; // pink-600
                                    numberColor = '#be185d'; // pink-700
                                }
                                
                                eventTotals.push(`
                                    <div class="w-px h-8 bg-gray-300"></div>
                                    <div class="text-center">
                                        <div class="flex items-center justify-center space-x-1 mb-1">
                                            <span class="text-xs" style="color: ${iconColor}">${eventIcon}</span>
                                            <span class="text-xs font-medium" style="color: ${textColor}">${event}</span>
                                        </div>
                                        <div class="text-lg font-bold" style="color: ${numberColor}">${total.toLocaleString()}</div>
                                    </div>
                                `);
                            }
                        });
                        
                        eventTotalsHtml = eventTotals.join('');
                    }
                    
                    quickMetrics.innerHTML = `
                        <div class="bg-gradient-to-r from-white to-indigo-50 rounded-xl p-4 border border-indigo-200 shadow-sm">
                            <div class="text-center mb-3">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center justify-center space-x-1">
                                    <span>ðŸ“Š</span>
                                    <span>Totals</span>
                                </h3>
                            </div>
                            <div class="flex items-center justify-center space-x-4">
                                <div class="text-center">
                                    <div class="flex items-center justify-center space-x-1 mb-1">
                                        <span class="text-blue-500 text-xs">ðŸ‘ï¸</span>
                                        <span class="text-xs text-blue-600 font-medium">Impressions</span>
                                    </div>
                                    <div class="text-lg font-bold text-blue-700">${totalImpressions.toLocaleString()}</div>
                                </div>
                                <div class="w-px h-8 bg-gray-300"></div>
                                <div class="text-center">
                                    <div class="flex items-center justify-center space-x-1 mb-1">
                                        <span class="text-green-500 text-xs">ðŸ–±ï¸</span>
                                        <span class="text-xs text-green-600 font-medium">Clicks</span>
                                    </div>
                                    <div class="text-lg font-bold text-green-700">${totalClicks.toLocaleString()}</div>
                                </div>
                                <div class="w-px h-8 bg-gray-300"></div>
                                <div class="text-center">
                                    <div class="flex items-center justify-center space-x-1 mb-1">
                                        <span class="text-purple-500 text-xs">ðŸ“±</span>
                                        <span class="text-xs text-purple-600 font-medium">Installs</span>
                                    </div>
                                    <div class="text-lg font-bold text-purple-700">${totalInstalls.toLocaleString()}</div>
                                </div>
                                ${eventTotalsHtml}
                            </div>
                        </div>
                    `;
                }
                
                headerDiv.appendChild(appInfo);
                headerDiv.appendChild(quickMetrics);
                section.appendChild(headerDiv);
                
                if (app.table && app.table.length > 0) {
                    const dates = app.table.map(r => r.date);
                    const metrics = [
                        { key: 'impressions', label: 'Impressions', isNumber: true, icon: 'ðŸ‘ï¸' },
                        { key: 'clicks', label: 'Clicks', isNumber: true, icon: 'ðŸ–±ï¸' },
                        { key: 'installs', label: 'Installs', isNumber: true, icon: 'ðŸ“±' }
                    ];
                    
                    // Add event metrics if they exist
                    if (app.selected_events) {
                        app.selected_events.forEach(event => {
                            metrics.push({ key: event, label: event, isNumber: true, icon: 'âš¡' });
                        });
                    }
                    
                    // Add conversion metrics
                    metrics.push(
                        { key: 'imp_to_click', label: 'Impression to Click Rate', percent: true, icon: 'ðŸ“Š' },
                        { key: 'click_to_install', label: 'Click to Install Rate', percent: true, decimals: 2, icon: 'ðŸŽ¯' }
                    );
                    
                    if (app.selected_events && app.selected_events[0]) {
                        metrics.push({ key: 'install_to_' + app.selected_events[0], label: `Install to ${app.selected_events[0]} Rate`, percent: true, icon: 'ðŸ“ˆ' });
                    }
                    if (app.selected_events && app.selected_events[0] && app.selected_events[1]) {
                        metrics.push({ key: app.selected_events[0] + '_to_' + app.selected_events[1], label: `${app.selected_events[0]} to ${app.selected_events[1]} Rate`, percent: true, icon: 'ðŸ”—' });
                    }
                    
                    metrics.push(
                        { key: 'blocked_installs_rt', label: 'Blocked Installs RT (Count)', isNumber: true, icon: 'ðŸ›¡ï¸' },
                        { key: 'blocked_rt_rate', label: 'Blocked Installs RT (%)', percent: true, icon: 'ðŸ›¡ï¸' },
                        { key: 'blocked_installs_pa', label: 'Blocked Installs PA (Count)', isNumber: true, icon: 'ðŸš«' },
                        { key: 'blocked_pa_rate', label: 'Blocked Installs PA (%)', percent: true, icon: 'ðŸš«' }
                    );

                    // Compute extra % columns
                    app.table.forEach(row => {
                        if (app.selected_events && app.selected_events[0] && row.installs > 0 && row[app.selected_events[0]] !== undefined) {
                            row['install_to_' + app.selected_events[0]] = row[app.selected_events[0]] / row.installs;
                        }
                        if (app.selected_events && app.selected_events[0] && app.selected_events[1] && row[app.selected_events[0]] > 0 && row[app.selected_events[1]] !== undefined) {
                            row[app.selected_events[0] + '_to_' + app.selected_events[1]] = row[app.selected_events[1]] / row[app.selected_events[0]];
                        }
                    });

                    // Enhanced compact table with better organization
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'mb-8';
                    
                    // Create organized metric sections
                    const createMetricSection = (title, icon, metrics, bgColor) => {
                        let sectionHtml = `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-4 overflow-hidden">
                                <div class="bg-gradient-to-r ${bgColor} px-4 py-3 border-b border-gray-200">
                                    <h4 class="text-sm font-bold text-gray-700 flex items-center space-x-2">
                                        <span>${icon}</span>
                                        <span>${title}</span>
                                    </h4>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="bg-gray-50">
                                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide sticky left-0 bg-gray-50 z-10 min-w-[120px]">Metric</th>`;
                        
                    dates.forEach(date => {
                            sectionHtml += `<th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide whitespace-nowrap">${date.split('-')[2]}/${date.split('-')[1]}</th>`;
                    });
                        
                        sectionHtml += `</tr></thead><tbody>`;
                    
                        metrics.forEach((m, idx) => {
                            const rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-25';
                            sectionHtml += `<tr class="${rowClass} hover:bg-blue-25 transition-colors">`;
                            sectionHtml += `<td class="px-4 py-2 text-sm font-medium text-gray-900 sticky left-0 ${rowClass} z-10">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs">${m.icon || 'ðŸ“ˆ'}</span>
                                    <span class="truncate">${m.label}</span>
                                </div>
                            </td>`;
                            
                        app.table.forEach(row => {
                            let val = row[m.key];
                            let display = '';
                                let cellClass = 'px-3 py-2 text-center text-sm';
                                
                                if (m.percent) {
                                    display = (typeof val === 'number' ? (val * 100).toFixed(m.decimals || 1) + '%' : '-');
                                    if (typeof val === 'number') {
                                        if (val > 0.1) cellClass += ' text-green-700 font-semibold bg-green-50';
                                        else if (val > 0.05) cellClass += ' text-yellow-700 font-semibold bg-yellow-50';
                                        else if (val > 0) cellClass += ' text-red-700 font-semibold bg-red-50';
                                        else cellClass += ' text-gray-500';
                                    } else {
                                        cellClass += ' text-gray-400';
                                    }
                                } else if (m.isNumber) {
                                    display = (val !== undefined && val > 0 ? Number(val).toLocaleString() : '-');
                                    cellClass += val > 0 ? ' text-gray-900 font-medium' : ' text-gray-400';
                                } else {
                                    display = (val !== undefined ? val : '-');
                                    cellClass += ' text-gray-700';
                                }
                                
                                sectionHtml += `<td class="${cellClass}">${display}</td>`;
                            });
                            sectionHtml += '</tr>';
                        });
                        
                        sectionHtml += '</tbody></table></div></div>';
                        return sectionHtml;
                    };
                    
                    // Group metrics by category
                    const trafficMetrics = [
                        { key: 'impressions', label: 'Impressions', isNumber: true, icon: 'ðŸ‘ï¸' },
                        { key: 'clicks', label: 'Clicks', isNumber: true, icon: 'ðŸ–±ï¸' },
                        { key: 'imp_to_click', label: 'CTR', percent: true, icon: 'ðŸ“Š' }
                    ];
                    
                    const conversionMetrics = [
                        { key: 'installs', label: 'Installs', isNumber: true, icon: 'ðŸ“±' },
                        { key: 'click_to_install', label: 'CVR', percent: true, decimals: 2, icon: 'ðŸŽ¯' }
                    ];
                    
                    const eventMetrics = [];
                    if (app.selected_events) {
                        app.selected_events.forEach(event => {
                            eventMetrics.push({ key: event, label: event, isNumber: true, icon: 'âš¡' });
                        });
                        if (app.selected_events[0]) {
                            eventMetrics.push({ key: 'install_to_' + app.selected_events[0], label: `Install â†’ ${app.selected_events[0]}`, percent: true, icon: 'ðŸ“ˆ' });
                        }
                        if (app.selected_events[0] && app.selected_events[1]) {
                            eventMetrics.push({ key: app.selected_events[0] + '_to_' + app.selected_events[1], label: `${app.selected_events[0]} â†’ ${app.selected_events[1]}`, percent: true, icon: 'ðŸ”—' });
                        }
                    }
                    
                    const fraudMetrics = [
                        { key: 'blocked_installs_rt', label: 'Blocked RT (Count)', isNumber: true, icon: 'ðŸ›¡ï¸' },
                        { key: 'blocked_rt_rate', label: 'Blocked RT (%)', percent: true, icon: 'ðŸ›¡ï¸' },
                        { key: 'blocked_installs_pa', label: 'Blocked PA (Count)', isNumber: true, icon: 'ðŸš«' },
                        { key: 'blocked_pa_rate', label: 'Blocked PA (%)', percent: true, icon: 'ðŸš«' }
                    ];
                    
                    // Compute extra % columns
                    app.table.forEach(row => {
                        if (app.selected_events && app.selected_events[0] && row.installs > 0 && row[app.selected_events[0]] !== undefined) {
                            row['install_to_' + app.selected_events[0]] = row[app.selected_events[0]] / row.installs;
                        }
                        if (app.selected_events && app.selected_events[0] && app.selected_events[1] && row[app.selected_events[0]] > 0 && row[app.selected_events[1]] !== undefined) {
                            row[app.selected_events[0] + '_to_' + app.selected_events[1]] = row[app.selected_events[1]] / row[app.selected_events[0]];
                        }
                    });
                    
                    // Header
                    tableContainer.innerHTML = `
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center space-x-2">
                                <span>ðŸ“Š</span>
                                <span>Performance Metrics</span>
                            </h3>
                            <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Last 10 Days</div>
                        </div>
                    `;

                    // Create organized sections
                    tableContainer.innerHTML += createMetricSection('Traffic & Engagement', 'ðŸš€', trafficMetrics, 'from-indigo-50 to-indigo-100');
                    tableContainer.innerHTML += createMetricSection('Conversions', 'ðŸŽ¯', conversionMetrics, 'from-emerald-50 to-emerald-100');
                    
                    if (eventMetrics.length > 0) {
                        tableContainer.innerHTML += createMetricSection('Events & Funnels', 'âš¡', eventMetrics, 'from-purple-50 to-purple-100');
                    }
                    
                    tableContainer.innerHTML += createMetricSection('Fraud Protection', 'ðŸ›¡ï¸', fraudMetrics, 'from-rose-50 to-rose-100');
                    
                    section.appendChild(tableContainer);

                    // Enhanced Charts Section
                    const chartsContainer = document.createElement('div');
                    chartsContainer.className = 'grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6';
                    
                    let safeName = app.app_name.replace(/\W/g, "");
                    let mainId = `trend-main-${app.app_id}-${safeName}-${range}`;
                    let eventsId = `trend-events-${app.app_id}-${safeName}-${range}`;
                    let fraudId = `trend-fraud-${app.app_id}-${safeName}-${range}`;

                    // Chart 1: Impressions & Clicks
                    const chart1 = document.createElement('div');
                    chart1.className = 'bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 shadow-lg';
                    chart1.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 flex items-center space-x-2">
                                <span>ðŸ“ˆ</span>
                                <span>Traffic Trend</span>
                            </h4>
                            <div class="flex space-x-2">
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="${mainId}" class="w-full h-full"></canvas>
                        </div>
                    `;
                    
                    // Chart 2: Installs & Events
                    const chart2 = document.createElement('div');
                    chart2.className = 'bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 shadow-lg';
                    chart2.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 flex items-center space-x-2">
                                <span>ðŸ“±</span>
                                <span>Conversions</span>
                            </h4>
                            <div class="flex space-x-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="${eventsId}" class="w-full h-full"></canvas>
                        </div>
                    `;
                    
                    // Chart 3: Fraud Detection
                    const chart3 = document.createElement('div');
                    chart3.className = 'bg-gradient-to-br from-red-50 to-pink-50 rounded-2xl p-6 shadow-lg';
                    chart3.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 flex items-center space-x-2">
                                <span>ðŸ›¡ï¸</span>
                                <span>Fraud Detection</span>
                            </h4>
                            <div class="flex space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-pink-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="${fraudId}" class="w-full h-full"></canvas>
                        </div>
                    `;
                    
                    chartsContainer.appendChild(chart1);
                    chartsContainer.appendChild(chart2);
                    chartsContainer.appendChild(chart3);
                    section.appendChild(chartsContainer);
                    
                    container.appendChild(section);

                    // Initialize enhanced charts after a small delay to ensure DOM is ready
                    setTimeout(() => {
                        // 1. Enhanced Impressions & Clicks Chart
                        renderChartWithRetry(mainId, (ctxMain) => {
                            new Chart(ctxMain, {
                                type: 'line',
                                data: {
                                    labels: dates,
                                    datasets: [
                                        {
                                            label: 'Impressions',
                                            data: app.table.map(r => r.impressions),
                                            borderColor: '#3b82f6',
                                            backgroundColor: 'rgba(59,130,246,0.1)',
                                            fill: true,
                                            tension: 0.4,
                                            borderWidth: 3,
                                            pointRadius: 4,
                                            pointHoverRadius: 6,
                                            pointBackgroundColor: '#3b82f6',
                                            pointBorderColor: '#ffffff',
                                            pointBorderWidth: 2
                                        },
                                        {
                                            label: 'Clicks',
                                            data: app.table.map(r => r.clicks),
                                            borderColor: '#f59e0b',
                                            backgroundColor: 'rgba(245,158,11,0.1)',
                                            fill: true,
                                            tension: 0.4,
                                            borderWidth: 3,
                                            pointRadius: 4,
                                            pointHoverRadius: 6,
                                            pointBackgroundColor: '#f59e0b',
                                            pointBorderColor: '#ffffff',
                                            pointBorderWidth: 2
                                        }
                                    ]
                                },
                                options: {
                                    plugins: { 
                                        legend: { 
                                            display: true, 
                                            position: 'bottom',
                                            labels: {
                                                usePointStyle: true,
                                                padding: 20,
                                                font: { size: 12, weight: 'bold' }
                                            }
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            backgroundColor: 'rgba(255,255,255,0.95)',
                                            titleColor: '#1f2937',
                                            bodyColor: '#1f2937',
                                            borderColor: '#e5e7eb',
                                            borderWidth: 1,
                                            cornerRadius: 8,
                                            callbacks: {
                                                label: function(context) {
                                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            display: true,
                                            grid: { display: false },
                                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 11 } }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            grid: { color: 'rgba(0,0,0,0.05)' },
                                            ticks: { callback: value => value.toLocaleString(), font: { size: 11 } }
                                        }
                                    },
                                    interaction: { intersect: false },
                                    responsive: true,
                                    maintainAspectRatio: false
                                }
                            });
                        });

                        // 2. Enhanced Installs & Events Chart
                        renderChartWithRetry(eventsId, (ctxEvents) => {
                            const datasets = [
                                {
                                    label: 'Installs',
                                    data: app.table.map(r => r.installs),
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16,185,129,0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 3,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointBackgroundColor: '#10b981',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2
                                }
                            ];

                            if (app.selected_events) {
                                app.selected_events.forEach((event, i) => {
                                    datasets.push({
                                        label: event,
                                        data: app.table.map(r => r[event] || 0),
                                        borderColor: i === 0 ? '#8b5cf6' : '#f59e0b',
                                        backgroundColor: i === 0 ? 'rgba(139,92,246,0.1)' : 'rgba(245,158,11,0.1)',
                                        fill: true,
                                        tension: 0.4,
                                        borderWidth: 3,
                                        pointRadius: 4,
                                        pointHoverRadius: 6,
                                        pointBackgroundColor: i === 0 ? '#8b5cf6' : '#f59e0b',
                                        pointBorderColor: '#ffffff',
                                        pointBorderWidth: 2
                                    });
                                });
                            }

                            new Chart(ctxEvents, {
                                type: 'line',
                                data: {
                                    labels: dates,
                                    datasets: datasets
                                },
                                options: {
                                    plugins: {
                                        legend: { 
                                            display: true, 
                                            position: 'bottom',
                                            labels: {
                                                usePointStyle: true,
                                                padding: 20,
                                                font: { size: 12, weight: 'bold' }
                                            }
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            backgroundColor: 'rgba(255,255,255,0.95)',
                                            titleColor: '#1f2937',
                                            bodyColor: '#1f2937',
                                            borderColor: '#e5e7eb',
                                            borderWidth: 1,
                                            cornerRadius: 8,
                                            callbacks: {
                                                label: function(context) {
                                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            display: true,
                                            grid: { display: false },
                                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 11 } }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            grid: { color: 'rgba(0,0,0,0.05)' },
                                            ticks: { callback: value => value.toLocaleString(), font: { size: 11 } }
                                        }
                                    },
                                    interaction: { intersect: false },
                                    responsive: true,
                                    maintainAspectRatio: false
                                }
                            });
                        });

                        // 3. Enhanced Fraud Detection Chart
                        renderChartWithRetry(fraudId, (ctxFraud) => {
                            new Chart(ctxFraud, {
                                type: 'line',
                                data: {
                                    labels: dates,
                                    datasets: [
                                        {
                                            label: 'Blocked Installs (RT)',
                                            data: app.table.map(r => r.blocked_installs_rt || 0),
                                            borderColor: '#dc2626',
                                            backgroundColor: 'rgba(220,38,38,0.1)',
                                            fill: true,
                                            tension: 0.4,
                                            borderWidth: 3,
                                            pointRadius: 4,
                                            pointHoverRadius: 6,
                                            pointBackgroundColor: '#dc2626',
                                            pointBorderColor: '#ffffff',
                                            pointBorderWidth: 2
                                        },
                                        {
                                            label: 'Blocked Installs (PA)',
                                            data: app.table.map(r => r.blocked_installs_pa || 0),
                                            borderColor: '#ec4899',
                                            backgroundColor: 'rgba(236,72,153,0.1)',
                                            fill: true,
                                            tension: 0.4,
                                            borderWidth: 3,
                                            pointRadius: 4,
                                            pointHoverRadius: 6,
                                            pointBackgroundColor: '#ec4899',
                                            pointBorderColor: '#ffffff',
                                            pointBorderWidth: 2
                                        }
                                    ]
                                },
                                options: {
                                    plugins: {
                                        legend: { 
                                            display: true, 
                                            position: 'bottom',
                                            labels: {
                                                usePointStyle: true,
                                                padding: 20,
                                                font: { size: 12, weight: 'bold' }
                                            }
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            backgroundColor: 'rgba(255,255,255,0.95)',
                                            titleColor: '#1f2937',
                                            bodyColor: '#1f2937',
                                            borderColor: '#e5e7eb',
                                            borderWidth: 1,
                                            cornerRadius: 8,
                                            callbacks: {
                                                label: function(context) {
                                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            display: true,
                                            grid: { display: false },
                                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 11 } }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            grid: { color: 'rgba(0,0,0,0.05)' },
                                            ticks: { callback: value => value.toLocaleString(), font: { size: 11 } }
                                        }
                                    },
                                    interaction: { intersect: false },
                                    responsive: true,
                                    maintainAspectRatio: false
                                }
                            });
                        });
                    }, 200);
                } else {
                    // Enhanced no data message
                    const noDataDiv = document.createElement('div');
                    noDataDiv.className = 'text-center py-8';
                    noDataDiv.innerHTML = `
                        <div class="bg-gray-100 rounded-xl p-6 max-w-sm mx-auto">
                            <div class="text-gray-600 text-base font-semibold mb-2">ðŸ“Š No Performance Data</div>
                            <div class="text-gray-500 text-sm">This app has no metrics to display for the selected period.</div>
                        </div>
                    `;
                    section.appendChild(noDataDiv);
                }
            });
        }

        function renderChartWithRetry(canvasId, renderFn, retries = 10) {
            const el = document.getElementById(canvasId);
            if (el && window.Chart) {
                try {
                    renderFn(el);
                } catch (e) {
                    console.error("Chart.js error for " + canvasId + ":", e);
                }
            } else if (retries > 0) {
                setTimeout(() => renderChartWithRetry(canvasId, renderFn, retries - 1), 100);
            } else {
                console.warn("Failed to render chart for", canvasId);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var btn10d = document.getElementById('get-stats-btn');
            if (btn10d) btn10d.addEventListener('click', function() { fetchAllAppsStats('last10'); });
        });

        // Patch fetchAllAppsStats to use static app and accept period
        function fetchAllAppsStats(period = 'last10') {
            const loading = document.getElementById('stats-loading');
            const error = document.getElementById('stats-error');
            const statsList = document.getElementById('stats-apps-list');
            const noApps = document.getElementById('stats-no-apps');
            
            if (!fetchedApps || fetchedApps.length === 0) {
                loading.style.display = 'none';
                error.style.display = 'none';
                statsList.style.display = 'none';
                noApps.style.display = 'block';
                return;
            }
            
            noApps.style.display = 'none';
            loading.style.display = 'block';
            error.style.display = 'none';
            statsList.style.display = 'none';
            
            let eventSelections = JSON.parse(localStorage.getItem('eventSelections') || '{}');
            let timer = 0;
            const timerElem = document.createElement('div');
            timerElem.className = 'text-center text-gray-400 mt-2';
            timerElem.textContent = 'Thinking... 0s';
            loading.appendChild(timerElem);
            
            const timerInterval = setInterval(() => {
                timer++;
                timerElem.textContent = `Thinking... ${timer}s`;
            }, 1000);
            
            fetch('/all-apps-stats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    apps: fetchedApps, 
                    period: period, 
                    selected_events: eventSelections 
                })
            })
                .then(r => r.json())
                .then(data => {
                    clearInterval(timerInterval);
                    loading.style.display = 'none';
                    if (data && data.apps && data.apps.length > 0) {
                        statsList.style.display = 'block';
                        renderStatsApps(data.apps);
                    } else {
                        error.textContent = 'No stats found.';
                        error.style.display = 'block';
                    }
                })
                .catch(e => {
                    clearInterval(timerInterval);
                    loading.style.display = 'none';
                    error.textContent = 'Error loading stats.';
                    error.style.display = 'block';
                });
        }

        // Store event selections in localStorage
        function saveEventSelection(appId, event1, event2, button, isActive) {
            const originalText = button.textContent;
            button.textContent = 'Saving...';
            button.disabled = true;
            
            fetch('/event-selections', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ app_id: appId, event1, event2, is_active: isActive })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.textContent = 'Saved!';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                    // Update localStorage
                    let selections = JSON.parse(localStorage.getItem('eventSelections') || '{}');
                    selections[appId] = [event1, event2];
                    localStorage.setItem('eventSelections', JSON.stringify(selections));
                } else {
                    button.textContent = 'Error!';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error saving event selection:', error);
                button.textContent = 'Error!';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            });
        }
        function getEventSelection(appId) {
            let selections = JSON.parse(localStorage.getItem('eventSelections') || '{}');
            return selections[appId] || [null, null];
        }
        function saveAllEventSelections() {
            const button = document.getElementById('save-all-events-btn');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'ðŸ’¾ Saving All Changes...';

            const selections = {};
            let totalApps = 0;
            let appsWithChanges = 0;
            
            // Collect all app data from the table
            document.querySelectorAll('#apps-list tr').forEach(tr => {
                const appId = tr.querySelector('.event1-dropdown')?.dataset.appId;
                if (appId) {
                    totalApps++;
                    const event1 = tr.querySelector('.event1-dropdown').value;
                    const event2 = tr.querySelector('.event2-dropdown').value;
                    const status = tr.querySelector('.status-dropdown').value;
                    const appName = tr.querySelector('td:nth-child(2) .text-sm').textContent;
                    
                    selections[appId] = {
                        event1: event1 || null,
                        event2: event2 || null,
                        is_active: status === 'active',
                        app_name: appName
                    };
                    
                    // Count apps with actual event configurations
                    if (event1 || event2) {
                        appsWithChanges++;
                    }
                }
            });

            console.log(`Saving configuration for ${totalApps} apps (${appsWithChanges} with events configured)`);

            fetch('/event-selections', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(selections)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.textContent = 'âœ… All Changes Saved!';
                    
                    // Update app objects and localStorage
                    const localSelections = {};
                    Object.entries(selections).forEach(([appId, appData]) => {
                        const app = window.fetchedApps.find(a => a.app_id === appId);
                        if (app) {
                            app.is_active = appData.is_active;
                            localSelections[appId] = [appData.event1, appData.event2];
                        }
                    });
                    localStorage.setItem('eventSelections', JSON.stringify(localSelections));
                    
                    // Show success popup
                    showSaveAllSuccessPopup(totalApps, appsWithChanges);
                    
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    }, 3000);
                } else {
                    button.textContent = 'âŒ Save Failed!';
                    showSaveAllErrorPopup(data.error || 'Unknown error occurred');
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error saving all:', error);
                button.textContent = 'âŒ Save Failed!';
                showSaveAllErrorPopup('Network error occurred');
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                }, 3000);
            });
        }

        // Function to show success popup
        function showSaveAllSuccessPopup(totalApps, appsWithChanges) {
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            popup.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 transform animate-pulse">
                    <div class="text-center">
                        <div class="mb-4">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">ðŸŽ‰ All Changes Saved!</h3>
                                                         <p class="text-gray-600 mb-4">Your app configurations have been successfully saved to the database.</p>
                             <div class="text-xs text-gray-500 mb-4">
                                 ðŸ’¡ <strong>Tip:</strong> Run <code>verifyDatabasePersistence()</code> in console to verify data persistence
                             </div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <div class="text-sm text-green-800">
                                    <div class="font-semibold mb-2">ðŸ“Š Save Summary:</div>
                                                                         <div class="space-y-1">
                                         <div>â€¢ Total Apps: <span class="font-bold">${totalApps}</span></div>
                                         <div>â€¢ Apps with Events: <span class="font-bold">${appsWithChanges}</span></div>
                                         <div>â€¢ Status: <span class="font-bold text-green-600">All Saved Successfully</span></div>
                                         <div>â€¢ Storage: <span class="font-bold text-green-600">ðŸ’¾ Permanent Database Storage</span></div>
                                         <div>â€¢ Persistence: <span class="font-bold text-blue-600">Forever (until overridden)</span></div>
                                     </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            Perfect! Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                }
            }, 10000);
        }

        // Function to show error popup
        function showSaveAllErrorPopup(errorMessage) {
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            popup.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4">
                    <div class="text-center">
                        <div class="mb-4">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">âŒ Save Failed</h3>
                            <p class="text-gray-600 mb-4">There was an error saving your changes. Please try again.</p>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                <div class="text-sm text-red-800">
                                    <div class="font-semibold mb-1">Error Details:</div>
                                    <div class="text-red-700">${errorMessage}</div>
                                </div>
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            Try Again
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                }
            }, 8000);
        }
        // Fetch events for an app
        function fetchEventsForApp(appId, callback) {
            fetch(`/app-events/${appId}`)
                .then(r => r.json())
                .then(data => {
                    let errorMsg = '';
                    if (data.response_content) {
                        errorMsg = String(data.response_content).replace(/\n/g, ' ').replace(/\r/g, '').trim();
                    } else if (data.error) {
                        errorMsg = String(data.error).replace(/\n/g, ' ').replace(/\r/g, '').trim();
                    }
                    if (errorMsg) {
                        callback([errorMsg], data.fetch_time || null, true, errorMsg);
                    } else {
                        callback(data.events || [], data.fetch_time || null, false, null);
                    }
                })
                .catch(() => {
                    callback(['Failed to load events'], null, true, 'Failed to load events');
                });
        }
        // Only fetch and populate event dropdowns when GET EVENTS is pressed
        function fetchAndRenderEventsForAllApps() {
            const appsList = document.getElementById('apps-list');
            const spinner = document.getElementById('get-events-spinner');
            const timerElem = document.getElementById('get-events-timer');
            const progressBar = document.querySelector('.progress-bar-fill');
            
            if (!window.fetchedApps || !window.fetchedApps.length) {
                alert('No apps loaded. Please click Get Apps first.');
                return;
            }
            
            spinner.style.display = 'inline-block';
            timerElem.textContent = '';
            if (progressBar) progressBar.style.width = '0%';
            
            let completed = 0;
            const total = window.fetchedApps.length;
            const batchSize = 2;
            let currentBatchIndex = 0;
            let startTime = Date.now();
            let failedApps = [];

            // Setup timer
            const timerInterval = setInterval(updateTimer, 1000);
            function updateTimer() {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timerElem.textContent = `${elapsed}s`;
            }

            // Process apps in batches
            function processBatch() {
                const currentBatch = window.fetchedApps.slice(currentBatchIndex, currentBatchIndex + batchSize);
                
                if (currentBatch.length === 0) {
                    // All batches completed
                    finishProcessing();
                    return;
                }

                console.log(`Processing batch ${currentBatchIndex/batchSize + 1} of ${Math.ceil(total/batchSize)}, ${completed}/${total} apps completed`);

                // Process each app in the current batch
                const batchPromises = currentBatch.map(app => {
                    return new Promise((resolve) => {
                        const tr = appsList.querySelector(`tr[data-app-id="${app.app_id}"]`);
                        if (!tr) {
                            console.log(`Row not found for app ${app.app_id}`);
                            resolve();
                            return;
                        }

                        const event1Input = tr.querySelector('.event1-dropdown');
                        const event2Input = tr.querySelector('.event2-dropdown');
                        const currentEvent1 = event1Input.value;
                        const currentEvent2 = event2Input.value;

                        fetchEventsForApp(app.app_id, function(events, fetchTime, isError, fullErrorMsg) {
                            try {
                                const event1List = tr.querySelector(`#event1-list-${app.app_id}`);
                                const event2List = tr.querySelector(`#event2-list-${app.app_id}`);
                                
                                if (isError && fullErrorMsg) {
                                    console.log(`Error fetching events for ${app.app_id}: ${fullErrorMsg}`);
                                    failedApps.push({ app_id: app.app_id, error: fullErrorMsg });
                                    const truncated = fullErrorMsg.length > 30 ? fullErrorMsg.slice(0, 30) + 'â€¦' : fullErrorMsg;
                                    event1List.innerHTML = `<option>${truncated}</option>`;
                                    event2List.innerHTML = `<option>${truncated}</option>`;
                                    event1Input.title = fullErrorMsg;
                                    event2Input.title = fullErrorMsg;
                                } else if (events.length === 0) {
                                    event1List.innerHTML = '<option>No Events Found.</option>';
                                    event2List.innerHTML = '<option>No Events Found.</option>';
                                    event1Input.title = '';
                                    event2Input.title = '';
                                } else {
                                    let allEvents = [...events];
                                    if (currentEvent1 && !events.includes(currentEvent1)) {
                                        allEvents.unshift(currentEvent1);
                                    }
                                    if (currentEvent2 && !events.includes(currentEvent2)) {
                                        allEvents.unshift(currentEvent2);
                                    }
                                    allEvents = [...new Set(allEvents)].sort();

                                    event1List.innerHTML = allEvents.map(ev => `<option value="${ev}">${ev}</option>`).join('');
                                    event2List.innerHTML = allEvents.map(ev => `<option value="${ev}">${ev}</option>`).join('');
                                    event1Input.title = '';
                                    event2Input.title = '';
                                }
                                
                                // Restore current values
                                event1Input.value = currentEvent1;
                                event2Input.value = currentEvent2;
                                
                            } catch (error) {
                                console.error(`Error processing events for ${app.app_id}:`, error);
                                failedApps.push({ app_id: app.app_id, error: error.message });
                            }
                            resolve();
                        });
                    });
                });

                // Wait for all apps in the batch to complete
                Promise.all(batchPromises).then(() => {
                    completed += currentBatch.length;
                    
                    // Update progress
                    if (progressBar) {
                        progressBar.style.width = `${(completed / total) * 100}%`;
                    }

                    // Move to next batch with delay
                    currentBatchIndex += batchSize;
                    if (currentBatchIndex < total) {
                        setTimeout(processBatch, 1000); // 1 second delay between batches
                    } else {
                        finishProcessing();
                    }
                });
            }

            function finishProcessing() {
                spinner.style.display = 'none';
                timerElem.textContent = '';
                clearInterval(timerInterval);
                
                if (progressBar) {
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                    }, 1000);
                }

                // Show summary of failed apps if any
                if (failedApps.length > 0) {
                    console.log('Failed apps:', failedApps);
                    const failedCount = failedApps.length;
                    const successCount = total - failedCount;
                    alert(`Events fetched for ${successCount} apps. Failed for ${failedCount} apps. Check console for details.`);
                }
            }

            // Start processing
            processBatch();
        }
        // Enhanced renderAppsList with new UI features
        function renderAppsList(apps) {
            const appsList = document.getElementById('apps-list');
            const emptyState = document.getElementById('apps-empty-state');
            
            if (!apps || apps.length === 0) {
                appsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                updateAppStatistics(0, 0, 0);
                return;
            }
            
            emptyState.classList.add('hidden');
            appsList.innerHTML = '';
            
            // Fetch saved event selections from the database
            fetch('/event-selections')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to fetch event selections:', data.error);
                        return;
                    }
                    
                    const selections = data.selections;
                    
                    apps.forEach((app, index) => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-app-id', app.app_id);
                        tr.className = 'apps-row transition-all duration-300 hover:bg-gradient-to-r hover:from-gray-50 hover:to-indigo-50';
                        
                        // Get saved selections for this app
                        const savedSelection = selections[app.app_id] || { event1: null, event2: null, is_active: false };
                        
                        // Status badge styling
                        const statusBadge = savedSelection.is_active ? 
                            '<span class="status-badge status-active">Active</span>' :
                            '<span class="status-badge status-inactive">Inactive</span>';
                        
                        // Event configuration indicators
                        const hasEvent1 = savedSelection.event1 && savedSelection.event1 !== '';
                        const hasEvent2 = savedSelection.event2 && savedSelection.event2 !== '';
                        const eventIndicator = hasEvent1 && hasEvent2 ? 
                            '<span class="text-emerald-600 font-semibold">âœ“ Configured</span>' : 
                            '<span class="text-amber-600 font-semibold">âš  Partial</span>';
                        
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <input type="checkbox" class="app-checkbox mr-3 h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500" data-app-id="${app.app_id}">
                                    <span class="font-mono text-sm font-medium text-gray-900 bg-gray-100 px-2 py-1 rounded">${app.app_id}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">${app.app_name}</div>
                                        <div class="text-sm text-gray-500">${eventIndicator}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative">
                                    <select class="status-dropdown px-4 py-2 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-800 text-sm transition-all duration-300" data-app-id="${app.app_id}">
                                        <option value="active" ${savedSelection.is_active ? 'selected' : ''}>Active</option>
                                        <option value="not_active" ${!savedSelection.is_active ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative">
                                    <input list="event1-list-${app.app_id}" class="event1-dropdown event-input w-full ${hasEvent1 ? 'configured' : ''}" data-app-id="${app.app_id}" placeholder="Select event 1..." value="${savedSelection.event1 || ''}">
                                    <datalist id="event1-list-${app.app_id}">
                                        <option>No Events Found.</option>
                                    </datalist>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative">
                                    <input list="event2-list-${app.app_id}" class="event2-dropdown event-input w-full ${hasEvent2 ? 'configured' : ''}" data-app-id="${app.app_id}" placeholder="Select event 2..." value="${savedSelection.event2 || ''}">
                                    <datalist id="event2-list-${app.app_id}">
                                        <option>No Events Found.</option>
                                    </datalist>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button class="event-save-btn action-button btn-primary" data-app-id="${app.app_id}">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                                    </svg>
                                    Save
                                </button>
                            </td>
                        `;
                        appsList.appendChild(tr);
                        
                        // Add status change handler
                        const statusDropdown = tr.querySelector('.status-dropdown');
                        statusDropdown.addEventListener('change', function() {
                            const appId = this.dataset.appId;
                            const isActive = this.value === 'active';
                            updateAppActiveStatus(appId, isActive);
                            updateAppStatistics();
                        });
                        
                        // Add event input change handlers
                        const event1Input = tr.querySelector('.event1-dropdown');
                        const event2Input = tr.querySelector('.event2-dropdown');
                        
                        event1Input.addEventListener('input', function() {
                            this.classList.toggle('configured', this.value !== '');
                            updateAppStatistics();
                        });
                        
                        event2Input.addEventListener('input', function() {
                            this.classList.toggle('configured', this.value !== '');
                            updateAppStatistics();
                        });
                        
                        // Save button handler
                        tr.querySelector('.event-save-btn').onclick = function() {
                            const event1 = tr.querySelector('.event1-dropdown').value;
                            const event2 = tr.querySelector('.event2-dropdown').value;
                            const status = statusDropdown.value;
                            const button = this;
                            const originalText = button.innerHTML;
                            
                            button.disabled = true;
                            button.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Saving...';
                            
                            fetch('/event-selections', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    app_id: app.app_id, 
                                    event1: event1 || null, 
                                    event2: event2 || null, 
                                    is_active: status === 'active' 
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    button.innerHTML = '<svg class="w-4 h-4 inline mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Saved!';
                                    setTimeout(() => {
                                        button.disabled = false;
                                        button.innerHTML = originalText;
                                    }, 2000);
                                } else {
                                    button.innerHTML = '<svg class="w-4 h-4 inline mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>Error!';
                                    setTimeout(() => {
                                        button.disabled = false;
                                        button.innerHTML = originalText;
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.error('Error saving:', error);
                                button.innerHTML = '<svg class="w-4 h-4 inline mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>Error!';
                                setTimeout(() => {
                                    button.disabled = false;
                                    button.innerHTML = originalText;
                                }, 2000);
                            });
                        };
                    });
                    
                    // Update statistics
                    updateAppStatistics();
                    
                    // Setup search and filter functionality
                    setupSearchAndFilters();
                })
                .catch(error => {
                    console.error('Error fetching event selections:', error);
                });
        }
        
        // Update app statistics in the stats cards
        function updateAppStatistics() {
            const totalApps = window.fetchedApps ? window.fetchedApps.length : 0;
            let activeApps = 0;
            let configuredApps = 0;
            
            document.querySelectorAll('#apps-list tr').forEach(row => {
                const statusSelect = row.querySelector('.status-dropdown');
                const event1Input = row.querySelector('.event1-dropdown');
                const event2Input = row.querySelector('.event2-dropdown');
                
                if (statusSelect && statusSelect.value === 'active') {
                    activeApps++;
                }
                
                if (event1Input && event2Input && event1Input.value && event2Input.value) {
                    configuredApps++;
                }
            });
            
            // Update the stats cards
            document.getElementById('app-count').textContent = totalApps;
            document.getElementById('active-app-count').textContent = activeApps;
            document.getElementById('configured-app-count').textContent = configuredApps;
            
            // Update last sync time
            const lastUpdated = document.getElementById('apps-last-updated').textContent;
            if (lastUpdated) {
                const timestamp = lastUpdated.replace(/[()]/g, '').replace('Last updated: ', '');
                document.getElementById('last-sync-time').textContent = timestamp || 'Never';
                document.getElementById('apps-timestamp').textContent = timestamp || 'Never';
            }
        }
        
        // Setup search and filter functionality
        function setupSearchAndFilters() {
            const searchInput = document.getElementById('search-apps');
            const statusFilter = document.getElementById('status-filter');
            const toggleViewBtn = document.getElementById('toggle-view-btn');
            
            // Search functionality
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                filterApps(query, statusFilter.value);
            });
            
            // Status filter functionality
            statusFilter.addEventListener('change', function() {
                const query = searchInput.value.toLowerCase();
                filterApps(query, this.value);
            });
            
            // Toggle view functionality (placeholder for future card view)
            toggleViewBtn.addEventListener('click', function() {
                // Future: toggle between table and card view
                console.log('View toggle clicked - feature coming soon!');
            });
        }
        
        // Filter apps based on search and status
        function filterApps(searchQuery, statusFilter) {
            const rows = document.querySelectorAll('#apps-list tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const appId = row.querySelector('td:first-child .font-mono').textContent;
                const appName = row.querySelector('td:nth-child(2) .text-sm').textContent;
                const status = row.querySelector('.status-dropdown').value;
                
                const matchesSearch = !searchQuery || 
                    appId.toLowerCase().includes(searchQuery) || 
                    appName.toLowerCase().includes(searchQuery);
                
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'active' && status === 'active') ||
                    (statusFilter === 'inactive' && status === 'not_active');
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                    visibleCount++;
                    
                    // Highlight search matches
                    if (searchQuery) {
                        highlightText(row, searchQuery);
                    } else {
                        removeHighlight(row);
                    }
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show/hide empty state
            const emptyState = document.getElementById('apps-empty-state');
            if (visibleCount === 0) {
                emptyState.classList.remove('hidden');
                emptyState.querySelector('h3').textContent = 'No matching apps found';
                emptyState.querySelector('p').textContent = 'Try adjusting your search or filter criteria';
            } else {
                emptyState.classList.add('hidden');
            }
        }
        
        // Highlight search text
        function highlightText(row, query) {
            const textElements = row.querySelectorAll('td:first-child .font-mono, td:nth-child(2) .text-sm');
            textElements.forEach(element => {
                const text = element.textContent;
                const regex = new RegExp(`(${query})`, 'gi');
                element.innerHTML = text.replace(regex, '<span class="search-highlight">$1</span>');
            });
        }
        
        // Remove search highlighting
        function removeHighlight(row) {
            const highlightedElements = row.querySelectorAll('.search-highlight');
            highlightedElements.forEach(element => {
                element.outerHTML = element.textContent;
            });
        }
        
        // Enhanced bulk actions
        document.addEventListener('DOMContentLoaded', function() {
            // Select all functionality
            const selectAllBtn = document.getElementById('select-all-btn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.app-checkbox');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = !allChecked;
                        checkbox.closest('tr').classList.toggle('selected', !allChecked);
                    });
                    
                    this.textContent = allChecked ? 'Select All' : 'Deselect All';
                });
            }
            
            // Bulk activate functionality
            const bulkActivateBtn = document.getElementById('bulk-activate-btn');
            if (bulkActivateBtn) {
                bulkActivateBtn.addEventListener('click', function() {
                    const selectedCheckboxes = document.querySelectorAll('.app-checkbox:checked');
                    if (selectedCheckboxes.length === 0) {
                        alert('Please select apps to activate');
                        return;
                    }
                    
                    selectedCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        const statusSelect = row.querySelector('.status-dropdown');
                        statusSelect.value = 'active';
                        statusSelect.dispatchEvent(new Event('change'));
                    });
                    
                    alert(`${selectedCheckboxes.length} apps activated successfully!`);
                });
            }
        });
        // GET EVENTS button handler
        document.getElementById('get-events-btn').onclick = function() {
            if (!window.fetchedApps || !window.fetchedApps.length) {
                alert('No apps loaded. Please click Get Apps first.');
                return;
            }
            fetchAndRenderEventsForAllApps();
        };
        // Save all button handler
        document.getElementById('save-all-events-btn').onclick = saveAllEventSelections;

        // Masking logic per requirements
        function maskApiKey(val) {
            if (!val) return 'N/A';
            if (val.length <= 4) return val[0] + '******';
            return val.slice(0, 4) + '******';
        }
        function maskPassword(val) {
            return 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        }
        function showEdit(field) {
            document.getElementById(field).style.display = 'none';
            document.getElementById(field+'-edit').style.display = '';
            document.getElementById(field+'-input').value = '';
        }
        function hideEdit(field, value) {
            document.getElementById(field+'-edit').style.display = 'none';
            document.getElementById(field).style.display = '';
            if (value !== undefined) {
                if (field === 'api-key') document.getElementById(field).textContent = maskApiKey(value);
                else if (field === 'user-password') document.getElementById(field).textContent = maskPassword(value);
                else if (field === 'user-email') document.getElementById(field).textContent = value;
            }
        }
        function loadProfile() {
            // Always set Agency Name from localStorage
            document.getElementById('agency-name').textContent = localStorage.getItem('agencyName') || 'N/A';
            fetch('/profile-info')
                .then(r => r.json())
                .then(data => {
                    // Do NOT overwrite agency-name from backend
                    document.getElementById('api-key').textContent = maskApiKey(data.api_key);
                    document.getElementById('user-email').textContent = data.email || 'N/A';
                    document.getElementById('user-password').textContent = maskPassword(data.password);
                    // Store last values for persistence
                    window._profileLast = {
                        api_key: data.api_key,
                        email: data.email,
                        password: data.password
                    };
                })
                .catch(() => {
                    document.getElementById('api-key').textContent = 'N/A';
                    document.getElementById('user-email').textContent = 'N/A';
                    document.getElementById('user-password').textContent = maskPassword('');
                });
        }
        // Load profile info when Profile tab is shown
        const origSwitchTab = switchTab;
        switchTab = function(tabName) {
            origSwitchTab(tabName);
            if (tabName === 'profile') loadProfile();
        };
        document.getElementById('edit-api-key-btn').onclick = function() { showEdit('api-key'); };
        document.getElementById('cancel-api-key-btn').onclick = function() { hideEdit('api-key', window._profileLast ? window._profileLast.api_key : undefined); };
        document.getElementById('save-api-key-btn').onclick = function() {
            const val = document.getElementById('api-key-input').value.trim();
            const button = this;
            const originalText = button.innerHTML;
            
            if (!val) {
                showCredentialToast('API key cannot be empty', 'error');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span class="ml-2">Saving...</span>';
            
            fetch('/update-credential', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'APPSFLYER_API_KEY', value: val })
            })
            .then(r => r.json())
            .then(data => { 
                if (data.success) { 
                    window._profileLast.api_key = val; 
                    hideEdit('api-key', val);
                    showCredentialToast('API key saved successfully to .env.local', 'success');
                    console.log('[PROFILE] API key updated:', data.file_path);
                } else {
                    showCredentialToast(data.error || 'Failed to save API key', 'error');
                }
            })
            .catch(error => {
                console.error('[PROFILE] Error saving API key:', error);
                showCredentialToast('Network error while saving API key', 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
        };
        document.getElementById('edit-user-email-btn').onclick = function() { showEdit('user-email'); };
        document.getElementById('cancel-user-email-btn').onclick = function() { hideEdit('user-email', window._profileLast ? window._profileLast.email : undefined); };
        document.getElementById('save-user-email-btn').onclick = function() {
            const val = document.getElementById('user-email-input').value.trim();
            const button = this;
            const originalText = button.innerHTML;
            
            if (!val) {
                showCredentialToast('Email cannot be empty', 'error');
                return;
            }
            
            if (!val.includes('@')) {
                showCredentialToast('Please enter a valid email address', 'error');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span class="ml-2">Saving...</span>';
            
            fetch('/update-credential', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'EMAIL', value: val })
            })
            .then(r => r.json())
            .then(data => { 
                if (data.success) { 
                    window._profileLast.email = val; 
                    hideEdit('user-email', val);
                    showCredentialToast('Email saved successfully to .env.local', 'success');
                    console.log('[PROFILE] Email updated:', data.file_path);
                } else {
                    showCredentialToast(data.error || 'Failed to save email', 'error');
                }
            })
            .catch(error => {
                console.error('[PROFILE] Error saving email:', error);
                showCredentialToast('Network error while saving email', 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
        };
        document.getElementById('edit-user-password-btn').onclick = function() { showEdit('user-password'); };
        document.getElementById('cancel-user-password-btn').onclick = function() { hideEdit('user-password', window._profileLast ? window._profileLast.password : undefined); };
        document.getElementById('save-user-password-btn').onclick = function() {
            const val = document.getElementById('user-password-input').value;
            const button = this;
            const originalText = button.innerHTML;
            
            if (!val) {
                showCredentialToast('Password cannot be empty', 'error');
                return;
            }
            
            if (val.length < 4) {
                showCredentialToast('Password must be at least 4 characters', 'error');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span class="ml-2">Saving...</span>';
            
            fetch('/update-credential', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'PASSWORD', value: val })
            })
            .then(r => r.json())
            .then(data => { 
                if (data.success) { 
                    window._profileLast.password = val; 
                    hideEdit('user-password', val);
                    showCredentialToast('Password saved successfully to .env.local', 'success');
                    console.log('[PROFILE] Password updated:', data.file_path);
                } else {
                    showCredentialToast(data.error || 'Failed to save password', 'error');
                }
            })
            .catch(error => {
                console.error('[PROFILE] Error saving password:', error);
                showCredentialToast('Network error while saving password', 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
        };
        // Agency Account edit logic (localStorage persistence)
        function showEditAgency() {
            document.getElementById('agency-name').style.display = 'none';
            document.getElementById('edit-agency-btn').style.display = 'none';
            document.getElementById('agency-edit').style.display = '';
            document.getElementById('agency-input').value = localStorage.getItem('agencyName') || '';
        }
        function hideEditAgency(value) {
            document.getElementById('agency-edit').style.display = 'none';
            document.getElementById('agency-name').style.display = '';
            document.getElementById('edit-agency-btn').style.display = '';
            if (value !== undefined) {
                document.getElementById('agency-name').textContent = value;
                localStorage.setItem('agencyName', value);
            }
        }
        document.getElementById('edit-agency-btn').onclick = showEditAgency;
        document.getElementById('cancel-agency-btn').onclick = function() { hideEditAgency(localStorage.getItem('agencyName') || 'N/A'); };
        document.getElementById('save-agency-btn').onclick = function() {
            const val = document.getElementById('agency-input').value;
            hideEditAgency(val);
        };

        // --- Enhanced Fraud Tab Logic (10d only) ---
        let fraudDataCache = { '10d': null };
        
                // Initialize fraud protection on load
        function initializeFraudAnalytics() {
            // Populate fraud source filter with fetched apps (analytics filter removed)
            populateFraudFilters();
            
            // Load cached data on page load
            fetch('/get_fraud_subpage_10d')
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.apps && data.apps.length > 0) {
                        renderFraudAll(data, '10d');
                            document.getElementById('fraud-error').style.display = 'none';
                        } else {
                        document.getElementById('fraud-data-10d').innerHTML = '<div class="text-center py-8"><div class="bg-indigo-50 rounded-xl p-6 border border-indigo-200"><div class="text-indigo-600 font-semibold mb-2">ðŸ›¡ï¸ No Fraud Data</div><div class="text-indigo-500 text-sm">Please run a report to view fraud protection.</div></div></div>';
                        }
                    })
                    .catch(() => {
                    document.getElementById('fraud-data-10d').innerHTML = '<div class="text-center py-8"><div class="bg-red-100 rounded-xl p-6 border border-red-200"><div class="text-red-600 font-semibold mb-2">âš ï¸ Error Loading Data</div><div class="text-red-500 text-sm">Please try again later.</div></div></div>';
                    });
            }
        
        // Populate fraud source filter only (analytics filter removed)
        function populateFraudFilters() {
            if (!window.fetchedApps) return;
            
            // Populate source filter only
            const sourceFilter = document.getElementById('fraud-source-app-filter');
            if (sourceFilter) {
                sourceFilter.innerHTML = '<option value="" style="color: #1f2937; background-color: white; font-weight: 600; padding: 8px 12px;">ðŸŽ¯ Choose a campaign to analyze sources</option>';
                window.fetchedApps.forEach(app => {
                    const option = document.createElement('option');
                    option.value = app.app_id;
                    option.style.color = '#1f2937';
                    option.style.backgroundColor = 'white';
                    option.style.fontWeight = '600';
                    option.style.padding = '8px 12px';
                    option.textContent = `ðŸ“± ${app.app_name} (${app.app_id})`;
                    sourceFilter.appendChild(option);
                });
            }
        }
        
        // Enhanced sub-tab switching with header controls
        window.switchFraudSubTab = function(subtab) {
            // Update tab buttons
            const analyticsBtn = document.getElementById('fraud-analytics-tab-btn');
            const sourceBtn = document.getElementById('fraud-source-tab-btn');
            const analyticsControls = document.getElementById('fraud-analytics-controls');
            const sourceControls = document.getElementById('fraud-source-controls');
            
            if (subtab === 'analytics') {
                analyticsBtn.classList.remove('bg-white/10', 'text-white/70', 'border-white/20');
                analyticsBtn.classList.add('bg-white/20', 'text-white', 'border-white/30');
                sourceBtn.classList.remove('bg-white/20', 'text-white', 'border-white/30');
                sourceBtn.classList.add('bg-white/10', 'text-white/70', 'border-white/20');
                
                // Show/hide appropriate controls
                analyticsControls.style.display = 'flex';
                sourceControls.style.display = 'none';
                
                document.getElementById('fraud-analytics-subtab').style.display = '';
                document.getElementById('fraud-source-subtab').style.display = 'none';
                
                // Load analytics data if needed
                initializeFraudAnalytics();
            } else if (subtab === 'source') {
                sourceBtn.classList.remove('bg-white/10', 'text-white/70', 'border-white/20');
                sourceBtn.classList.add('bg-white/20', 'text-white', 'border-white/30');
                analyticsBtn.classList.remove('bg-white/20', 'text-white', 'border-white/30');
                analyticsBtn.classList.add('bg-white/10', 'text-white/70', 'border-white/20');
                
                // Show/hide appropriate controls
                analyticsControls.style.display = 'none';
                sourceControls.style.display = 'flex';
                
                document.getElementById('fraud-analytics-subtab').style.display = 'none';
                document.getElementById('fraud-source-subtab').style.display = '';
                
                // Initialize fraud source if needed
                initializeFraudSource();
            }
        };
        
        // Initialize fraud protection by default
        initializeFraudAnalytics();
        
                // Analytics RUN button logic - analyzes all apps (no filtering)
        document.getElementById('run-fraud-10d-btn').onclick = function() {
            // Prevent concurrent calls
            if (isFetchingFraudReport) {
                console.log('Fraud report already in progress, skipping...');
                return;
            }
            
            if (!window.fetchedApps || !window.fetchedApps.length) {
                alert('No apps loaded. Please go to Apps tab and click Get Apps first.');
                return;
            }
            
            isFetchingFraudReport = true;
            
            // Failsafe timer to ensure loading state is always hidden
            const fraudFailsafeTimer = setTimeout(() => {
                console.warn('Fraud report failsafe timer triggered - forcing loading state to close');
                completeFraudReport(null, 'Timeout - please try again');
            }, 900000); // 15 minutes failsafe
            
            // Helper function to complete the fraud report
            function completeFraudReport(result, error) {
                clearTimeout(fraudFailsafeTimer);
                isFetchingFraudReport = false;
                
                if (result) {
                    // Success - complete the progress
                    updateFraudReportProgress(100, 'Complete!', 'Security analysis completed successfully!');
                    
                    setTimeout(() => {
                        hideFraudReportLoadingState();
                        
                        // Save and render data for both Analytics and Source tabs
                        fraudDataCache['10d'] = result;
                        fraudSourceDataCache['10d'] = result;  // Also update source cache
                        renderFraudAll(result, '10d');
                        
                        console.log('âœ… Fraud data cached for both Analytics and Source tabs:', result.apps.length, 'apps');
                        
                        // Comprehensive data refresh
                        setTimeout(() => {
                            refreshAllDashboardData();
                        }, 100);
                        
                        showFraudSuccessToast('Fraud protection analysis completed!');
                        console.log('Fraud report completed successfully');
                    }, 1500); // Give time to show completion
                } else {
                    // Error or timeout
                    hideFraudReportLoadingState();
                    document.getElementById('fraud-error').style.display = '';
                    showFraudErrorToast(error || 'Error during fraud analysis');
                    console.error('Fraud report failed:', error);
                }
            }
            
            // Helper function to reset fraud report state (legacy compatibility)
            function resetFraudReportState() {
                isFetchingFraudReport = false;
                hideFraudReportLoadingState();
            }
            
            // Analyze all available apps
            let appsToAnalyze = window.fetchedApps;
            
            // Show beautiful loading state
            showFraudReportLoadingState();
            
                fetch('/get_fraud', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                    apps: appsToAnalyze,
                    period: 'last10'
                    })
                })
                .then(r => {
                    if (!r.ok) {
                        if (r.status === 504) {
                        updateFraudReportProgress(85, 'Timeout occurred...', 'Request timed out, but analysis may still be processing...');
                        setTimeout(() => {
                            completeFraudReport(null, 'Request timed out. Please try again.');
                        }, 3000);
                            return;
                        }
                    completeFraudReport(null, 'Error occurred during fraud analysis.');
                        return;
                    }
                    return r.text();
                })
                .then(text => {
                if (!text) return;
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                    completeFraudReport(null, 'Error parsing response data.');
                        return;
                    }
                    if (data.status === 'processing') {
                    updateFraudReportProgress(90, 'Data is being processed...', 'Almost ready! Security analysis in progress...');
                    setTimeout(() => {
                        completeFraudReport(null, 'Analysis is being processed. Please try again in a few minutes.');
                    }, 2000);
                    // Auto-retry after 30 seconds for processing status
                    setTimeout(() => {
                        if (!isFetchingFraudReport) {
                            document.getElementById('run-fraud-10d-btn').click();
                        }
                    }, 30000);
                        return;
                    }
                
                // Success - data is ready
                completeFraudReport(data);
                })
                .catch((error) => {
                console.error('Error in fraud analysis:', error);
                completeFraudReport(null, 'Error during fraud analysis. Please try again.');
                });
            };
        
        // Analytics filter removed - no longer needed
        // Force refresh fraud data by clearing cache and fetching fresh data
        function forceRefreshFraudData() {
            showToast('info', 'Force refreshing fraud data...');
            
            // Clear the fraud cache on the backend
            fetch('/clear-fraud-cache', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(() => {
                // Clear local cache
                fraudDataCache = { '10d': null };
                fraudSourceDataCache = { '10d': null };
                
                // Trigger fresh data fetch
                setTimeout(() => {
                    document.getElementById('run-fraud-10d-btn').click();
                    showToast('success', 'Fraud cache cleared. Fetching fresh data...');
                }, 500);
            })
            .catch(error => {
                console.error('Error clearing fraud cache:', error);
                showToast('error', 'Error clearing cache. Please try again.');
            });
        }
        
        function renderFraudAll(data, range) {
            const container = document.getElementById(`fraud-data-${range}`);
            container.innerHTML = '';
            
            if (data.error) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-8 max-w-md mx-auto">
                            <div class="text-red-600 text-lg font-semibold mb-2">âš ï¸ Error Loading Data</div>
                            <div class="text-red-500 text-sm">${data.error}</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (!data.apps || data.apps.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="bg-gray-100 rounded-2xl p-8 max-w-md mx-auto">
                            <div class="text-gray-600 text-lg font-semibold mb-2">ðŸ›¡ï¸ No Fraud Data</div>
                            <div class="text-gray-500 text-sm">No fraud data available for this period.</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // --- Enhanced Fraud Protection Overview ---
            const overviewSection = document.createElement('div');
            overviewSection.className = 'bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-2xl p-8 mb-8 shadow-lg';
            
            const overviewHeader = document.createElement('div');
            overviewHeader.className = 'flex items-center justify-between mb-6';
            overviewHeader.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-500 p-3 rounded-xl">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-indigo-700 to-purple-700 bg-clip-text text-transparent">Protection Analytics</h3>
                        <p class="text-gray-600 text-sm mt-1">Total Fraud - All campaigns</p>
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm px-4 py-2 rounded-xl border border-indigo-200">
                    <div class="flex items-center space-x-2 text-indigo-700">
                        <span class="text-sm font-semibold">${data.apps.length}</span>
                        <span class="text-xs">Campaign${data.apps.length > 1 ? 's' : ''}</span>
                    </div>
                </div>
            `;
            overviewSection.appendChild(overviewHeader);
            
            // Enhanced metrics grid with professional blue/purple theme
            const metrics = [
                { key: 'blocked_installs_rt', label: 'Blocked Installs (RT)', color: '#3b82f6', bg: 'rgba(59,130,246,0.1)', icon: 'ðŸš«' },
                { key: 'blocked_installs_pa', label: 'Blocked Installs (PA)', color: '#8b5cf6', bg: 'rgba(139,92,246,0.1)', icon: 'ðŸ”' },
                { key: 'blocked_in_app_events', label: 'Blocked In-App Events', color: '#06b6d4', bg: 'rgba(6,182,212,0.1)', icon: 'âš¡' },
                { key: 'fraud_post_inapps', label: 'Fraud Post-InApps', color: '#10b981', bg: 'rgba(16,185,129,0.1)', icon: 'ðŸŽ¯' },
                { key: 'blocked_clicks', label: 'Blocked Clicks', color: '#6366f1', bg: 'rgba(99,102,241,0.1)', icon: 'ðŸ‘†' },
                { key: 'blocked_install_postbacks', label: 'Blocked Install Postbacks', color: '#ec4899', bg: 'rgba(236,72,153,0.1)', icon: 'ðŸ“¡' }
            ];
            
            // Calculate totals across all apps
            const totals = {};
            const dateMap = {};
            data.apps.forEach(app => {
                (app.table || []).forEach(row => {
                    if (!dateMap[row.date]) {
                        dateMap[row.date] = {
                            blocked_installs_rt: 0, blocked_installs_pa: 0, blocked_in_app_events: 0,
                            fraud_post_inapps: 0, blocked_clicks: 0, blocked_install_postbacks: 0
                        };
                    }
                    metrics.forEach(metric => {
                        const value = row[metric.key] || 0;
                        dateMap[row.date][metric.key] += value;
                        totals[metric.key] = (totals[metric.key] || 0) + value;
                });
            });
            });
            
            // Debug: Log the calculated totals
            console.log('ðŸ” Fraud Analytics - Calculated Totals:');
            console.log('ðŸ“Š Blocked Installs (RT):', totals.blocked_installs_rt || 0);
            console.log('ðŸ“Š Blocked Installs (PA):', totals.blocked_installs_pa || 0);
            console.log('ðŸ“Š Blocked In-App Events:', totals.blocked_in_app_events || 0);
            console.log('ðŸ“Š Fraud Post-InApps:', totals.fraud_post_inapps || 0);
            console.log('ðŸ“Š Blocked Clicks:', totals.blocked_clicks || 0);
            console.log('ðŸ“Š Install Postbacks:', totals.blocked_install_postbacks || 0);
            console.log('ðŸ“Š Total apps processed:', data.apps.length);
            console.log('ðŸ“Š Total data rows:', data.apps.reduce((sum, app) => sum + (app.table || []).length, 0));
            
            // Generate complete date range for last 10 days to include dates with 0 data
            const today = new Date();
            const allDates = [];
            for (let i = 9; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                allDates.push(date.toISOString().split('T')[0]);
            }
            
            // Fill in missing dates with zero values
            allDates.forEach(date => {
                if (!dateMap[date]) {
                    dateMap[date] = {
                        blocked_installs_rt: 0, blocked_installs_pa: 0, blocked_in_app_events: 0,
                        fraud_post_inapps: 0, blocked_clicks: 0, blocked_install_postbacks: 0
                    };
                }
            });
            
            const dates = allDates;
            
            // Enhanced charts grid with modern design
            const chartsGrid = document.createElement('div');
            chartsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            
            metrics.forEach((metric, i) => {
                const chartCard = document.createElement('div');
                chartCard.className = 'bg-white/90 backdrop-blur-sm rounded-xl p-6 border border-indigo-100 shadow-sm hover:shadow-lg transition-all duration-200 hover:scale-[1.02]';
                chartCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 rounded-lg" style="background: ${metric.bg}">
                                <div class="text-lg">${metric.icon}</div>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-700 text-sm">${metric.label}</div>
                                <div class="text-2xl font-bold" style="color: ${metric.color}">${(totals[metric.key] || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    <canvas id='fraudTrendsAllApps-${metric.key}-${range}' height='120' width='300'></canvas>
                `;
                chartsGrid.appendChild(chartCard);
            });
            
            overviewSection.appendChild(chartsGrid);
            container.appendChild(overviewSection);
            
            // Render enhanced charts
            setTimeout(() => {
                metrics.forEach((metric, i) => {
                    const ctx = document.getElementById(`fraudTrendsAllApps-${metric.key}-${range}`);
                    if (ctx && window.Chart) {
                        if (window._chartInstances[`fraudTrendsAllApps-${metric.key}-${range}`]) {
                            window._chartInstances[`fraudTrendsAllApps-${metric.key}-${range}`].destroy();
                        }
                        window._chartInstances[`fraudTrendsAllApps-${metric.key}-${range}`] = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: metric.label,
                                    data: dates.map(d => dateMap[d][metric.key]),
                                    borderColor: metric.color,
                                    backgroundColor: metric.bg,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointBackgroundColor: metric.color,
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    borderWidth: 3
                                }]
                            },
                            options: {
                                responsive: false,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                        titleColor: '#1f2937',
                                        bodyColor: '#1f2937',
                                        borderColor: '#e5e7eb',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        displayColors: false
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: { display: false },
                                        ticks: { color: '#6b7280', font: { size: 10 } }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        display: true,
                                        grid: { color: '#f3f4f6', borderDash: [2, 2] },
                                        ticks: { color: '#6b7280', font: { size: 10 }, precision: 0 }
                                    }
                                }
                            }
                        });
                    }
                });
            }, 100);
            
            // --- Sort apps by total fraud amount (highest to lowest) ---
            const fraudMetricKeys = ['blocked_installs_rt', 'blocked_installs_pa', 'blocked_in_app_events', 'fraud_post_inapps', 'blocked_clicks', 'blocked_install_postbacks'];
            const sortedApps = [...data.apps].sort((a, b) => {
                const totalA = (a.table || []).reduce((sum, row) => 
                    sum + fraudMetricKeys.reduce((metricSum, key) => metricSum + (row[key] || 0), 0), 0);
                const totalB = (b.table || []).reduce((sum, row) => 
                    sum + fraudMetricKeys.reduce((metricSum, key) => metricSum + (row[key] || 0), 0), 0);
                return totalB - totalA; // Descending order
            });
            
            // --- Enhanced Per-App Sections ---
            sortedApps.forEach((app, idx) => {
                // Calculate total fraud for ranking display
                const totalFraud = (app.table || []).reduce((sum, row) => 
                    sum + fraudMetricKeys.reduce((metricSum, key) => metricSum + (row[key] || 0), 0), 0);
                
                const appSection = document.createElement('div');
                appSection.className = 'bg-white rounded-2xl shadow-xl border border-indigo-100 overflow-hidden mb-8 hover:shadow-2xl transition-all duration-300';
                
                // Enhanced App header with ranking
                const headerDiv = document.createElement('div');
                headerDiv.className = 'bg-gradient-to-r from-indigo-500 to-purple-600 px-8 py-6 text-white relative';
                headerDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="bg-white/20 backdrop-blur-sm p-3 rounded-xl border border-white/30">
                                <div class="text-2xl font-bold text-white">#${idx + 1}</div>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-1">${app.app_name}</h3>
                                <div class="flex items-center space-x-3">
                                    <span class="text-white/80 text-sm">App ID:</span>
                                    <span class="font-mono text-sm bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full border border-white/30">${app.app_id}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-white/80 text-sm uppercase tracking-wider">Total Fraud Events</div>
                            <div class="text-3xl font-bold text-white">${totalFraud.toLocaleString()}</div>
                        </div>
                    </div>
                `;
                appSection.appendChild(headerDiv);
                // Content container
                const contentDiv = document.createElement('div');
                contentDiv.className = 'p-8';
                
                // Error display
                if (app.errors && app.errors.length > 0) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-50 border border-red-200 rounded-xl p-4 mb-6';
                    errorDiv.innerHTML = `
                        <div class="flex items-center space-x-2 mb-2">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-red-600 font-semibold">Processing Errors</span>
                        </div>
                        ${app.errors.map(error => `<div class="text-red-500 text-sm">${error}</div>`).join('')}
                    `;
                    contentDiv.appendChild(errorDiv);
                }
                
                // --- Enhanced Metric Cards ---
                if (app.table && app.table.length > 0) {
                    // Calculate totals for this app
                    const totals = {
                        blocked_installs_rt: 0,
                        blocked_installs_pa: 0,
                        blocked_in_app_events: 0,
                        fraud_post_inapps: 0,
                        blocked_clicks: 0,
                        blocked_install_postbacks: 0
                    };
                    app.table.forEach(row => {
                        totals.blocked_installs_rt += row.blocked_installs_rt || 0;
                        totals.blocked_installs_pa += row.blocked_installs_pa || 0;
                        totals.blocked_in_app_events += row.blocked_in_app_events || 0;
                        totals.fraud_post_inapps += row.fraud_post_inapps || 0;
                        totals.blocked_clicks += row.blocked_clicks || 0;
                        totals.blocked_install_postbacks += row.blocked_install_postbacks || 0;
                    });
                    
                    // Enhanced metric cards with icons and colors
                    const metricCards = [
                        { key: 'blocked_installs_rt', label: 'Blocked Installs (RT)', value: totals.blocked_installs_rt, color: '#3b82f6', bg: 'rgba(59,130,246,0.1)', icon: 'ðŸš«' },
                        { key: 'blocked_installs_pa', label: 'Blocked Installs (PA)', value: totals.blocked_installs_pa, color: '#8b5cf6', bg: 'rgba(139,92,246,0.1)', icon: 'ðŸ”' },
                        { key: 'blocked_in_app_events', label: 'Blocked In-App Events', value: totals.blocked_in_app_events, color: '#06b6d4', bg: 'rgba(6,182,212,0.1)', icon: 'âš¡' },
                        { key: 'fraud_post_inapps', label: 'Fraud Post-InApps', value: totals.fraud_post_inapps, color: '#10b981', bg: 'rgba(16,185,129,0.1)', icon: 'ðŸŽ¯' },
                        { key: 'blocked_clicks', label: 'Blocked Clicks', value: totals.blocked_clicks, color: '#6366f1', bg: 'rgba(99,102,241,0.1)', icon: 'ðŸ‘†' },
                        { key: 'blocked_install_postbacks', label: 'Blocked Install Postbacks', value: totals.blocked_install_postbacks, color: '#ec4899', bg: 'rgba(236,72,153,0.1)', icon: 'ðŸ“¡' }
                    ];
                    
                    const cardsRow = document.createElement('div');
                    cardsRow.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8';
                    metricCards.forEach(card => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'bg-gradient-to-br from-gray-50 to-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-all duration-200 hover:scale-105';
                        cardDiv.innerHTML = `
                            <div class="flex items-center justify-between mb-3">
                                <div class="p-2 rounded-lg" style="background: ${card.bg}">
                                    <span class="text-lg">${card.icon}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold" style="color: ${card.color}">${card.value.toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="text-xs font-medium text-gray-600 leading-tight">${card.label}</div>
                        `;
                        cardsRow.appendChild(cardDiv);
                    });
                    contentDiv.appendChild(cardsRow);
                }
                // --- Enhanced Trend Charts Section ---
                if (app.table && app.table.length > 0) {
                    const chartSection = document.createElement('div');
                    chartSection.className = 'mt-8';
                    
                    // Chart section header
                    const chartHeader = document.createElement('div');
                    chartHeader.className = 'flex items-center space-x-3 mb-6';
                    chartHeader.innerHTML = `
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-500 p-2 rounded-lg">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h4 class="text-xl font-bold bg-gradient-to-r from-indigo-700 to-purple-700 bg-clip-text text-transparent">Fraud Trends Analysis</h4>
                    `;
                    chartSection.appendChild(chartHeader);
                    
                    // Enhanced metrics grid for charts
                    const metricsGrid = document.createElement('div');
                    metricsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6';
                    
                    const chartMetrics = [
                        { key: 'blocked_installs_rt', label: 'Blocked Installs (RT)', color: '#3b82f6', bg: 'rgba(59,130,246,0.1)', icon: 'ðŸš«' },
                        { key: 'blocked_installs_pa', label: 'Blocked Installs (PA)', color: '#8b5cf6', bg: 'rgba(139,92,246,0.1)', icon: 'ðŸ”' },
                        { key: 'blocked_in_app_events', label: 'Blocked In-App Events', color: '#06b6d4', bg: 'rgba(6,182,212,0.1)', icon: 'âš¡' },
                        { key: 'fraud_post_inapps', label: 'Fraud Post-InApps', color: '#10b981', bg: 'rgba(16,185,129,0.1)', icon: 'ðŸŽ¯' },
                        { key: 'blocked_clicks', label: 'Blocked Clicks', color: '#6366f1', bg: 'rgba(99,102,241,0.1)', icon: 'ðŸ‘†' },
                        { key: 'blocked_install_postbacks', label: 'Blocked Install Postbacks', color: '#ec4899', bg: 'rgba(236,72,153,0.1)', icon: 'ðŸ“¡' }
                    ];

                    chartMetrics.forEach((metric, midx) => {
                        const graphContainer = document.createElement('div');
                        graphContainer.className = 'bg-white rounded-xl p-6 border border-gray-200 shadow-lg hover:shadow-xl transition-all duration-200';
                        
                        // Enhanced chart header
                        const chartHeaderInner = document.createElement('div');
                        chartHeaderInner.className = 'flex items-center justify-between mb-4';
                        chartHeaderInner.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <div class="p-2 rounded-lg" style="background: ${metric.bg}">
                                    <span class="text-lg">${metric.icon}</span>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800 text-sm">${metric.label}</div>
                                </div>
                            </div>
                        `;
                        graphContainer.appendChild(chartHeaderInner);
                        
                        const canvas = document.createElement('canvas');
                        canvas.id = `fraudTrendChart${range}-${idx}-${midx}`;
                        canvas.height = 200;
                        canvas.width = 350;
                        graphContainer.appendChild(canvas);
                        
                        metricsGrid.appendChild(graphContainer);
                        
                        // --- AGGREGATE METRIC BY DATE ---
                        const dateSums = {};
                        (app.table || []).forEach(row => {
                            if (!dateSums[row.date]) dateSums[row.date] = 0;
                            dateSums[row.date] += row[metric.key] || 0;
                        });
                        
                        // Generate complete date range for last 10 days to include dates with 0 data
                        const today = new Date();
                        const allDates = [];
                        for (let i = 9; i >= 0; i--) {
                            const date = new Date(today);
                            date.setDate(today.getDate() - i);
                            allDates.push(date.toISOString().split('T')[0]);
                        }
                        
                        // Use complete date range and fill missing dates with 0
                        const sortedDates = allDates;
                        const summedData = sortedDates.map(date => dateSums[date] || 0);
                        // Enhanced chart rendering
                        setTimeout(() => {
                            const ctx = document.getElementById(`fraudTrendChart${range}-${idx}-${midx}`);
                            if (ctx && window.Chart) {
                                if (window._chartInstances[`fraudTrendChart${range}-${idx}-${midx}`]) {
                                    window._chartInstances[`fraudTrendChart${range}-${idx}-${midx}`].destroy();
                                }
                                window._chartInstances[`fraudTrendChart${range}-${idx}-${midx}`] = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: sortedDates,
                                        datasets: [{
                                            label: metric.label,
                                            data: summedData,
                                            borderColor: metric.color,
                                            backgroundColor: metric.bg,
                                            fill: true,
                                            tension: 0.4,
                                            pointRadius: 4,
                                            pointHoverRadius: 6,
                                            pointBackgroundColor: metric.color,
                                            pointBorderColor: '#ffffff',
                                            pointBorderWidth: 2,
                                            borderWidth: 3
                                        }]
                                    },
                                    options: {
                                        responsive: false,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                                titleColor: '#1f2937',
                                                bodyColor: '#1f2937',
                                                borderColor: '#e5e7eb',
                                                borderWidth: 1,
                                                cornerRadius: 8,
                                                displayColors: false,
                                                callbacks: {
                                                    label: function(context) {
                                                        return `${context.parsed.y.toLocaleString()} events`;
                                                    }
                                                }
                                            }
                                        },
                                        scales: {
                                            x: {
                                                display: true,
                                                grid: { display: false },
                                                ticks: { color: '#6b7280', font: { size: 11 }, maxRotation: 45 }
                                            },
                                            y: {
                                                beginAtZero: true,
                                                display: true,
                                                grid: { color: '#f3f4f6', borderDash: [2, 2] },
                                                ticks: { color: '#6b7280', font: { size: 11 }, precision: 0 }
                                            }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    });
                    
                    chartSection.appendChild(metricsGrid);
                    contentDiv.appendChild(chartSection);
                } else {
                    const noDataDiv = document.createElement('div');
                    noDataDiv.className = 'bg-gray-50 border border-gray-200 rounded-xl p-6 text-center';
                    noDataDiv.innerHTML = `
                        <div class="text-gray-400 mb-2">
                            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="text-gray-500 font-medium">No fraud data available for this period</div>
                    `;
                    contentDiv.appendChild(noDataDiv);
                }
                
                // Append content to app section
                appSection.appendChild(contentDiv);
                container.appendChild(appSection);
            });
        }

        // Add JS logic for switching sub-tabs and running fetch/render for both sub-pages
        let currentFraudSubTab = 'analytics';
        function switchFraudSubTab(subtab) {
            if (subtab === 'analytics') {
                document.getElementById('fraud-analytics-tab-btn').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('fraud-analytics-tab-btn').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('fraud-analytics-subtab').style.display = '';
                document.getElementById('fraud-source-tab-btn').classList.remove('border-blue-500', 'text-blue-600');
                document.getElementById('fraud-source-tab-btn').classList.add('border-transparent', 'text-gray-500');
                document.getElementById('fraud-source-subtab').style.display = 'none';
            } else {
                document.getElementById('fraud-source-tab-btn').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('fraud-source-tab-btn').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('fraud-source-subtab').style.display = '';
                document.getElementById('fraud-analytics-tab-btn').classList.remove('border-blue-500', 'text-blue-600');
                document.getElementById('fraud-analytics-tab-btn').classList.add('border-transparent', 'text-gray-500');
                document.getElementById('fraud-analytics-subtab').style.display = 'none';
                // Only render from cache, do NOT fetch on tab switch
                const fraudSourceRanges = ['10d', 'mtd', 'lastmonth', '30d'];
                fraudSourceRanges.forEach(range => {
                    if (fraudSourceDataCache[range]) {
                        renderFraudSource(fraudSourceDataCache[range], range);
                    }
                });
            }
            currentFraudSubTab = subtab;
        }

        // Add a helper to group fraud data by media source
        function processFraudDataBySource(app) {
            const grouped = {};
            console.log(`[DEBUG] Processing fraud data for app: ${app.app_name} (${app.app_id})`);
            console.log(`[DEBUG] Total rows: ${(app.table || []).length}`);
            (app.table || []).forEach(row => {
                // Use the normalized media_source field from backend
                let source = row.media_source;
                if (!source) source = 'Unknown';
                console.log(`[DEBUG] Processing media source: ${source}`);
                if (!grouped[source]) {
                    grouped[source] = {
                        blocked_installs_rt: 0,
                        blocked_installs_pa: 0,
                        blocked_in_app_events: 0,
                        fraud_post_inapps: 0,
                        blocked_clicks: 0,
                        blocked_install_postbacks: 0,
                        dates: [],
                        rows: []
                    };
                }
                grouped[source].blocked_installs_rt += parseInt(row.blocked_installs_rt || 0);
                grouped[source].blocked_installs_pa += parseInt(row.blocked_installs_pa || 0);
                grouped[source].blocked_in_app_events += parseInt(row.blocked_in_app_events || 0);
                grouped[source].fraud_post_inapps += parseInt(row.fraud_post_inapps || 0);
                grouped[source].blocked_clicks += parseInt(row.blocked_clicks || 0);
                grouped[source].blocked_install_postbacks += parseInt(row.blocked_install_postbacks || 0);
                grouped[source].dates.push(row.date);
                grouped[source].rows.push(row);
            });
            console.log(`[DEBUG] Grouped media sources: ${Object.keys(grouped).join(', ')}`);
            return grouped;
        }

        // Enhanced renderFraudSource with professional design
        function renderFraudSource(data, range) {
            const container = document.getElementById(`fraud-source-data-${range}`);
            container.innerHTML = '';
            
            if (!data.apps || data.apps.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20">
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-3xl p-6 max-w-lg mx-auto shadow-lg">
                            <div class="text-indigo-400 mb-6">
                                <svg class="w-20 h-20 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                            <div class="text-indigo-700 text-xl font-bold mb-3">ðŸ›¡ï¸ No Source Data Available</div>
                            <div class="text-indigo-600 text-base leading-relaxed">Please select a campaign from the filter above and run the analysis to see detailed fraud data by media source.</div>
                        </div>
                    </div>
                `;
                return;
            }
            // Sort apps by total fraud (sum of all 6 metrics, descending)
            const fraudMetricKeys = [
                'blocked_installs_rt',
                'blocked_installs_pa',
                'blocked_in_app_events',
                'fraud_post_inapps',
                'blocked_clicks',
                'blocked_install_postbacks'
            ];
            const sortedApps = [...data.apps].sort((a, b) => {
                const sumA = (a.table || []).reduce((acc, row) => acc + fraudMetricKeys.reduce((s, k) => s + (parseInt(row[k]) || 0), 0), 0);
                const sumB = (b.table || []).reduce((acc, row) => acc + fraudMetricKeys.reduce((s, k) => s + (parseInt(row[k]) || 0), 0), 0);
                return sumB - sumA;
            });

            sortedApps.forEach((app, idx) => {
                // Group by media source
                const grouped = processFraudDataBySource(app);
                // Sort sources by total fraud (sum of all 6 metrics)
                const sortedSources = Object.keys(grouped).sort((a, b) => {
                    const sumA = fraudMetricKeys.reduce((acc, key) => acc + (parseInt(grouped[a][key]) || 0), 0);
                    const sumB = fraudMetricKeys.reduce((acc, key) => acc + (parseInt(grouped[b][key]) || 0), 0);
                    return sumB - sumA;
                });
                console.log(`[DEBUG] Sorted media sources for ${app.app_name}: ${sortedSources.join(', ')}`);
                const appSection = document.createElement('div');
                appSection.className = 'mb-12 bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden';
                
                // App header with clean design
                const headerDiv = document.createElement('div');
                headerDiv.className = 'bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-4 text-white';
                headerDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold mb-1">${app.app_name}</h2>
                            <p class="text-indigo-100 font-mono text-xs">App ID: ${app.app_id}</p>
                        </div>
                        <div class="text-right">
                            <div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-lg border border-white/30">
                                <span class="text-xs font-semibold">ðŸ“Š Media Source Analysis</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 text-indigo-100 text-xs">
                        ðŸ“… ${app.table[0]?.date || ''} to ${app.table[app.table.length - 1]?.date || ''}
                    </div>
                `;
                appSection.appendChild(headerDiv);
                
                // Content container
                const contentDiv = document.createElement('div');
                contentDiv.className = 'p-6';

                 // Group by media source with compact design
                 const sourcesGrid = document.createElement('div');
                 sourcesGrid.className = 'space-y-6';

                 sortedSources.forEach((source, sidx) => {
                     // Source card: clean and compact design
                     const sourceCard = document.createElement('div');
                     sourceCard.className = 'bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200';

                     // Calculate total fraud events for this source
                     const totalFraudEvents = fraudMetricKeys.reduce((sum, key) => 
                         sum + (parseInt(grouped[source][key]) || 0), 0
                     );
                     
                     // Header with media source name and total fraud events
                     const sourceHeader = document.createElement('div');
                     sourceHeader.className = 'bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200 rounded-t-xl';
                     sourceHeader.innerHTML = `
                         <div class="flex items-center justify-between">
                             <div class="flex items-center space-x-3">
                                 <h3 class="text-lg font-semibold text-gray-800 truncate flex items-center" title="${source}">
                                     <span class="mr-2 text-blue-500">ðŸ“¡</span>
                                     <span>${source}</span>
                                 </h3>
                                 <div class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-semibold border border-red-200">
                                     <span class="mr-1">ðŸš¨</span>
                                     <span>${totalFraudEvents.toLocaleString()} Total Fraud Events</span>
                                 </div>
                             </div>
                             <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-md text-xs font-medium">
                                 Source #${sidx + 1}
                             </div>
                         </div>
                     `;
                     sourceCard.appendChild(sourceHeader);
                     
                     // Content container for metrics and chart
                     const contentContainer = document.createElement('div');
                     contentContainer.className = 'p-6';
                     
                     // Compact metrics grid - 2 rows instead of 6 individual cards
                     const metricsSection = document.createElement('div');
                     metricsSection.className = 'mb-6';
                     
                     // Top row - Primary metrics
                     const primaryMetrics = document.createElement('div');
                     primaryMetrics.className = 'grid grid-cols-2 md:grid-cols-3 gap-4 mb-4';
                     primaryMetrics.innerHTML = `
                         <div class="bg-red-50 p-3 rounded-lg border border-red-200 text-center">
                             <div class="text-red-600 font-medium text-xs mb-1">ðŸš« Blocked Installs (RT)</div>
                             <div class="text-red-700 text-lg font-bold">${grouped[source].blocked_installs_rt}</div>
                         </div>
                         <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-center">
                             <div class="text-blue-600 font-medium text-xs mb-1">ðŸ›¡ï¸ Blocked Installs (PA)</div>
                             <div class="text-blue-700 text-lg font-bold">${grouped[source].blocked_installs_pa}</div>
                         </div>
                         <div class="bg-amber-50 p-3 rounded-lg border border-amber-200 text-center">
                             <div class="text-amber-600 font-medium text-xs mb-1">âš ï¸ Blocked In-App Events</div>
                             <div class="text-amber-700 text-lg font-bold">${grouped[source].blocked_in_app_events}</div>
                         </div>
                     `;
                     metricsSection.appendChild(primaryMetrics);
                     
                     // Bottom row - Secondary metrics
                     const secondaryMetrics = document.createElement('div');
                     secondaryMetrics.className = 'grid grid-cols-2 md:grid-cols-3 gap-4';
                     secondaryMetrics.innerHTML = `
                         <div class="bg-teal-50 p-3 rounded-lg border border-teal-200 text-center">
                             <div class="text-teal-600 font-medium text-xs mb-1">ðŸ” Fraud Post-InApps</div>
                             <div class="text-teal-700 text-lg font-bold">${grouped[source].fraud_post_inapps}</div>
                         </div>
                         <div class="bg-purple-50 p-3 rounded-lg border border-purple-200 text-center">
                             <div class="text-purple-600 font-medium text-xs mb-1">ðŸš¨ Blocked Clicks</div>
                             <div class="text-purple-700 text-lg font-bold">${grouped[source].blocked_clicks}</div>
                         </div>
                         <div class="bg-orange-50 p-3 rounded-lg border border-orange-200 text-center">
                             <div class="text-orange-600 font-medium text-xs mb-1">ðŸ“‹ Install Postbacks</div>
                             <div class="text-orange-700 text-lg font-bold">${grouped[source].blocked_install_postbacks}</div>
                         </div>
                     `;
                     metricsSection.appendChild(secondaryMetrics);
                     contentContainer.appendChild(metricsSection);

                     // Enhanced chart section with better visibility
                     const chartSection = document.createElement('div');
                     chartSection.className = 'border-t border-gray-200 pt-6';
                     
                     const chartTitle = document.createElement('h4');
                     chartTitle.className = 'text-base font-semibold text-gray-700 mb-4 flex items-center';
                     chartTitle.innerHTML = '<span class="mr-2">ðŸ“ˆ</span>Fraud Trends Over Time - Daily Breakdown';
                     chartSection.appendChild(chartTitle);
                     
                     // Enhanced chart container with better height
                     const chartContainer = document.createElement('div');
                     chartContainer.className = 'bg-gradient-to-br from-gray-50 to-white p-6 rounded-xl border border-gray-200 shadow-sm';
                     chartContainer.style.minHeight = '400px';
                     
                     const canvas = document.createElement('canvas');
                     canvas.id = `fraudSourceChart_${idx}_${sidx}_${range}`;
                     canvas.style.height = '380px';
                     canvas.style.width = '100%';
                     chartContainer.appendChild(canvas);
                     chartSection.appendChild(chartContainer);

                     // Metrics for the comprehensive chart
                     const metrics = [
                         { key: 'blocked_installs_rt', label: 'Blocked Installs (RT)', color: '#ef4444' },
                         { key: 'blocked_installs_pa', label: 'Blocked Installs (PA)', color: '#3b82f6' },
                         { key: 'blocked_in_app_events', label: 'Blocked In-App Events', color: '#f59e0b' },
                         { key: 'fraud_post_inapps', label: 'Fraud Post-InApps', color: '#14b8a6' },
                         { key: 'blocked_clicks', label: 'Blocked Clicks', color: '#a21caf' },
                         { key: 'blocked_install_postbacks', label: 'Install Postbacks', color: '#f97316' }
                     ];
                     // Render comprehensive chart
                         setTimeout(() => {
                         const ctx = document.getElementById(`fraudSourceChart_${idx}_${sidx}_${range}`);
                             if (ctx && window.Chart) {
                                 // Generate complete date range for last 10 days to include dates with 0 data
                                 const today = new Date();
                                 const allDates = [];
                                 for (let i = 9; i >= 0; i--) {
                                     const date = new Date(today);
                                     date.setDate(today.getDate() - i);
                                     allDates.push(date.toISOString().split('T')[0]);
                                 }
                                 
                                 // Use complete date range instead of just dates with data
                                 const dates = allDates;
                             
                             // Create enhanced datasets for better visibility
                             const datasets = metrics.map((metric, index) => ({
                                             label: metric.label,
                                             data: dates.map(date => {
                                                 const row = grouped[source].rows.find(r => r.date === date);
                                                 return row ? row[metric.key] || 0 : 0;
                                             }),
                                             borderColor: metric.color,
                                             backgroundColor: `${metric.color}20`,
                                             fill: false,
                                 tension: 0.3,
                                 pointRadius: 4,
                                 pointHoverRadius: 8,
                                 borderWidth: 3,
                                             pointBackgroundColor: metric.color,
                                 pointBorderColor: '#ffffff',
                                 pointBorderWidth: 2,
                                 pointHoverBorderWidth: 3,
                                 borderDash: index % 2 === 1 ? [5, 5] : [], // Alternate solid/dashed lines for better distinction
                                 pointStyle: index % 3 === 0 ? 'circle' : index % 3 === 1 ? 'rect' : 'triangle'
                             }));
                             
                             new Chart(ctx, {
                                 type: 'line',
                                 data: {
                                     labels: dates,
                                     datasets: datasets
                                     },
                                     options: {
                                     responsive: true,
                                     maintainAspectRatio: false,
                                     layout: {
                                         padding: {
                                             top: 20,
                                             bottom: 20,
                                             left: 10,
                                             right: 10
                                         }
                                     },
                                         plugins: {
                                         legend: { 
                                             display: true,
                                             position: 'top',
                                             align: 'center',
                                             labels: {
                                                 padding: 20,
                                                 usePointStyle: true,
                                                 font: { size: 12, weight: '500' },
                                                 color: '#374151',
                                                 boxWidth: 12,
                                                 boxHeight: 12
                                             }
                                         },
                                         tooltip: { 
                                             mode: 'index', 
                                             intersect: false,
                                             backgroundColor: 'rgba(255, 255, 255, 0.96)',
                                             titleColor: '#1f2937',
                                             bodyColor: '#374151',
                                             borderColor: '#d1d5db',
                                             borderWidth: 2,
                                             cornerRadius: 12,
                                             padding: 16,
                                             titleFont: { size: 14, weight: 'bold' },
                                             bodyFont: { size: 13 },
                                             callbacks: { 
                                                 title: function(context) {
                                                     return `Date: ${context[0].label}`;
                                                 },
                                                 label: function(context) { 
                                                     return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} events`;
                                                 }
                                             }
                                         }
                                         },
                                         scales: {
                                             x: {
                                                 display: true,
                                             ticks: { 
                                                 maxRotation: 45,
                                                 minRotation: 0,
                                                 font: { size: 12, weight: '500' },
                                                 color: '#374151',
                                                 padding: 10
                                             },
                                             grid: { 
                                                 display: true,
                                                 color: '#e5e7eb',
                                                 lineWidth: 1,
                                                 drawBorder: true,
                                                 borderColor: '#d1d5db',
                                                 borderWidth: 2
                                             },
                                             title: { 
                                                 display: true,
                                                 text: 'Date',
                                                 color: '#374151',
                                                 font: { size: 13, weight: 'bold' },
                                                 padding: { top: 15 }
                                             }
                                             },
                                             y: {
                                                 beginAtZero: true,
                                                 display: true,
                                             grid: { 
                                                 display: true, 
                                                 color: '#f3f4f6',
                                                 lineWidth: 1,
                                                 drawBorder: true,
                                                 borderColor: '#d1d5db',
                                                 borderWidth: 2
                                             },
                                             ticks: { 
                                                 font: { size: 12, weight: '500' }, 
                                                 precision: 0,
                                                 color: '#374151',
                                                 padding: 10,
                                                 callback: function(value) {
                                                     return value.toLocaleString();
                                                 }
                                             },
                                             title: { 
                                                 display: true,
                                                 text: 'Number of Fraud Events',
                                                 color: '#374151',
                                                 font: { size: 13, weight: 'bold' },
                                                 padding: { bottom: 15 }
                                             }
                                         }
                                     },
                                     interaction: {
                                         intersect: false,
                                         mode: 'index'
                                     },
                                     elements: {
                                         line: {
                                             borderJoinStyle: 'round',
                                             borderCapStyle: 'round'
                                         }
                                     }
                                 }
                             });
                         }
                     }, 100);

                     // Add chart section to content container
                     contentContainer.appendChild(chartSection);
                     
                     // Add content container to source card
                     sourceCard.appendChild(contentContainer);
                     sourcesGrid.appendChild(sourceCard);
                 });

                 // Add sources grid to content div
                 contentDiv.appendChild(sourcesGrid);
                 appSection.appendChild(contentDiv);
                 container.appendChild(appSection);
            });
        }

        // Enhanced Fraud Per Source Logic (10d only)
        let fraudSourceDataCache = { '10d': null };
        
        // Initialize fraud source functionality
        function initializeFraudSource() {
            // Populate both filters
            populateFraudFilters();
            
            // Load cached data from backend (like Analytics does)
            console.log('ðŸ”„ Loading fraud source data from backend cache...');
            fetch('/get_fraud_subpage_10d')
                .then(r => r.json())
                .then(data => {
                    if (data && data.apps && data.apps.length > 0) {
                        // Cache the data for source tab
                        fraudSourceDataCache['10d'] = data;
                        console.log('âœ… Fraud source data loaded from backend cache:', data.apps.length, 'apps');
                        
                        // Auto-select first app if none selected
                        if (!window.selectedFraudSourceAppId) {
                            const firstAppWithData = data.apps.find(app => app.table && app.table.length > 0) || data.apps[0];
                            if (firstAppWithData) {
                                window.selectedFraudSourceAppId = firstAppWithData.app_id;
                                
                                // Update the dropdown if it exists
                                const sourceFilter = document.getElementById('fraud-source-app-filter');
                                if (sourceFilter) {
                                    sourceFilter.value = firstAppWithData.app_id;
                                }
                                
                                console.log('âœ… Auto-selected fraud source app:', firstAppWithData.app_name, '(', firstAppWithData.app_id, ')');
                            }
                        }
                        
                        // Render the data
                        renderFraudSource(data, '10d');
                        document.getElementById('fraud-source-error-10d').style.display = 'none';
                    } else {
                        console.log('âš ï¸ No fraud source data available in backend cache');
                        // Show initial state
                        document.getElementById('fraud-source-data-10d').innerHTML = '<div class="text-center py-20"><div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-3xl p-6 max-w-lg mx-auto shadow-lg"><div class="text-indigo-400 mb-6"><svg class="w-20 h-20 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div><div class="text-indigo-700 text-xl font-bold mb-3">ðŸŽ¯ No Data Available</div><div class="text-indigo-600 text-base leading-relaxed">No cached fraud data found. Generate a report first using the Fraud Analytics tab.</div></div></div>';
                    }
                })
                .catch(() => {
                    console.log('âŒ Error loading fraud source data from backend');
                    // Show initial state
                    document.getElementById('fraud-source-data-10d').innerHTML = '<div class="text-center py-20"><div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-3xl p-6 max-w-lg mx-auto shadow-lg"><div class="text-indigo-400 mb-6"><svg class="w-20 h-20 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div><div class="text-indigo-700 text-xl font-bold mb-3">ðŸŽ¯ Select a Campaign</div><div class="text-indigo-600 text-base leading-relaxed">Choose a campaign from the filter above to analyze its fraud sources and media performance.</div></div></div>';
                });
        }
        
        // RUN button logic for fraud source (10d only) - CACHE ONLY, NO API CALLS
        document.getElementById('run-fraud-source-10d-btn').onclick = function() {
            const selectedAppId = document.getElementById('fraud-source-app-filter').value;
            
            if (!selectedAppId) {
                alert('Please select a campaign first.');
                return;
            }
            
            console.log('ðŸ”„ Fraud Per Source: Refreshing from cache only (no API calls)');
            
            // Check if we have cached data
            if (fraudSourceDataCache['10d']) {
                console.log('âœ… Found cached fraud data, rendering for selected app:', selectedAppId);
                renderFraudSource(fraudSourceDataCache['10d'], '10d');
                
                // Show success message
                const container = document.getElementById('fraud-source-data-10d');
                if (container && container.innerHTML.includes('Select a Campaign')) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="bg-green-50 border border-green-200 rounded-2xl p-6 max-w-md mx-auto">
                                <div class="text-green-600 text-lg font-semibold mb-2">âœ… Cache Refreshed</div>
                                <div class="text-green-500 text-sm">Showing cached fraud data for selected campaign.</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                console.log('âš ï¸ No cached fraud data available');
                // Show message to use Analytics page to generate data
                const container = document.getElementById('fraud-source-data-10d');
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="bg-amber-50 border border-amber-200 rounded-2xl p-8 max-w-lg mx-auto">
                            <div class="text-amber-400 mb-6">
                                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"></path>
                                </svg>
                            </div>
                            <div class="text-amber-700 text-xl font-bold mb-3">ðŸ“Š No Cached Data</div>
                            <div class="text-amber-600 text-base leading-relaxed mb-4">
                                No fraud data available in cache. To populate this page:
                            </div>
                            <div class="text-left bg-white/80 p-4 rounded-xl border border-amber-300">
                                <div class="text-amber-700 font-medium mb-2">Options:</div>
                                <div class="text-sm text-amber-600 space-y-1">
                                    <div>â€¢ Go to <strong>Fraud Analytics</strong> â†’ Press <strong>Generate Report</strong></div>
                                    <div>â€¢ Or use <strong>Get All Stats</strong> button in Action Center</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            };

        // Overview Tab Functionality
        function initializeOverviewTab() {
            // Initialize charts
            initializeCharts();
            
            // Fetch and update overview data
            fetchOverviewData();
            
            // Fetch and update Top Performing Apps
            fetchTopPerformingApps();
        }

        function initializeCharts() {
            // Enhanced chart configuration with gradients and animations
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1f2937',
                        bodyColor: '#1f2937',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        cornerRadius: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function(context) {
                                return context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6b7280',
                            font: { size: 11, weight: '500' }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f3f4f6',
                            borderDash: [5, 5]
                        },
                        ticks: {
                            callback: v => v.toLocaleString(),
                            color: '#6b7280',
                            font: { size: 11, weight: '500' }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 5,
                        hoverRadius: 8,
                        borderWidth: 2,
                        hoverBorderWidth: 3
                    }
                }
            };

            // Initialize Impressions Chart with purple gradient
            const impressionsCanvas = document.getElementById('impressionsChart');
            if (impressionsCanvas) {
                const ctx = impressionsCanvas.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(147, 51, 234, 0.3)');
                gradient.addColorStop(1, 'rgba(147, 51, 234, 0.05)');
                
                window.impressionsChart = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Impressions', 
                            data: [], 
                            borderColor: '#9333ea',
                            backgroundColor: gradient,
                            fill: true, 
                            tension: 0.4,
                            pointBackgroundColor: '#9333ea',
                            pointBorderColor: '#ffffff',
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#9333ea',
                            borderWidth: 3
                        }] 
                    },
                    options: chartOptions
                });
            }
            
            // Initialize Clicks Chart with emerald gradient
            const clicksCanvas = document.getElementById('clicksChart');
            if (clicksCanvas) {
                const ctx = clicksCanvas.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.05)');
                
                window.clicksChart = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Clicks', 
                            data: [], 
                            borderColor: '#10b981',
                            backgroundColor: gradient,
                            fill: true, 
                            tension: 0.4,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#10b981',
                            borderWidth: 3
                        }] 
                    },
                    options: chartOptions
                });
            }
            
            // Initialize Installs Chart with amber gradient
            const installsCanvas = document.getElementById('installsChart');
            if (installsCanvas) {
                const ctx = installsCanvas.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(245, 158, 66, 0.3)');
                gradient.addColorStop(1, 'rgba(245, 158, 66, 0.05)');
                
                window.installsChart = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Installs', 
                            data: [], 
                            borderColor: '#f59e42',
                            backgroundColor: gradient,
                            fill: true, 
                            tension: 0.4,
                            pointBackgroundColor: '#f59e42',
                            pointBorderColor: '#ffffff',
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#f59e42',
                            borderWidth: 3
                        }] 
                    },
                    options: chartOptions
                });
            }
        }

        function fetchOverviewData() {
            // Show loading states for charts
            const loadingElements = ['impressions-loading', 'clicks-loading', 'installs-loading'];
            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'flex';
            });
            
            fetch('/api/overview')
                .then(response => response.json())
                .then(data => {
                    // Hide loading states
                    loadingElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) element.style.display = 'none';
                    });
                    console.log('Overview data:', data); // Debug log
                    
                    // Calculate totals for summary cards
                    let totalImpressions = 0;
                    let totalClicks = 0;
                    let totalInstalls = 0;
                    
                    if (data.trend) {
                        totalImpressions = data.trend.impressions ? data.trend.impressions.reduce((sum, val) => sum + (val || 0), 0) : 0;
                        totalClicks = data.trend.clicks ? data.trend.clicks.reduce((sum, val) => sum + (val || 0), 0) : 0;
                        totalInstalls = data.trend.installs ? data.trend.installs.reduce((sum, val) => sum + (val || 0), 0) : 0;
                    }
                    
                    // Calculate conversion rate
                    const conversionRate = totalClicks > 0 ? ((totalInstalls / totalClicks) * 100) : 0;
                    
                    // Update summary cards with animations
                    const impressionsEl = document.getElementById('overview-total-impressions');
                    const clicksEl = document.getElementById('overview-total-clicks');
                    const installsEl = document.getElementById('overview-total-installs');
                    const conversionEl = document.getElementById('overview-conversion-rate');
                    
                    if (impressionsEl) {
                        impressionsEl.style.opacity = '0.5';
                        setTimeout(() => {
                            impressionsEl.textContent = totalImpressions.toLocaleString();
                            impressionsEl.style.opacity = '1';
                        }, 150);
                    }
                    if (clicksEl) {
                        clicksEl.style.opacity = '0.5';
                        setTimeout(() => {
                            clicksEl.textContent = totalClicks.toLocaleString();
                            clicksEl.style.opacity = '1';
                        }, 200);
                    }
                    if (installsEl) {
                        installsEl.style.opacity = '0.5';
                        setTimeout(() => {
                            installsEl.textContent = totalInstalls.toLocaleString();
                            installsEl.style.opacity = '1';
                        }, 250);
                    }
                    if (conversionEl) {
                        conversionEl.style.opacity = '0.5';
                        setTimeout(() => {
                            conversionEl.textContent = conversionRate.toFixed(2) + '%';
                            conversionEl.style.opacity = '1';
                        }, 300);
                    }
                    
                    // Update each chart with enhanced styling and animations
                    if (window.impressionsChart && data.trend) {
                        // Add fade-in effect
                        document.getElementById('impressionsChart').style.opacity = '0.5';
                        setTimeout(() => {
                        window.impressionsChart.data.labels = data.trend.dates;
                        window.impressionsChart.data.datasets[0].data = data.trend.impressions;
                            window.impressionsChart.update('active');
                            document.getElementById('impressionsChart').style.opacity = '1';
                        }, 300);
                    }
                    if (window.clicksChart && data.trend) {
                        // Add fade-in effect
                        document.getElementById('clicksChart').style.opacity = '0.5';
                        setTimeout(() => {
                        window.clicksChart.data.labels = data.trend.dates;
                        window.clicksChart.data.datasets[0].data = data.trend.clicks;
                            window.clicksChart.update('active');
                            document.getElementById('clicksChart').style.opacity = '1';
                        }, 400);
                    }
                    if (window.installsChart && data.trend) {
                        // Add fade-in effect
                        document.getElementById('installsChart').style.opacity = '0.5';
                        setTimeout(() => {
                        window.installsChart.data.labels = data.trend.dates;
                        window.installsChart.data.datasets[0].data = data.trend.installs;
                            window.installsChart.update('active');
                            document.getElementById('installsChart').style.opacity = '1';
                        }, 500);
                    }
                    // Fallback message if all values are zero
                    const fallbackMsgId = 'overview-fallback-msg';
                    let fallbackMsg = document.getElementById(fallbackMsgId);
                    const allZero = data.trend && data.trend.impressions.concat(data.trend.clicks, data.trend.installs).every(val => val === 0);
                    if (allZero) {
                        if (!fallbackMsg) {
                            fallbackMsg = document.createElement('div');
                            fallbackMsg.id = fallbackMsgId;
                            fallbackMsg.className = 'text-sm text-red-500 mt-4';
                            fallbackMsg.textContent = "No data available. Please run the 'Last 10 Days' report on the Stats page.";
                            document.querySelector('.bg-white.rounded-lg.shadow.p-6.mb-8')?.appendChild(fallbackMsg);
                        }
                    } else if (fallbackMsg) {
                        fallbackMsg.remove();
                    }
                    // Update last updated note for all relevant sections
                    const lastUpdated = data.last_updated ? `(Last updated: ${data.last_updated})` : '';
                    document.getElementById('overview-last-updated').textContent = lastUpdated;
                    document.getElementById('fraud-last-updated').textContent = lastUpdated;
                    document.getElementById('top-apps-last-updated').textContent = lastUpdated;
                    // Top Fraudulent Sources (grouped by app)
                    const badSourcesList = document.getElementById('bad-sources-list');
                    const badSourcesEmpty = document.getElementById('bad-sources-empty');
                    let fraudHtml = '';
                    if (data.topBadSourcesByApp && data.topBadSourcesByApp.length > 0) {
                        data.topBadSourcesByApp.forEach((app, appIndex) => {
                            // Enhanced fraud app card with modern styling
                            fraudHtml += `<div class='bg-white rounded-2xl shadow-lg border border-red-100 mb-6 overflow-hidden hover:shadow-xl transition-all duration-300'>`;
                            
                            // Enhanced app header with gradient and icons
                            fraudHtml += `<div class='bg-gradient-to-r from-red-50 to-orange-50 px-6 py-4 border-b border-red-100'>`;
                            fraudHtml += `<div class='flex items-center justify-between'>`;
                            fraudHtml += `<div class='flex items-center gap-3'>`;
                            fraudHtml += `<div class='w-10 h-10 bg-red-100 rounded-full flex items-center justify-center'>`;
                            fraudHtml += `<svg class='w-5 h-5 text-red-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>`;
                            fraudHtml += `<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z'/>`;
                            fraudHtml += `</svg></div>`;
                            fraudHtml += `<div>`;
                            fraudHtml += `<h3 class='text-lg font-bold text-red-700'>${app.app_name}</h3>`;
                            fraudHtml += `<p class='text-sm text-red-600 font-mono'>${app.app_id}</p>`;
                            fraudHtml += `</div></div>`;
                            
                            // Add risk level badge
                            const totalFraud = app.sources ? app.sources.reduce((sum, s) => sum + s.pa_fraud + s.rt_fraud, 0) : 0;
                            let riskLevel = 'Low';
                            let riskColor = 'green';
                            if (totalFraud > 1000) { riskLevel = 'High'; riskColor = 'red'; }
                            else if (totalFraud > 100) { riskLevel = 'Medium'; riskColor = 'yellow'; }
                            
                            fraudHtml += `<div class='bg-${riskColor}-100 text-${riskColor}-800 px-3 py-1 rounded-full text-sm font-bold'>`;
                            fraudHtml += `âš ï¸ ${riskLevel} Risk`;
                            fraudHtml += `</div></div></div>`;
                            
                            if (app.sources && app.sources.length > 0) {
                                fraudHtml += `<div class='overflow-x-auto'>`;
                                fraudHtml += `<table class='w-full'>`;
                                fraudHtml += `<thead class='bg-gradient-to-r from-red-100 to-orange-100'>`;
                                fraudHtml += `<tr>`;
                                fraudHtml += `<th class='px-6 py-4 text-left text-sm font-bold text-red-800 uppercase tracking-wider'>`;
                                fraudHtml += `<div class='flex items-center gap-2'>`;
                                fraudHtml += `<svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>`;
                                fraudHtml += `<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1'/>`;
                                fraudHtml += `</svg>Media Source</div></th>`;
                                fraudHtml += `<th class='px-6 py-4 text-center text-sm font-bold text-red-800 uppercase tracking-wider'>`;
                                fraudHtml += `<div class='flex items-center justify-center gap-2'>`;
                                fraudHtml += `<svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>`;
                                fraudHtml += `<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/>`;
                                fraudHtml += `</svg>PA Fraud</div></th>`;
                                fraudHtml += `<th class='px-6 py-4 text-center text-sm font-bold text-red-800 uppercase tracking-wider'>`;
                                fraudHtml += `<div class='flex items-center justify-center gap-2'>`;
                                fraudHtml += `<svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>`;
                                fraudHtml += `<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z'/>`;
                                fraudHtml += `</svg>RT Fraud</div></th>`;
                                fraudHtml += `</tr></thead><tbody class='bg-white divide-y divide-gray-100'>`;
                                
                                app.sources.forEach((source, sourceIndex) => {
                                    fraudHtml += `<tr class='hover:bg-red-50 transition-colors duration-200'>`;
                                    fraudHtml += `<td class='px-6 py-4'>`;
                                    fraudHtml += `<div class='flex items-center gap-3'>`;
                                    fraudHtml += `<div class='w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-xs font-bold text-gray-600'>`;
                                    fraudHtml += `${sourceIndex + 1}</div>`;
                                    fraudHtml += `<div class='font-mono text-gray-900 font-medium'>${source.media_source}</div>`;
                                    fraudHtml += `</div></td>`;
                                    fraudHtml += `<td class='px-6 py-4 text-center'>`;
                                    fraudHtml += `<span class='inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800'>`;
                                    fraudHtml += `ðŸš« ${source.pa_fraud.toLocaleString()}</span></td>`;
                                    fraudHtml += `<td class='px-6 py-4 text-center'>`;
                                    fraudHtml += `<span class='inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-yellow-100 text-yellow-800'>`;
                                    fraudHtml += `âš¡ ${source.rt_fraud.toLocaleString()}</span></td>`;
                                    fraudHtml += `</tr>`;
                                });
                                fraudHtml += `</tbody></table></div>`;
                            } else {
                                fraudHtml += `<div class='p-8 text-center'>`;
                                fraudHtml += `<div class='w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3'>`;
                                fraudHtml += `<svg class='w-8 h-8 text-green-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>`;
                                fraudHtml += `<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/>`;
                                fraudHtml += `</svg></div>`;
                                fraudHtml += `<p class='text-green-700 font-medium'>No fraud sources detected</p>`;
                                fraudHtml += `<p class='text-green-600 text-sm mt-1'>This app is clean! ðŸŽ‰</p>`;
                                fraudHtml += `</div>`;
                            }
                            fraudHtml += `</div>`;
                        });
                        badSourcesList.innerHTML = fraudHtml;
                        badSourcesEmpty.style.display = 'none';
                    } else {
                        badSourcesList.innerHTML = '';
                        badSourcesEmpty.style.display = '';
                    }
                })
                .catch(error => console.error('Error fetching overview data:', error));
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recent-activity');
            container.innerHTML = '';

            activities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = 'flex items-center p-4 bg-gray-50 rounded-lg';
                
                const iconClass = getActivityIconClass(activity.type);
                const timeAgo = getTimeAgo(activity.timestamp);

                activityElement.innerHTML = `
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 ${iconClass} rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                ${getActivityIcon(activity.type)}
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-900">${activity.title}</p>
                        <p class="text-sm text-gray-500">${activity.description}</p>
                        <p class="text-xs text-gray-400 mt-1">${timeAgo}</p>
                    </div>
                `;

                container.appendChild(activityElement);
            });
        }

        function getActivityIconClass(type) {
            const classes = {
                'fraud': 'bg-red-500',
                'revenue': 'bg-green-500',
                'app': 'bg-indigo-500',
                'user': 'bg-blue-500'
            };
            return classes[type] || 'bg-gray-500';
        }

        function getActivityIcon(type) {
            const icons = {
                'fraud': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>',
                'revenue': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
                'app': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>',
                'user': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>'
            };
            return icons[type] || '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const activityTime = new Date(timestamp);
            const diffInSeconds = Math.floor((now - activityTime) / 1000);

            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Initialize Overview tab when it's active
        document.addEventListener('DOMContentLoaded', function() {
            const overviewTab = document.getElementById('overview-tab');
            if (overviewTab && overviewTab.classList.contains('active')) {
                initializeOverviewTab();
            }
        });

        // Fetch and render Top Performing Apps
        function fetchTopPerformingApps() {
            fetch('/get_stats?range=last10')
                .then(response => response.json())
                .then(data => {
                    const apps = data.apps || [];
                    const lastUpdated = data.updated_at ? `(Last updated: ${data.updated_at})` : '';
                    // Render table
                    const tbody = document.getElementById('top-apps-list');
                    let html = '';
                    // Sort apps by total events (Event 1 + Event 2) descending
                    const sortedApps = [...apps].sort((a, b) => {
                        let aSum = 0, bSum = 0;
                        if (a.selected_events && a.selected_events[0]) {
                            aSum += a.table.reduce((sum, row) => sum + (Number(row[a.selected_events[0]]) || 0), 0);
                        }
                        if (a.selected_events && a.selected_events[1]) {
                            aSum += a.table.reduce((sum, row) => sum + (Number(row[a.selected_events[1]]) || 0), 0);
                        }
                        if (b.selected_events && b.selected_events[0]) {
                            bSum += b.table.reduce((sum, row) => sum + (Number(row[b.selected_events[0]]) || 0), 0);
                        }
                        if (b.selected_events && b.selected_events[1]) {
                            bSum += b.table.reduce((sum, row) => sum + (Number(row[b.selected_events[1]]) || 0), 0);
                        }
                        return bSum - aSum;
                    });
                    sortedApps.slice(0, 5).forEach(app => {
                        let event1 = app.selected_events && app.selected_events[0] ? app.selected_events[0] : null;
                        let event2 = app.selected_events && app.selected_events[1] ? app.selected_events[1] : null;
                        // Detect error events
                        const isErrorEvent = ev => !ev || ev.toLowerCase().includes('maximum nu') || ev.toLowerCase().includes('subscription') || ev.toLowerCase().includes('error') || ev.toLowerCase().includes('failed') || ev.toLowerCase().includes("doesn't include");
                        if (isErrorEvent(event1)) event1 = null;
                        if (isErrorEvent(event2)) event2 = null;
                        let event1Sum = 0, event2Sum = 0;
                        if (event1) event1Sum = app.table.reduce((sum, row) => {
                            if (![row.impressions > 0, row.clicks > 0, row.installs > 0, row.blocked_installs_rt > 0, row.blocked_installs_pa > 0].some(Boolean)) {
                                return sum;
                            }
                            const val = Number(row[event1]);
                            return sum + (!isNaN(val) ? val : 0);
                        }, 0);
                        if (event2) event2Sum = app.table.reduce((sum, row) => {
                            if (![row.impressions > 0, row.clicks > 0, row.installs > 0, row.blocked_installs_rt > 0, row.blocked_installs_pa > 0].some(Boolean)) {
                                return sum;
                            }
                            const val = Number(row[event2]);
                            return sum + (!isNaN(val) ? val : 0);
                        }, 0);
                        // Add ranking badge for top 3
                        let rankingBadge = '';
                        const index = sortedApps.slice(0, 5).indexOf(app);
                        if (index === 0) rankingBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800 mr-2">ðŸ† #1</span>';
                        else if (index === 1) rankingBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700 mr-2">ðŸ¥ˆ #2</span>';
                        else if (index === 2) rankingBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 mr-2">ðŸ¥‰ #3</span>';
                        
                        html += `<tr class="hover:bg-yellow-50 transition-colors duration-200">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center">
                                            ${rankingBadge}
                                            <div>
                                                <div class="font-bold text-gray-900">${app.app_name}</div>
                                                <div class="text-xs text-gray-500">${app.app_id}</div>
                                                <div class="text-xs text-gray-400 mt-1">${event1 || '-'}${event2 ? ' / ' + event2 : ''}</div>
                                            </div>
                                        </div>
                                    </td>`;
                        html += `<td class="px-6 py-4 text-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${event1Sum.toLocaleString()}</span></td>`;
                        html += `<td class="px-6 py-4 text-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">${event2Sum.toLocaleString()}</span></td>`;
                        html += `<td class="px-6 py-4 text-center"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800">${(event1Sum + event2Sum).toLocaleString()}</span></td></tr>`;
                    });
                    
                    // Add fade-in animation for the table
                    tbody.style.opacity = '0';
                    tbody.innerHTML = html;
                    setTimeout(() => {
                        tbody.style.transition = 'opacity 0.5s ease-in-out';
                        tbody.style.opacity = '1';
                    }, 100);
                    // Update headers with icons
                    const event1Header = document.getElementById('event1-header');
                    const event2Header = document.getElementById('event2-header');
                    event1Header.innerHTML = '<div class="flex items-center justify-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Event 1</div>';
                    event2Header.innerHTML = '<div class="flex items-center justify-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Event 2</div>';
                })
                .catch(() => {
                    const tbody = document.getElementById('top-apps-list');
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-400 py-4">No data available. Please run the Last 10 Days report on the Stats page.</td></tr>';
                });
        }

        // Clear Backend Data button logic
        document.addEventListener('DOMContentLoaded', function() {
            const clearBtn = document.getElementById('clear-backend-cache-btn');
            if (clearBtn) {
                clearBtn.onclick = function() {
                    if (!confirm('Are you sure you want to clear all backend cached data? This action cannot be undone.')) {
                        return;
                    }
                    clearBtn.disabled = true;
                    clearBtn.textContent = 'Clearing...';
                    fetch('/clear-backend-cache', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            clearBtn.textContent = data.success ? 'Cache Cleared!' : 'Failed to Clear';
                            // Clear all UI and JS variables/localStorage
                            clearAppsUI();
                            clearStatsUI();
                            clearFraudUI();
                            clearOverviewUI();
                            setTimeout(() => {
                                clearBtn.textContent = 'Clear Backend Data';
                                clearBtn.disabled = false;
                            }, 1500);
                        })
                        .catch(() => {
                            clearBtn.textContent = 'Error';
                            setTimeout(() => {
                                clearBtn.textContent = 'Clear Backend Data';
                                clearBtn.disabled = false;
                            }, 1500);
                        });
                };
            }
            
            // Apps Cache - Use the clearAppsCache function that includes the confirmation popup
            const clearAppsBtn = document.getElementById('clear-apps-cache-btn');
            if (clearAppsBtn) {
                clearAppsBtn.onclick = clearAppsCache;
            }
            
            // Stats Cache
            const clearStatsBtn = document.getElementById('clear-stats-cache-btn');
            if (clearStatsBtn) {
                clearStatsBtn.onclick = function() {
                    clearStatsBtn.disabled = true;
                    clearStatsBtn.textContent = 'Clearing...';
                    fetch('/clear-stats-cache', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            clearStatsBtn.textContent = data.success ? 'Cache Cleared!' : 'Failed to Clear';
                            clearStatsUI();
                            setTimeout(() => {
                                clearStatsBtn.textContent = 'Clear Stats Cache';
                                clearStatsBtn.disabled = false;
                            }, 1500);
                        })
                        .catch(() => {
                            clearStatsBtn.textContent = 'Error';
                            setTimeout(() => {
                                clearStatsBtn.textContent = 'Clear Stats Cache';
                                clearStatsBtn.disabled = false;
                            }, 1500);
                        });
                };
            }
            // Fraud Cache
            const clearFraudBtn = document.getElementById('clear-fraud-cache-btn');
            if (clearFraudBtn) {
                clearFraudBtn.onclick = function() {
                    clearFraudBtn.disabled = true;
                    clearFraudBtn.textContent = 'Clearing...';
                    fetch('/clear-fraud-cache', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            clearFraudBtn.textContent = data.success ? 'Cache Cleared!' : 'Failed to Clear';
                            clearFraudUI();
                            setTimeout(() => {
                                clearFraudBtn.textContent = 'Clear Fraud Cache';
                                clearFraudBtn.disabled = false;
                            }, 1500);
                        })
                        .catch(() => {
                            clearFraudBtn.textContent = 'Error';
                            setTimeout(() => {
                                clearFraudBtn.textContent = 'Clear Fraud Cache';
                                clearFraudBtn.disabled = false;
                            }, 1500);
                        });
                };
            }
        });

        // Helper functions to clear UI and JS/localStorage
        function clearAppsUI() {
            // Clear JS variables
            window.fetchedApps = [];
            
            // Clear localStorage
            localStorage.removeItem('fetchedApps');
            localStorage.removeItem('eventSelections');
            
            // Clear UI elements
            const appsList = document.getElementById('apps-list');
            if (appsList) appsList.innerHTML = '';
            const appCount = document.getElementById('app-count');
            if (appCount) appCount.textContent = '0';
            const lastUpdated = document.getElementById('apps-last-updated');
            if (lastUpdated) lastUpdated.textContent = '';
            
            // Set a flag to prevent automatic refetching
            window.appsCacheCleared = true;
        }

        // Modify the clearStatsUI function to properly clear stats data
        function clearStatsUI() {
            // Clear JS variables
            Object.keys(statsData).forEach(range => {
                statsData[range] = null;
            });
            
            // Clear localStorage
            localStorage.removeItem('statsData');
            
            // Clear UI elements for all ranges
            ['10d','mtd','lastmonth','30d'].forEach(range => {
                const statsDiv = document.getElementById(`stats-content-${range}`);
                if (statsDiv) statsDiv.innerHTML = '';
                const statsLoading = document.getElementById(`stats-loading-${range}`);
                if (statsLoading) statsLoading.style.display = 'none';
                const statsError = document.getElementById(`stats-error-${range}`);
                if (statsError) statsError.style.display = 'none';
            });
        }

        function clearFraudUI() {
            // Clear JS variables
            window.fraudDataCache = {};
            window.fraudSourceDataCache = {};
            
            // Clear localStorage
            localStorage.removeItem('fraudDataCache');
            localStorage.removeItem('fraudSourceDataCache');
            localStorage.removeItem('fraudRange');
            localStorage.removeItem('fraudSourceRange');
            
            // Clear UI elements for all ranges
            ['10d','mtd','lastmonth','30d'].forEach(range => {
                // Clear fraud protection data
                const fraudDiv = document.getElementById(`fraud-data-${range}`);
                if (fraudDiv) fraudDiv.innerHTML = '';
                const fraudLoading = document.getElementById(`fraud-loading-${range}`);
                if (fraudLoading) fraudLoading.style.display = 'none';
                const fraudError = document.getElementById(`fraud-error-${range}`);
                if (fraudError) fraudError.style.display = 'none';
                
                // Clear fraud source data
                const fraudSourceDiv = document.getElementById(`fraud-source-data-${range}`);
                if (fraudSourceDiv) fraudSourceDiv.innerHTML = '';
                const fraudSourceLoading = document.getElementById(`fraud-source-loading-${range}`);
                if (fraudSourceLoading) fraudSourceLoading.style.display = 'none';
                const fraudSourceError = document.getElementById(`fraud-source-error-${range}`);
                if (fraudSourceError) fraudSourceError.style.display = 'none';
            });
        }

        function clearOverviewUI() {
            // Clear JS variables
            window.overviewData = null;
            
            // Clear localStorage
            localStorage.removeItem('overviewData');
            
            // Clear summary cards
            const impressionsEl = document.getElementById('overview-total-impressions');
            const clicksEl = document.getElementById('overview-total-clicks');
            const installsEl = document.getElementById('overview-total-installs');
            const conversionEl = document.getElementById('overview-conversion-rate');
            
            if (impressionsEl) impressionsEl.textContent = '0';
            if (clicksEl) clicksEl.textContent = '0';
            if (installsEl) installsEl.textContent = '0';
            if (conversionEl) conversionEl.textContent = '0%';
            
            // Clear charts if they exist
            if (window.impressionsChart) { 
                window.impressionsChart.data.labels = []; 
                window.impressionsChart.data.datasets[0].data = []; 
                window.impressionsChart.update(); 
            }
            if (window.clicksChart) { 
                window.clicksChart.data.labels = []; 
                window.clicksChart.data.datasets[0].data = []; 
                window.clicksChart.update(); 
            }
            if (window.installsChart) { 
                window.installsChart.data.labels = []; 
                window.installsChart.data.datasets[0].data = []; 
                window.installsChart.update(); 
            }
            
            // Clear top apps and fraud sources
            const topAppsList = document.getElementById('top-apps-list');
            if (topAppsList) topAppsList.innerHTML = '';
            const badSourcesList = document.getElementById('bad-sources-list');
            if (badSourcesList) badSourcesList.innerHTML = '';
            const badSourcesEmpty = document.getElementById('bad-sources-empty');
            if (badSourcesEmpty) badSourcesEmpty.style.display = '';
            
            // Clear last updated timestamps
            document.getElementById('overview-last-updated').textContent = '';
            document.getElementById('fraud-last-updated').textContent = '';
            document.getElementById('top-apps-last-updated').textContent = '';
        }

        // --- On page load or tab switch, always fetch and render cached data for all tabs and all ranges ---
        document.addEventListener('DOMContentLoaded', function() {
            // Overview
            if (document.getElementById('overview-tab')) fetchOverviewData();
            // Apps
            if (document.getElementById('apps-tab')) {
                // If the Apps tab is active (visible), force show cached data
                if (document.getElementById('apps-tab').classList.contains('active')) {
                    loadCachedApps();
                } else if (!loadCachedApps()) {
                    window.fetchedApps = [];
                    document.getElementById('app-count').textContent = '0';
                    document.getElementById('apps-last-updated').textContent = '';
                    document.getElementById('apps-list').innerHTML = '';
                }
            }
            // Stats: always render cached data if present
            if (document.getElementById('stats-tab')) {
                activateDefaultStatsTab();
                const cachedData = loadStatsData();
                if (cachedData && cachedData.apps) {
                    renderStatsApps(cachedData.apps);
                } else {
                    // Optionally, hide the stats list if no data
                    document.getElementById('stats-list').innerHTML = '';
                    document.getElementById('stats-list').style.display = 'none';
                    document.getElementById('stats-error').textContent = 'No stats data available. Please run a report.';
                    document.getElementById('stats-error').style.display = 'block';
                }
                fetchAndUpdateStats();
            }
            // Fraud: fetch and render for all ranges, then render the active one
            // ... existing code ...
        });

        // --- On tab switch, fetch and render cached data for all ranges of the selected tab ---
        const origSwitchTab6 = switchTab;
        switchTab = function(tabName) {
            origSwitchTab6(tabName);
            if (tabName === 'overview') fetchOverviewData();
            if (tabName === 'apps') {
                fetch('/api/apps-page')
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error fetching apps:', data.error);
                            document.getElementById('apps-list').innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-4">Error loading apps data. Please try again.</td></tr>';
                            document.getElementById('app-count').textContent = '0';
                            return;
                        }
                        
                        if (data.apps && Array.isArray(data.apps)) {
                            window.fetchedApps = data.apps;
                            localStorage.setItem('fetchedApps', JSON.stringify(data.apps));
                            renderAppsList(data.apps);
                            document.getElementById('app-count').textContent = data.count || data.apps.length;
                            if (data.updated_at) {
                                document.getElementById('apps-last-updated').textContent = `(Last updated: ${data.updated_at})`;
                            }
                        } else {
                            document.getElementById('apps-list').innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-4">No apps data available. Please click Get Apps to load data.</td></tr>';
                            document.getElementById('app-count').textContent = '0';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching apps:', error);
                        document.getElementById('apps-list').innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-4">Error loading apps data. Please try again.</td></tr>';
                        document.getElementById('app-count').textContent = '0';
                    });
            }
            if (tabName === 'stats') {
                // Visually activate the 'Last 10 Days' tab
                document.querySelectorAll('.date-range-tab').forEach(btn => {
                    btn.classList.remove('border-green-600','text-green-700','bg-white');
                    btn.classList.add('border-transparent','text-gray-500','hover:text-green-700','hover:border-green-400');
                });
                document.querySelector('.date-range-tab[data-range="10d"]').classList.remove('border-transparent','text-gray-500','hover:text-green-700','hover:border-green-400');
                document.querySelector('.date-range-tab[data-range="10d"]').classList.add('border-green-600','text-green-700','bg-white');
                document.querySelectorAll('.stats-range-content').forEach(div => div.style.display = 'none');
                document.getElementById('stats-content-10d').style.display = '';
                // Fetch and render the default range (10d)
                fetch('/get_subpage_10d')
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.apps && data.apps.length > 0) {
                            renderStatsAppsForRange('10d', data.apps);
                            document.getElementById('stats-error').style.display = 'none';
                        } else {
                            document.getElementById('stats-data-10d').innerHTML = '<div class="text-gray-400 py-4 text-center">No cached stats data available. Please run a report to load data.</div>';
                            document.getElementById('stats-error').style.display = '';
                        }
                    })
                    .catch(() => {
                        document.getElementById('stats-data-10d').innerHTML = '<div class="text-red-500 py-4 text-center">Error loading stats data for this range.</div>';
                        document.getElementById('stats-error').style.display = '';
                    });
            }
            if (tabName === 'fraud') {
                // Instead of /api/fraud-page, fetch /get_fraud_subpage_10d for logging and default data
                fetch('/get_fraud_subpage_10d').then(() => {
                    // Fraud Protection sub-page will handle showing the data
                });
            }
            if (tabName === 'profile') loadProfile();
        };

        // Helper to get the currently active stats range
        function getActiveStatsRange() {
            // Always default to '10d' (Last 10 Days)
            return '10d';
        }
        // Helper to get the currently active fraud range
        function getActiveFraudRange() {
            const activeBtn = document.querySelector('.fraud-range-tab.border-green-600');
            return activeBtn ? activeBtn.getAttribute('data-range') : '10d';
        }

        // Removed Select App dropdown as it's redundant with main header filter

        // Removed dropdown population code as it's no longer needed

        // Use fraud source filter for fraud source filtering
        window.selectedFraudSourceAppId = window.selectedFraudSourceAppId || '';
        
        // Listen to fraud source filter changes - CACHE ONLY, NO API CALLS
        function updateFraudSourceFilter() {
          const sourceFilter = document.getElementById('fraud-source-app-filter');
          if (sourceFilter) {
            window.selectedFraudSourceAppId = sourceFilter.value;
            console.log('ðŸ”„ Selected fraud source app:', window.selectedFraudSourceAppId, '(cache only)');
            
            // Immediately show data for this app from cache only
          const activeRange = getActiveFraudSourceRange();
          if (fraudSourceDataCache[activeRange]) {
              console.log('âœ… Rendering fraud source data from cache for app:', window.selectedFraudSourceAppId);
            renderFraudSource(fraudSourceDataCache[activeRange], activeRange);
            } else if (window.selectedFraudSourceAppId) {
              // No cached data - show informational message (NO API CALLS)
              console.log('âš ï¸ No cached fraud data available for selected app');
              const container = document.getElementById(`fraud-source-data-${activeRange}`);
              if (container) {
                container.innerHTML = `
                  <div class="text-center py-12">
                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-8 max-w-lg mx-auto">
                      <div class="text-blue-400 mb-6">
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                      <div class="text-blue-700 text-xl font-bold mb-3">ðŸ“Š No Cache Available</div>
                      <div class="text-blue-600 text-base leading-relaxed mb-4">
                        Selected campaign: <strong>${window.selectedFraudSourceAppId}</strong><br/>
                        No cached fraud data available for this campaign.
                      </div>
                      <div class="text-left bg-white/80 p-4 rounded-xl border border-blue-300">
                        <div class="text-blue-700 font-medium mb-2">To load data:</div>
                        <div class="text-sm text-blue-600 space-y-1">
                          <div>â€¢ Go to <strong>Fraud Analytics</strong> â†’ Press <strong>Generate Report</strong></div>
                          <div>â€¢ Or use <strong>Get All Stats</strong> button in Action Center</div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }
            }
          }
        }
        
        // Add event listener to fraud source filter
        document.addEventListener('DOMContentLoaded', function() {
          const sourceFilter = document.getElementById('fraud-source-app-filter');
          if (sourceFilter) {
            sourceFilter.addEventListener('change', updateFraudSourceFilter);
            
            // Add visual feedback when filter changes
            sourceFilter.addEventListener('change', function() {
              const selectedOption = this.options[this.selectedIndex];
              if (selectedOption && selectedOption.value) {
                // Show loading state briefly
                this.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                this.style.color = '#6366f1';
                
                setTimeout(() => {
                  this.style.backgroundColor = 'rgba(255, 255, 255, 0.98)';
                  this.style.color = '#1f2937';
                }, 300);
              }
            });

            // Add hover effect for the dropdown arrow
            const parentDiv = sourceFilter.closest('.relative');
            if (parentDiv) {
              const dropdownArrow = parentDiv.querySelector('svg:last-child');
              if (dropdownArrow) {
                sourceFilter.addEventListener('mouseenter', function() {
                  dropdownArrow.style.transform = 'rotate(180deg)';
                });
                sourceFilter.addEventListener('mouseleave', function() {
                  dropdownArrow.style.transform = 'rotate(0deg)';
                });
              }
            }
          }
        });

        // Update renderFraudSource to filter by selected app
        const origRenderFraudSource = window.renderFraudSource;
        window.renderFraudSource = function(data, range) {
          // Get the currently selected app from the global variable or filter
          const currentSelectedApp = window.selectedFraudSourceAppId || 
                                   document.getElementById('fraud-source-app-filter')?.value;
          
          console.log('ðŸ” renderFraudSource called with:', { 
            windowVar: window.selectedFraudSourceAppId, 
            filterValue: document.getElementById('fraud-source-app-filter')?.value,
            currentSelectedApp,
            dataApps: data?.apps?.length || 0
          });
          
          if (currentSelectedApp) {
            // Only show the selected app
            const filtered = { ...data, apps: (data.apps || []).filter(app => app.app_id === currentSelectedApp) };
            console.log('âœ… Filtering fraud data for app:', currentSelectedApp, 'found apps:', filtered.apps.length);
            origRenderFraudSource(filtered, range);
          } else {
            console.log('âš ï¸ No app selected, showing selection prompt');
            // If no app selected, show a prompt
            const container = document.getElementById(`fraud-source-data-${range}`);
            container.innerHTML = '<div class="text-center py-20"><div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-3xl p-6 max-w-lg mx-auto shadow-lg"><div class="text-indigo-400 mb-6"><svg class="w-20 h-20 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div><div class="text-indigo-700 text-xl font-bold mb-3">ðŸŽ¯ Select a Campaign</div><div class="text-indigo-600 text-base leading-relaxed">Choose a campaign from the filter above to analyze its fraud sources and media performance.</div></div></div>';
          }
        };

        // 5. Helper to get currently active fraud source range
        function getActiveFraudSourceRange() {
          const activeBtn = document.querySelector('.fraud-source-range-tab.border-green-600');
          return activeBtn ? activeBtn.getAttribute('data-range') : '10d';
        }

        // Add stats data persistence functions
        function saveStatsData(data) {
            if (data && data.apps && data.apps.length > 0) {
                localStorage.setItem('statsData', JSON.stringify(data));
            }
        }

        function loadStatsData() {
            const cachedData = localStorage.getItem('statsData');
            if (cachedData) {
                try {
                    return JSON.parse(cachedData);
                } catch (e) {
                    console.error('Error parsing cached stats data:', e);
                }
            }
            return null;
        }

        function clearStatsData() {
            localStorage.removeItem('statsData');
            const statsList = document.getElementById('stats-list');
            const error = document.getElementById('stats-error');
            statsList.style.display = 'none';
            error.textContent = 'No stats data available. Please run a report.';
            error.style.display = 'block';
        }

        // Modify the stats rendering to use cached data
        function renderStatsApps(apps) {
            const statsList = document.getElementById('stats-list');
            statsList.innerHTML = '';
            apps.forEach(app => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${app.app_id}</td>
                    <td class="py-3 px-4 text-gray-800">${app.app_name}</td>
                    <td class="py-3 px-4 text-gray-800">${app.event1 || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-800">${app.event2 || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-800">${app.total_events || '0'}</td>
                `;
                statsList.appendChild(tr);
            });
            statsList.style.display = 'block';
            document.getElementById('stats-error').style.display = 'none';
        }

        // Modify the fetchStats function to use cached data
        function fetchStats() {
            const loading = document.getElementById('stats-loading');
            const error = document.getElementById('stats-error');
            const statsList = document.getElementById('stats-list');
            
            // Check for cached data first
            const cachedData = loadStatsData();
            if (cachedData) {
                renderStatsApps(cachedData.apps);
                return;
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            statsList.style.display = 'none';

            fetch('/get_stats')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    if (data && data.apps) {
                        saveStatsData(data); // Save to localStorage
                        renderStatsApps(data.apps);
                    } else {
                        error.textContent = 'No stats data available. Please run a report.';
                        error.style.display = 'block';
                    }
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.textContent = 'Error fetching stats data. Please try again.';
                    error.style.display = 'block';
                });
        }

        // Modify the clear cache button to also clear stats data
        document.getElementById('clear-backend-cache-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all cached data? This will remove all stored data from the UI.')) {
                clearStatsData();
                // ... existing clear cache code ...
            }
        });

        // Add initialization code to load cached stats data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load cached stats data
            loadStatsData();
            
            // If we're on the stats tab, render the cached data for the active range
            if (document.getElementById('stats-tab') && document.getElementById('stats-tab').classList.contains('active')) {
                const activeRange = getActiveStatsRange();
                if (statsData[activeRange]) {
                    renderStatsAppsForRange(activeRange, statsData[activeRange].apps || []);
                }
            }
        });

        // Helper to load cached apps from localStorage
        function loadCachedApps() {
            const cached = localStorage.getItem('fetchedApps');
            if (cached) {
                try {
                    window.fetchedApps = JSON.parse(cached);
                    if (Array.isArray(window.fetchedApps) && window.fetchedApps.length > 0) {
                        renderAppsList(window.fetchedApps);
                        document.getElementById('app-count').textContent = window.fetchedApps.length;
                        return true;
                    }
                } catch (e) { window.fetchedApps = []; }
            }
            return false;
        }

        // Helper to fetch fresh apps from backend and update cache/UI
        function fetchAndUpdateApps() {
            setFetchButtonsDisabled(true);
            const button = document.getElementById('get-apps-btn');
            if (button) button.innerHTML = '<span class="animate-spin">âŒ›</span> Loading...';
            fetch('/get_apps')
                .then(response => response.text())
                .then(text => {
                    let data;
                    try { data = JSON.parse(text); } catch (e) { data = null; }
                    setFetchButtonsDisabled(false);
                    if (button) button.innerHTML = 'Get Apps';
                    if (!data || data.error) return;
                    window.fetchedApps = data.apps;
                    localStorage.setItem('fetchedApps', JSON.stringify(window.fetchedApps));
                    renderAppsList(window.fetchedApps);
                    document.getElementById('app-count').textContent = data.count;
                    document.getElementById('apps-last-updated').textContent = data.fetch_time ? `(Last updated: ${data.fetch_time})` : '';
                })
                .catch(() => {
                    setFetchButtonsDisabled(false);
                    if (button) button.innerHTML = 'Get Apps';
                });
        }

        // Helper to fetch fresh stats from backend and update cache/UI
        function fetchAndUpdateStats() {
            // For simplicity, just fetch for the default range (10d)
            fetch('/get_stats?range=10d')
                .then(response => response.json())
                .then(data => {
                    if (data && data.apps) {
                        localStorage.setItem('statsData', JSON.stringify({ '10d': data }));
                        renderStatsAppsForRange('10d', data.apps);
                    }
                });
        }

        // Helper to fetch fresh fraud data from backend and update cache/UI
        function fetchAndUpdateFraud() {
            // For simplicity, just fetch for the default range (10d)
            fetch('/get_fraud', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apps: window.fetchedApps || [], period: 'last10' })
            })
            .then(r => r.json())
            .then(data => {
                if (data && data.apps) {
                    // You may want to cache this in localStorage as well
                    renderFraudAll(data, '10d');
                }
            });
        }

        // Add this to your existing JavaScript code
        function populateAppsList(apps) {
            const appsList = document.getElementById('apps-list');
            appsList.innerHTML = '';
            
            apps.forEach(app => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-900">${app.app_id}</td>
                    <td class="py-3 px-4 text-sm text-gray-900">${app.app_name}</td>
                    <td class="py-3 px-4">
                        <div class="relative">
                            <select class="status-select w-full pl-3 pr-8 py-2 text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                    data-app-id="${app.app_id}">
                                <option value="active" ${app.is_active ? 'selected' : ''}>Active</option>
                                <option value="not_active" ${!app.is_active ? 'selected' : ''}>Not Active</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12l-5-5 1.41-1.41L10 9.17l3.59-3.58L15 7l-5 5z"/>
                                </svg>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="relative">
                            <select class="event-select w-full pl-3 pr-8 py-2 text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                    data-app-id="${app.app_id}" 
                                    data-event-num="1">
                                <option value="">No Events Found.</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12l-5-5 1.41-1.41L10 9.17l3.59-3.58L15 7l-5 5z"/>
                                </svg>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="relative">
                            <select class="event-select w-full pl-3 pr-8 py-2 text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                    data-app-id="${app.app_id}" 
                                    data-event-num="2">
                                <option value="">No Events Found.</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12l-5-5 1.41-1.41L10 9.17l3.59-3.58L15 7l-5 5z"/>
                                </svg>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <button class="save-events-btn bg-green-500 hover:bg-green-600 text-white px-4 py-1.5 rounded text-sm font-medium transition-colors" 
                                data-app-id="${app.app_id}">
                            SAVE
                        </button>
                    </td>
                `;
                appsList.appendChild(row);
            });

            // Add event listeners for status dropdowns
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', function() {
                    const appId = this.dataset.appId;
                    const isActive = this.value === 'active';
                    updateAppActiveStatus(appId, isActive);
                });
            });
        }

        function updateAppActiveStatus(appId, isActive) {
            fetch('/update-app-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    app_id: appId,
                    is_active: isActive
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Updated active status for app ${appId}`);
                } else {
                    console.error('Failed to update app status');
                }
            })
            .catch(error => {
                console.error('Error updating app status:', error);
            });
        }

        // Add custom styles for the checkbox
        const style = document.createElement('style');
        style.textContent = `
            .app-active-checkbox:checked {
                background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
                background-color: #10B981;
                border-color: #10B981;
            }
            .app-active-checkbox:checked:hover {
                background-color: #059669;
                border-color: #059669;
            }
            .app-active-checkbox:checked:focus {
                box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            }
        `;
        document.head.appendChild(style);

        function clearAppsCache() {
            if (!confirm('Are you sure you want to clear the apps cache? This will remove cache for all "Not Active" apps while preserving "Active" apps and their events.')) {
                return;
            }

            const button = document.getElementById('clear-apps-cache-btn');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Clearing...';

            fetch('/clear-apps-cache', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show toast message
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    toast.innerHTML = `
                        <div class="font-medium">Cache Status</div>
                        <div class="text-sm mt-1">
                            â€¢ Preserved cache for ${data.active_apps_count} apps with "Active" status<br>
                            â€¢ Preserved events for ${data.events_preserved} active apps<br>
                            â€¢ Cleared cache and events for all "Not Active" apps
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 5000);
                    
                    // Refresh the apps list
                    fetchApps();
                } else {
                    alert('Error clearing cache: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing cache. Please try again.');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }

        // Auto-run system for Get All Stats
        let autoRunTimer = null;
        let countdownTimer = null;
        let isAutoRunExecuting = false; // Flag to prevent concurrent executions
        const AUTO_RUN_INTERVAL = 6 * 60 * 60 * 1000; // 6 hours in milliseconds
        
        // Function to execute Get All Stats
        async function executeGetAllStats(isAutoRun = false) {
            // Prevent concurrent executions
            if (isAutoRunExecuting) {
                console.log('Auto-run already executing, skipping...');
                return;
            }
            
            // Try to load cached apps if not already loaded
            if (!window.fetchedApps || !window.fetchedApps.length) {
                console.log('Attempting to load cached apps...');
                if (loadCachedApps()) {
                    console.log('Cached apps loaded successfully');
                } else {
                    if (isAutoRun) {
                        console.log('Auto-run skipped: No active apps loaded and no cached apps available');
                        return;
                    }
                    alert('No apps loaded. Please go to Apps tab and click Get Apps first.');
                    return;
                }
            }
            
            // Filter to only active apps
            const activeApps = window.fetchedApps.filter(app => app.is_active === true);
            if (activeApps.length === 0) {
                if (isAutoRun) {
                    console.log('Auto-run skipped: No active apps found');
                    return;
                }
                alert('No active apps found. Please ensure you have active apps configured.');
                return;
            }
            
            const button = document.getElementById('get-all-stats-btn');
            const originalText = button.textContent;
            
            // Show confirmation only for manual runs
            if (!isAutoRun) {
            if (!confirm('This will generate reports for all time periods. It may take several minutes. Continue?')) {
                return;
                }
            }
            
            // Set execution flag
            isAutoRunExecuting = true;
            
            button.disabled = true;
            button.textContent = isAutoRun ? 'Auto-Generating Reports...' : 'Generating Reports...';
            
            const periods = ['last10'];
            const fraudPeriods = ['10d'];
            
            try {
                // Create progress container
                const progressContainer = document.createElement('div');
                progressContainer.className = 'mt-4 p-4 bg-gray-50 rounded-lg';
                progressContainer.innerHTML = '<div class="text-sm text-gray-600">Progress:</div><div id="report-progress" class="mt-2"></div>';
                button.parentNode.appendChild(progressContainer);
                const progressDiv = document.getElementById('report-progress');

                // Function to update progress
                const updateProgress = (message) => {
                    const progressItem = document.createElement('div');
                    progressItem.className = 'text-sm text-gray-700 mb-1';
                    progressItem.textContent = message;
                    progressDiv.appendChild(progressItem);
                    progressDiv.scrollTop = progressDiv.scrollHeight;
                };

                // Function to poll report status
                const pollReportStatus = async (jobId, period) => {
                    let retries = 0;
                    const maxRetries = 3;
                    
                    while (true) {
                        try {
                        const response = await fetch(`/report-status/${jobId}`);
                        const data = await response.json();
                        
                        if (data.status === 'completed') {
                            updateProgress(`âœ“ Completed report for ${period}`);
                            return true;
                        } else if (data.status === 'failed') {
                            updateProgress(`âœ— Failed to generate report for ${period}`);
                            return false;
                            } else if (data.error && data.error.includes('BrokenPipeError')) {
                                updateProgress(`âš  Connection error for ${period}, continuing to next period...`);
                                return true;  // Continue to next period
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 5000));
                        } catch (error) {
                            retries++;
                            if (retries >= maxRetries) {
                                updateProgress(`âš  Connection error for ${period}, continuing to next period...`);
                                return true;  // Continue to next period
                            }
                            await new Promise(resolve => setTimeout(resolve, 5000));
                        }
                    }
                };

                // Sequential stats reports
                const runStatsReports = async () => {
                for (const period of periods) {
                    updateProgress(`Starting stats report for ${period}...`);
                        
                        try {
                    const response = await fetch('/start-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                                    apps: activeApps,
                            period: period,
                            selected_events: JSON.parse(localStorage.getItem('eventSelections') || '{}')
                        })
                    });
                            
                    const data = await response.json();
                            
                    if (data.status === 'processing') {
                        await pollReportStatus(data.job_id, period);
                                
                                // After processing, fetch the actual data
                                try {
                                    const statsResponse = await fetch(`/get_subpage_${period}`);
                                    const statsData = await statsResponse.json();
                                    
                                    if (statsData && statsData.apps && statsData.apps.length > 0) {
                                        console.log(`âœ… Stats data cached for ${period}:`, statsData.apps.length, 'apps');
                                        updateProgress(`âœ… Stats data cached for ${period} (${statsData.apps.length} apps)`);
                                    }
                                } catch (fetchError) {
                                    console.log(`âš ï¸ Could not fetch stats data for ${period}:`, fetchError);
                                }
                            } else {
                                console.log(`âš ï¸ Stats report failed for ${period}:`, data);
                                updateProgress(`âš ï¸ Stats report failed for ${period}`);
                            }
                        } catch (error) {
                            console.error(`âŒ Error starting stats report for ${period}:`, error);
                            updateProgress(`âŒ Stats report failed for ${period}: ${error.message}`);
                    }
                }
                };

                // Sequential fraud reports
                const runFraudReports = async () => {
                for (const period of fraudPeriods) {
                    updateProgress(`Starting fraud report for ${period}...`);
                        
                        // Map period to correct format for fraud API
                        const fraudPeriod = period === '10d' ? 'last10' : period;
                        
                        try {
                    const response = await fetch('/get_fraud', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                                    apps: activeApps,
                                    period: fraudPeriod
                        })
                    });
                            
                    const data = await response.json();
                            
                            if (data && data.apps && data.apps.length > 0) {
                                // Cache the fraud data for both Analytics and Source tabs
                                fraudDataCache[period] = data;
                                fraudSourceDataCache[period] = data;
                                
                                console.log(`âœ… Fraud data cached for ${period}:`, data.apps.length, 'apps');
                                updateProgress(`âœ… Fraud data cached for ${period} (${data.apps.length} apps)`);
                                
                                // Auto-select first app for fraud source if none selected
                                if (period === '10d' && !window.selectedFraudSourceAppId && data.apps.length > 0) {
                                    const firstAppWithData = data.apps.find(app => app.table && app.table.length > 0) || data.apps[0];
                                    if (firstAppWithData) {
                                        window.selectedFraudSourceAppId = firstAppWithData.app_id;
                                        
                                        // Update the dropdown if it exists
                                        const sourceFilter = document.getElementById('fraud-source-app-filter');
                                        if (sourceFilter) {
                                            sourceFilter.value = firstAppWithData.app_id;
                                        }
                                        
                                        console.log(`âœ… Auto-selected fraud source app: ${firstAppWithData.app_name} (${firstAppWithData.app_id})`);
                                    }
                                }
                            } else if (data.status === 'processing') {
                        await pollReportStatus(data.job_id, `fraud-${period}`);
                            } else {
                                console.log(`âš ï¸ No fraud data returned for ${period}`);
                                updateProgress(`âš ï¸ No fraud data for ${period}`);
                            }
                        } catch (error) {
                            console.error(`âŒ Error fetching fraud data for ${period}:`, error);
                            updateProgress(`âŒ Fraud report failed for ${period}: ${error.message}`);
                        }
                    }
                };

                // Run both in parallel and track completion
                console.log('ðŸš€ Starting parallel execution: Stats + Fraud reports...');
                updateProgress('ðŸš€ Running Stats and Fraud reports in parallel...');
                
                const startTime = Date.now();
                const [statsResult, fraudResult] = await Promise.all([
                    runStatsReports().then(result => {
                        console.log('âœ… Stats reports completed successfully');
                        updateProgress('âœ… Stats reports completed successfully');
                        return result;
                    }).catch(error => {
                        console.error('âŒ Stats reports failed:', error);
                        updateProgress('âŒ Stats reports failed: ' + error.message);
                        throw error;
                    }),
                    runFraudReports().then(result => {
                        console.log('âœ… Fraud reports completed successfully');
                        updateProgress('âœ… Fraud reports completed successfully');
                        return result;
                    }).catch(error => {
                        console.error('âŒ Fraud reports failed:', error);
                        updateProgress('âŒ Fraud reports failed: ' + error.message);
                        throw error;
                    })
                ]);
                
                const executionTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`ðŸŽ‰ Both functions completed in ${executionTime} seconds`);
                updateProgress(`ðŸŽ‰ Both reports completed in ${executionTime} seconds`);

                // Comprehensive dashboard refresh with detailed progress
                updateProgress('ðŸ”„ Refreshing all dashboard pages...');
                console.log('ðŸ”„ Starting comprehensive dashboard refresh...');
                
                // Force refresh all tabs with new data
                await refreshAllDashboardData();
                
                // Additional specific refreshes to ensure data is current
                updateProgress('ðŸ“Š Updating Stats page...');
                await forceRefreshStatsPage();
                
                updateProgress('ðŸ›¡ï¸ Updating Fraud pages...');
                await forceRefreshFraudPages();
                
                updateProgress('ðŸ“ˆ Updating Overview charts...');
                await forceRefreshOverviewData();
                
                // Completion notifications
                const completionMessage = isAutoRun ? 'Auto-reports generated successfully!' : 'All reports generated successfully!';
                updateProgress(`âœ… ${completionMessage}`);
                button.textContent = isAutoRun ? 'Auto-Reports Generated!' : 'Reports Generated!';
                
                // Update last run time
                updateLastRunTime();
                
                // Show completion alert and final status
                console.log('ðŸŽ‰ =================================');
                console.log('ðŸŽ‰ GET ALL STATS COMPLETED SUCCESSFULLY');
                console.log('ðŸŽ‰ =================================');
                console.log(`ðŸ“Š Stats reports: âœ… Completed`);
                console.log(`ðŸ›¡ï¸ Fraud reports: âœ… Completed`);
                console.log(`â±ï¸ Total execution time: ${executionTime} seconds`);
                console.log(`ðŸ”„ Dashboard refresh: âœ… Completed`);
                console.log(`ðŸ“± Active apps processed: ${activeApps.length}`);
                console.log('ðŸŽ‰ =================================');
                
                // Show user-friendly completion notification
                if (!isAutoRun) {
                    showCompletionAlert(activeApps.length, executionTime);
                }
                
                // Final progress update
                updateProgress('ðŸŽ‰ All tasks completed! Pages refreshed with new data.');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    progressContainer.remove();
                    
                    // Clear execution flag
                    isAutoRunExecuting = false;
                    
                    // Only reset timer if this was an auto-run
                    if (isAutoRun) {
                        resetAutoRunTimer();
                    }
                    
                    // Show final success toast
                    const finalMessage = isAutoRun ? 
                        'Auto-reports completed! All pages updated with fresh data.' : 
                        'Reports completed! All pages updated with fresh data.';
                    showCompletionToast(finalMessage);
                }, 3000); // Extended delay to show completion message
                
            } catch (error) {
                console.error('Error generating reports:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'text-red-500 mt-2';
                errorMessage.textContent = 'Error: ' + error.message;
                button.parentNode.appendChild(errorMessage);
                button.textContent = 'Error Generating Reports';
                
                // Clear execution flag on error
                isAutoRunExecuting = false;
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    errorMessage.remove();
                    progressContainer.remove();
                    
                    // Reset timer even on error to prevent getting stuck
                    if (isAutoRun) {
                        resetAutoRunTimer();
                    }
                }, 5000);
            }
        }
        
        // Function to update last run time
        function updateLastRunTime() {
            const now = new Date();
            const timeString = now.toLocaleString();
            document.getElementById('last-run-time').textContent = timeString;
            localStorage.setItem('lastRunTime', now.toISOString());
            console.log('âœ… Last run time updated:', timeString);
        }
        
        // Function to reset auto-run timer
        function resetAutoRunTimer() {
            // Clear existing timers
            if (autoRunTimer) {
                clearTimeout(autoRunTimer);
                autoRunTimer = null;
            }
            
            // Don't restart timer if execution is in progress
            if (isAutoRunExecuting) {
                console.log('â¸ï¸ Auto-run timer reset skipped - execution in progress');
                return;
            }
            
            // Calculate remaining time based on last run
            const lastRunTime = localStorage.getItem('lastRunTime');
            let remainingTime;
            
            if (lastRunTime) {
                const lastRun = new Date(lastRunTime);
                const timeSinceLastRun = Date.now() - lastRun.getTime();
                remainingTime = Math.max(0, AUTO_RUN_INTERVAL - timeSinceLastRun);
            } else {
                remainingTime = AUTO_RUN_INTERVAL;
            }
            
            const remainingHours = Math.floor(remainingTime / (1000 * 60 * 60));
            const remainingMinutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
            
            console.log(`ðŸ”„ Setting auto-run timer for ${remainingHours}h ${remainingMinutes}m...`);
            
            if (remainingTime <= 0) {
                // Should run immediately
                console.log('â° Auto-run overdue - executing immediately...');
                executeGetAllStats(true);
                return;
            }
            
            autoRunTimer = setTimeout(() => {
                console.log('â° Auto-run timer triggered - executing Get All Stats...');
                executeGetAllStats(true);
            }, remainingTime);
            
            // Reset countdown
            startCountdown();
        }
        
        // Function to start countdown timer
        function startCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // Calculate end time based on last run time, not current time
            const lastRunTime = localStorage.getItem('lastRunTime');
            let endTime;
            
            if (lastRunTime) {
                const lastRun = new Date(lastRunTime);
                endTime = lastRun.getTime() + AUTO_RUN_INTERVAL;
            } else {
                // If no last run time, use current time + interval
                endTime = Date.now() + AUTO_RUN_INTERVAL;
            }
            
            countdownTimer = setInterval(() => {
                const now = Date.now();
                const remaining = endTime - now;
                
                if (remaining <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    document.getElementById('next-run-countdown').textContent = '00:00:00';
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('next-run-countdown').textContent = timeString;
            }, 1000);
        }
        
        // Function to initialize auto-run system
        function initializeAutoRunSystem() {
            console.log('ðŸš€ Initializing auto-run system...');
            
            // Load last run time from localStorage
            const lastRunTime = localStorage.getItem('lastRunTime');
            if (lastRunTime) {
                const lastRun = new Date(lastRunTime);
                document.getElementById('last-run-time').textContent = lastRun.toLocaleString();
                
                // Check if we should run immediately based on last run time
                const timeSinceLastRun = Date.now() - lastRun.getTime();
                const remainingTime = Math.max(0, AUTO_RUN_INTERVAL - timeSinceLastRun);
                
                const hoursAgo = Math.floor(timeSinceLastRun / (1000 * 60 * 60));
                const minutesAgo = Math.floor((timeSinceLastRun % (1000 * 60 * 60)) / (1000 * 60));
                const remainingHours = Math.floor(remainingTime / (1000 * 60 * 60));
                const remainingMinutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                
                console.log(`â° Last run was ${hoursAgo}h ${minutesAgo}m ago`);
                console.log(`â° Time until next run: ${remainingHours}h ${remainingMinutes}m`);
                
                if (remainingTime <= 0) {
                    console.log('ðŸ“… Auto-run is overdue, scheduling immediate execution...');
                    // It's been more than 6 hours, run immediately
                    setTimeout(() => {
                        console.log('ðŸš€ Auto-running Get All Stats (overdue)...');
                        executeGetAllStats(true);
                    }, 10000); // Give 10 seconds delay to ensure page is fully loaded
                    return;
                } else {
                    console.log('âœ… Auto-run is not overdue, starting normal timer...');
                }
            } else {
                console.log('ðŸ“ No previous run time found, starting fresh timer...');
            }
            
            // Start the auto-run timer
            resetAutoRunTimer();
            
            // Update countdown display immediately
            updateCountdownDisplay();
        }
        
        // Function to update countdown display immediately
        function updateCountdownDisplay() {
            const lastRunTime = localStorage.getItem('lastRunTime');
            if (!lastRunTime) {
                document.getElementById('next-run-countdown').textContent = '06:00:00';
                return;
            }
            
            const lastRun = new Date(lastRunTime);
            const endTime = lastRun.getTime() + AUTO_RUN_INTERVAL;
            const now = Date.now();
            const remaining = Math.max(0, endTime - now);
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('next-run-countdown').textContent = timeString;
        }
        
        // Add event listener for Get All Stats button (manual execution)
        document.getElementById('get-all-stats-btn').addEventListener('click', async function() {
            await executeGetAllStats(false);
        });
        
        // Debug function to check auto-run system status
        window.debugAutoRunSystem = function() {
            console.log('=== Auto-Run System Status ===');
            console.log('Auto-run timer active:', autoRunTimer !== null);
            console.log('Countdown timer active:', countdownTimer !== null);
            console.log('Execution in progress:', isAutoRunExecuting);
            
            const lastRunTime = localStorage.getItem('lastRunTime');
            console.log('Last run time:', lastRunTime);
            
            if (lastRunTime) {
                const lastRun = new Date(lastRunTime);
                const timeSinceLastRun = Date.now() - lastRun.getTime();
                const remainingTime = Math.max(0, AUTO_RUN_INTERVAL - timeSinceLastRun);
                
                const hoursAgo = Math.floor(timeSinceLastRun / (1000 * 60 * 60));
                const minutesAgo = Math.floor((timeSinceLastRun % (1000 * 60 * 60)) / (1000 * 60));
                const remainingHours = Math.floor(remainingTime / (1000 * 60 * 60));
                const remainingMinutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                
                console.log(`Time since last run: ${hoursAgo}h ${minutesAgo}m`);
                console.log(`Time until next run: ${remainingHours}h ${remainingMinutes}m`);
                console.log('Next run overdue:', remainingTime <= 0);
            }
            
            console.log('Fetched apps:', window.fetchedApps ? window.fetchedApps.length : 'None');
            if (window.fetchedApps) {
                const activeApps = window.fetchedApps.filter(app => app.is_active === true);
                console.log('Active apps:', activeApps.length);
                console.log('Active apps list:', activeApps.map(app => app.app_name));
            }
            console.log('Auto-run interval (hours):', AUTO_RUN_INTERVAL / (1000 * 60 * 60));
            console.log('Current time:', new Date().toLocaleString());
            console.log('================================');
        };
        
        // Function to manually stop auto-run system
        window.stopAutoRunSystem = function() {
            console.log('ðŸ›‘ Stopping auto-run system...');
            if (autoRunTimer) {
                clearTimeout(autoRunTimer);
                autoRunTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            isAutoRunExecuting = false;
            document.getElementById('next-run-countdown').textContent = 'STOPPED';
            console.log('âœ… Auto-run system stopped');
        };
        
        // Function to manually start auto-run system
        window.startAutoRunSystem = function() {
            console.log('â–¶ï¸ Starting auto-run system...');
            initializeAutoRunSystem();
            console.log('âœ… Auto-run system started');
        };
        
        // Function to manually trigger auto-run for testing
        window.testAutoRun = function() {
            console.log('ðŸ§ª Manually triggering auto-run for testing...');
            executeGetAllStats(true);
        };
        
        // Function to manually test Get All Stats
        window.testGetAllStats = function() {
            console.log('ðŸ§ª Manually triggering Get All Stats for testing...');
            executeGetAllStats(false);
        };
        
        // Function to manually refresh fraud source from backend
        window.refreshFraudSourceFromBackend = function() {
            console.log('ðŸ”„ Manually refreshing fraud source from backend...');
            initializeFraudSource();
        };
        
        // Debug function to check fraud source cache and selection
        window.debugFraudSource = function() {
            console.log('=== Fraud Source Debug Information ===');
            console.log('ðŸ“Š Frontend Cache Status:');
            console.log('â€¢ fraudDataCache (Analytics):', fraudDataCache);
            console.log('â€¢ fraudSourceDataCache (Per Source):', fraudSourceDataCache);
            
            if (fraudSourceDataCache['10d']) {
                console.log('â€¢ Source cache has data for 10d:', fraudSourceDataCache['10d'].apps ? fraudSourceDataCache['10d'].apps.length + ' apps' : 'No apps');
                if (fraudSourceDataCache['10d'].apps) {
                    console.log('â€¢ Apps in source cache:', fraudSourceDataCache['10d'].apps.map(app => `${app.app_name} (${app.app_id})`));
                }
            } else {
                console.log('â€¢ No source cache data for 10d');
            }
            
            if (fraudDataCache['10d']) {
                console.log('â€¢ Analytics cache has data for 10d:', fraudDataCache['10d'].apps ? fraudDataCache['10d'].apps.length + ' apps' : 'No apps');
            } else {
                console.log('â€¢ No analytics cache data for 10d');
            }
            
            // Check backend cache
            console.log('\nðŸ”„ Checking Backend Cache:');
            fetch('/get_fraud_subpage_10d')
                .then(r => r.json())
                .then(data => {
                    if (data && data.apps) {
                        console.log('â€¢ Backend cache has data:', data.apps.length, 'apps');
                        console.log('â€¢ Backend updated at:', data.updated_at);
                        console.log('â€¢ Apps in backend:', data.apps.map(app => `${app.app_name} (${app.app_id})`));
                    } else {
                        console.log('â€¢ No backend cache data available');
                    }
                })
                .catch(error => {
                    console.log('â€¢ Error checking backend cache:', error);
                });
            
            console.log('\nðŸŽ¯ App Selection Status:');
            console.log('â€¢ window.selectedFraudSourceAppId:', window.selectedFraudSourceAppId);
            
            const filterElement = document.getElementById('fraud-source-app-filter');
            if (filterElement) {
                console.log('â€¢ Filter dropdown value:', filterElement.value);
                console.log('â€¢ Filter dropdown options:', Array.from(filterElement.options).map(opt => opt.value + ' - ' + opt.text));
            } else {
                console.log('â€¢ Filter dropdown not found');
            }
            
            console.log('\nðŸ“± Apps Data:');
            console.log('â€¢ window.fetchedApps:', window.fetchedApps ? window.fetchedApps.length + ' apps' : 'No apps');
            if (window.fetchedApps) {
                console.log('â€¢ Active apps:', window.fetchedApps.filter(app => app.is_active).map(app => `${app.app_name} (${app.app_id})`));
            }
            
            console.log('\nðŸ”„ Current Tab:');
            const fraudTab = document.getElementById('fraud-tab');
            const sourceSubtab = document.getElementById('fraud-source-subtab');
            console.log('â€¢ Fraud tab active:', fraudTab ? fraudTab.classList.contains('active') : false);
            console.log('â€¢ Source subtab visible:', sourceSubtab ? sourceSubtab.style.display !== 'none' : false);
            
            console.log('=====================================');
            
            // Try to trigger a render with current selection
            if (fraudSourceDataCache['10d'] && window.selectedFraudSourceAppId) {
                console.log('ðŸ”„ Attempting to render fraud source data...');
                renderFraudSource(fraudSourceDataCache['10d'], '10d');
            }
        };
        
        // Function to verify database persistence
        window.verifyDatabasePersistence = function() {
            console.log('=== Database Persistence Verification ===');
            fetch('/event-selections')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const selections = data.selections;
                        const totalSaved = Object.keys(selections).length;
                        const activeSaved = Object.values(selections).filter(s => s.is_active).length;
                        const withEventsSaved = Object.values(selections).filter(s => s.event1 || s.event2).length;
                        
                        console.log(`ðŸ“Š Database Status:`);
                        console.log(`â€¢ Total apps saved: ${totalSaved}`);
                        console.log(`â€¢ Active apps saved: ${activeSaved}`);
                        console.log(`â€¢ Apps with events saved: ${withEventsSaved}`);
                        console.log(`â€¢ Storage: Permanent (SQLite database)`);
                        console.log(`â€¢ Data persistence: Until overridden`);
                        
                        console.log('\nðŸ” Detailed saved data:');
                        Object.entries(selections).forEach(([appId, config]) => {
                            console.log(`- ${appId}: event1="${config.event1}", event2="${config.event2}", active=${config.is_active}`);
                        });
                        
                        console.log('\nâœ… All data persisted successfully in database!');
                    } else {
                        console.error('âŒ Error verifying database:', data.error);
                    }
                })
                .catch(error => {
                    console.error('âŒ Error fetching database data:', error);
                });
            console.log('==========================================');
        };
        
        // Function to check .env.local file status for deployment readiness
        window.checkEnvStatus = function() {
            console.log('=== Environment File Status Check ===');
            fetch('/env-status')
                .then(response => response.json())
                .then(data => {
                    console.log('ðŸ“ Environment File Status:');
                    console.log(`â€¢ File exists: ${data.env_file_exists ? 'âœ…' : 'âŒ'}`);
                    console.log(`â€¢ File path: ${data.env_file_path}`);
                    console.log(`â€¢ File readable: ${data.env_file_readable ? 'âœ…' : 'âŒ'}`);
                    console.log(`â€¢ File writable: ${data.env_file_writable ? 'âœ…' : 'âŒ'}`);
                    console.log(`â€¢ File size: ${data.env_file_size} bytes`);
                    console.log(`â€¢ File permissions: ${data.env_file_permissions}`);
                    console.log(`â€¢ Backup exists: ${data.backup_exists ? 'âœ…' : 'âŒ'}`);
                    if (data.env_lines_count) {
                        console.log(`â€¢ Lines in file: ${data.env_lines_count}`);
                    }
                    
                    console.log('\nðŸ”‘ Credentials Status:');
                    Object.entries(data.credentials_loaded).forEach(([key, loaded]) => {
                        console.log(`â€¢ ${key}: ${loaded ? 'âœ… Loaded' : 'âŒ Missing'}`);
                    });
                    
                    console.log(`\nðŸš€ Deployment Ready: ${data.deployment_ready ? 'âœ… YES' : 'âŒ NO'}`);
                    
                    if (!data.deployment_ready) {
                        console.log('\nâš ï¸ Deployment Issues:');
                        if (!data.env_file_exists) console.log('â€¢ .env.local file does not exist');
                        if (!data.env_file_readable) console.log('â€¢ .env.local file cannot be read');
                        if (!data.env_file_writable) console.log('â€¢ .env.local file cannot be written');
                        Object.entries(data.credentials_loaded).forEach(([key, loaded]) => {
                            if (!loaded) console.log(`â€¢ Missing credential: ${key}`);
                        });
                        console.log('\nðŸ’¡ Solution: Update credentials in Profile page to fix missing values');
                    } else {
                        console.log('\nâœ… System is ready for deployment!');
                        console.log('ðŸ’¡ Make sure to copy .env.local to your server');
                    }
                    
                    if (data.error) {
                        console.error('\nâŒ Error:', data.error);
                    }
                })
                .catch(error => {
                    console.error('âŒ Error checking environment status:', error);
                });
            console.log('=====================================');
        };
        
        // Enhanced refresh functions for comprehensive data updates
        async function forceRefreshStatsPage() {
            console.log('ðŸ”„ Force refreshing Stats page...');
            
            // Always fetch fresh stats data to ensure it's current
            try {
                const response = await fetch('/get_subpage_10d');
                const data = await response.json();
                if (data && data.apps && data.apps.length > 0) {
                    renderStatsAppsForRange('10d', data.apps);
                    console.log('âœ… Stats page refreshed successfully with', data.apps.length, 'apps');
                } else {
                    console.log('âš ï¸ Stats page: No data to refresh');
                }
            } catch (error) {
                console.error('âŒ Error refreshing Stats page:', error);
            }
        }
        
        async function forceRefreshFraudPages() {
            console.log('ðŸ”„ Force refreshing Fraud pages...');
            
            // First try to use cached data from Get All Stats
            if (fraudDataCache['10d'] && fraudDataCache['10d'].apps && fraudDataCache['10d'].apps.length > 0) {
                console.log('âœ… Using cached fraud data from Get All Stats');
                
                // Refresh Analytics tab
                renderFraudAll(fraudDataCache['10d'], '10d');
                console.log('âœ… Fraud Analytics tab refreshed from cache');
                
                // Refresh Source tab
                await refreshFraudSourceTab(fraudDataCache['10d']);
                console.log('âœ… Fraud Source tab refreshed from cache');
                
                return;
            }
            
            // Fallback: fetch from backend if no cache
            try {
                const response = await fetch('/get_fraud_subpage_10d');
                const data = await response.json();
                if (data && data.apps && data.apps.length > 0) {
                    // Update both caches
                    fraudDataCache['10d'] = data;
                    fraudSourceDataCache['10d'] = data;
                    
                    // Refresh Analytics tab
                    renderFraudAll(data, '10d');
                    console.log('âœ… Fraud Analytics tab refreshed from backend');
                    
                    // Auto-populate and trigger Source tab rendering
                    await refreshFraudSourceTab(data);
                    
                } else {
                    console.log('âš ï¸ Fraud pages: No data to refresh');
                }
            } catch (error) {
                console.error('âŒ Error refreshing Fraud pages:', error);
            }
        }
        
        async function refreshFraudSourceTab(data) {
            console.log('ðŸ”„ Refreshing Fraud Source tab...');
            
            // Ensure the filter is populated with apps
            populateFraudFilters();
            
            // Get the source filter element
            const sourceFilter = document.getElementById('fraud-source-app-filter');
            if (!sourceFilter) {
                console.log('âš ï¸ Fraud source filter not found');
                return;
            }
            
            // Check if an app is already selected
            let selectedAppId = sourceFilter.value;
            
            // If no app is selected, auto-select the first active app with fraud data
            if (!selectedAppId && data.apps && data.apps.length > 0) {
                // Find the first app with actual fraud data
                const appWithData = data.apps.find(app => 
                    app.table && app.table.length > 0
                );
                
                                 if (appWithData) {
                     selectedAppId = appWithData.app_id;
                     sourceFilter.value = selectedAppId;
                     
                     // Update the global variable that the render function uses
                     window.selectedFraudSourceAppId = selectedAppId;
                     
                     console.log(`âœ… Auto-selected app for fraud source: ${appWithData.app_name} (${selectedAppId})`);
                 } else {
                     // If no apps have data, select the first active app anyway
                     const firstActiveApp = data.apps.find(app => app.app_id);
                     if (firstActiveApp) {
                         selectedAppId = firstActiveApp.app_id;
                         sourceFilter.value = selectedAppId;
                         window.selectedFraudSourceAppId = selectedAppId;
                         console.log(`âœ… Auto-selected first available app for fraud source: ${firstActiveApp.app_name} (${selectedAppId})`);
                     }
                 }
             } else if (selectedAppId) {
                 // Ensure the global variable is set
                 window.selectedFraudSourceAppId = selectedAppId;
                 console.log(`âœ… Using already selected app for fraud source: ${selectedAppId}`);
            }
            
                         // Now render the fraud source data with the selected app
             if (selectedAppId) {
                 console.log('ðŸŽ¯ Rendering fraud source for selected app:', selectedAppId);
                 renderFraudSource(data, '10d');
                 console.log('âœ… Fraud Source tab refreshed and rendered successfully');
                 
                 // Verify the render worked by checking the container content
                 setTimeout(() => {
                     const container = document.getElementById('fraud-source-data-10d');
                     if (container) {
                         if (container.innerHTML.includes('Select a Campaign') || container.innerHTML.includes('No Cache')) {
                             // Rendering didn't work as expected, try again
                             console.log('âš ï¸ Fraud source render may have failed, retrying...');
                             renderFraudSource(data, '10d');
                         } else {
                             console.log('âœ… Fraud source data rendered successfully');
                         }
                     }
                 }, 500);
             } else {
                 console.log('âš ï¸ No app available for fraud source selection');
                 // Show updated message that data is available
                 const container = document.getElementById('fraud-source-data-10d');
                 if (container) {
                     container.innerHTML = `
                         <div class="text-center py-8">
                             <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6 max-w-md mx-auto">
                                 <div class="text-blue-600 text-lg font-semibold mb-2">ðŸ“Š Data Ready</div>
                                 <div class="text-blue-500 text-sm">Fresh fraud data loaded! Select a campaign from the filter above to analyze its sources.</div>
                             </div>
                         </div>
                     `;
                 }
             }
        }
        
        async function forceRefreshOverviewData() {
            console.log('ðŸ”„ Force refreshing Overview data...');
            try {
                // Refresh overview data
                await fetchOverviewData();
                console.log('âœ… Overview charts refreshed successfully');
                
                // Refresh top performing apps
                await fetchTopPerformingApps();
                console.log('âœ… Top performing apps refreshed successfully');
            } catch (error) {
                console.error('âŒ Error refreshing Overview data:', error);
            }
        }
        
        // Show completion alert dialog
        function showCompletionAlert(appsCount, executionTime) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            alertDiv.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl transform animate-pulse">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">ðŸŽ‰ Reports Generated Successfully!</h3>
                        <div class="text-gray-600 space-y-2 mb-6">
                            <p>âœ… Stats reports completed</p>
                            <p>âœ… Fraud reports completed</p>
                            <p>âœ… All pages refreshed with new data</p>
                            <p class="text-sm text-gray-500">ðŸ“± ${appsCount} apps processed in ${executionTime}s</p>
                        </div>
                        <button id="close-completion-alert" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Close alert when clicking button or background
            document.getElementById('close-completion-alert').onclick = () => {
                alertDiv.remove();
            };
            alertDiv.onclick = (e) => {
                if (e.target === alertDiv) {
                    alertDiv.remove();
                }
            };
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (document.body.contains(alertDiv)) {
                    alertDiv.remove();
                }
            }, 10000);
        }
        
        // Show completion toast notification
        function showCompletionToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-300 flex items-center gap-3';
            toast.innerHTML = `
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="font-semibold">Complete!</div>
                    <div class="text-sm opacity-90">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-close after delay
            setTimeout(() => {
                toast.style.transform = 'translateY(100%)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        // Initialize auto-run system when page loads (single initialization)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    initializeAutoRunSystem();
                    console.log('âœ… Auto-run system initialized (DOM ready)');
                }, 2000);
            });
        } else {
            // DOM is already loaded
            setTimeout(() => {
                initializeAutoRunSystem();
                console.log('âœ… Auto-run system initialized (DOM already ready)');
            }, 2000);
        }
        
        // ========================================
        // EXPORT FUNCTIONS
        // ========================================
        
        // Utility function to download data as CSV
        function downloadCSV(data, filename) {
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success toast
            showToast('success', `Data exported successfully as ${filename}`);
        }
        
        // Utility function to convert array of objects to CSV
        function convertToCSV(data) {
            if (!data || data.length === 0) {
                return 'No data available';
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        // Handle values that might contain commas or quotes
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }
        
        // Export Overview Data
        function exportOverviewData() {
            try {
                const data = [];
                
                // Get summary metrics
                const impressions = document.getElementById('overview-total-impressions')?.textContent || '0';
                const clicks = document.getElementById('overview-total-clicks')?.textContent || '0';
                const installs = document.getElementById('overview-total-installs')?.textContent || '0';
                const conversionRate = document.getElementById('overview-conversion-rate')?.textContent || '0%';
                
                // Add summary data
                data.push({
                    'Metric': 'Total Impressions',
                    'Value': impressions,
                    'Type': 'Summary'
                });
                data.push({
                    'Metric': 'Total Clicks',
                    'Value': clicks,
                    'Type': 'Summary'
                });
                data.push({
                    'Metric': 'Total Installs',
                    'Value': installs,
                    'Type': 'Summary'
                });
                data.push({
                    'Metric': 'Conversion Rate',
                    'Value': conversionRate,
                    'Type': 'Summary'
                });
                
                // Get top performing apps
                const topAppsTable = document.getElementById('top-apps-list');
                if (topAppsTable) {
                    const rows = topAppsTable.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 4) {
                            data.push({
                                'Metric': `Top App ${index + 1}`,
                                'App Name': cells[0]?.textContent?.trim() || '',
                                'Event 1': cells[1]?.textContent?.trim() || '0',
                                'Event 2': cells[2]?.textContent?.trim() || '0',
                                'Total Events': cells[3]?.textContent?.trim() || '0',
                                'Type': 'Top Performing Apps'
                            });
                        }
                    });
                }
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                downloadCSV(data, `AppsFlyer_Overview_${timestamp}.csv`);
                
            } catch (error) {
                console.error('Error exporting overview data:', error);
                showToast('error', 'Error exporting overview data. Please try again.');
            }
        }
        
        // Export Apps Data
        function exportAppsData() {
            try {
                if (!window.fetchedApps || window.fetchedApps.length === 0) {
                    showToast('error', 'No apps data available. Please sync apps first.');
                    return;
                }
                
                const data = window.fetchedApps.map(app => ({
                    'App ID': app.app_id || '',
                    'App Name': app.app_name || '',
                    'Platform': app.platform || '',
                    'Status': app.is_active ? 'Active' : 'Inactive',
                    'Bundle ID': app.bundle_id || '',
                    'Creation Date': app.creation_date || '',
                    'Last Updated': app.last_updated || '',
                    'Time Zone': app.time_zone || '',
                    'Event 1': app.event1 || '',
                    'Event 2': app.event2 || ''
                }));
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                downloadCSV(data, `AppsFlyer_Apps_${timestamp}.csv`);
                
            } catch (error) {
                console.error('Error exporting apps data:', error);
                showToast('error', 'Error exporting apps data. Please try again.');
            }
        }
        
        // Export Stats Data
        function exportStatsData() {
            try {
                showToast('info', 'Preparing stats data for export...');
                
                // Fetch raw data from the new endpoint
                fetch('/export/stats/raw?range=last10')
                    .then(response => response.json())
                    .then(result => {
                        if (result.error) {
                            showToast('error', result.error);
                            return;
                        }
                        
                        if (!result.data || result.data.length === 0) {
                            showToast('error', 'No stats data found to export.');
                            return;
                        }
                        
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        downloadCSV(result.data, `AppsFlyer_Stats_RAW_${timestamp}.csv`);
                        
                        showToast('success', `Stats data exported successfully! (${result.total_records} records from ${result.apps_count} apps)`);
                    })
                    .catch(error => {
                        console.error('Error fetching raw stats data:', error);
                        showToast('error', 'Error fetching stats data. Please try again.');
                    });
                
            } catch (error) {
                console.error('Error exporting stats data:', error);
                showToast('error', 'Error exporting stats data. Please try again.');
            }
        }
        
        // Export Fraud Data
        function exportFraudData() {
            try {
                showToast('info', 'Preparing fraud data for export...');
                
                // Fetch raw data from the new endpoint
                fetch('/export/fraud/raw?range=last10')
                    .then(response => response.json())
                    .then(result => {
                        if (result.error) {
                            showToast('error', result.error);
                            return;
                        }
                        
                        if (!result.data || result.data.length === 0) {
                            showToast('error', 'No fraud data found to export.');
                            return;
                        }
                        
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        downloadCSV(result.data, `AppsFlyer_Fraud_RAW_${timestamp}.csv`);
                        
                        showToast('success', `Fraud data exported successfully! (${result.total_records} records from ${result.apps_count} apps)`);
                    })
                    .catch(error => {
                        console.error('Error fetching raw fraud data:', error);
                        showToast('error', 'Error fetching fraud data. Please try again.');
                    });
                
            } catch (error) {
                console.error('Error exporting fraud data:', error);
                showToast('error', 'Error exporting fraud data. Please try again.');
            }
        }
        
        // Show toast notification
        function showToast(type, message) {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            const icon = type === 'success' ? 
                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                type === 'error' ? 
                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' :
                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-300 flex items-center gap-3`;
            toast.innerHTML = `
                <div class="flex-shrink-0">${icon}</div>
                <div class="flex-1">
                    <div class="font-semibold">${type === 'success' ? 'Success!' : type === 'error' ? 'Error!' : 'Info'}</div>
                    <div class="text-sm opacity-90">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-close after delay
            setTimeout(() => {
                toast.style.transform = 'translateY(100%)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Profile Page Raw Data Export Functions
        function exportRawStatsData() {
            try {
                showToast('info', 'Preparing raw stats data for export...');
                
                fetch('/export/stats/raw?range=last10')
                    .then(response => response.json())
                    .then(result => {
                        if (result.error) {
                            showToast('error', result.error);
                            return;
                        }
                        
                        if (!result.data || result.data.length === 0) {
                            showToast('error', 'No raw stats data found. Please run "Get All Stats" first.');
                            return;
                        }
                        
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        downloadCSV(result.data, `AppsFlyer_Stats_RAW_DATA_${timestamp}.csv`);
                        
                        showToast('success', `Raw stats data exported successfully! (${result.total_records} records from ${result.apps_count} apps)`);
                    })
                    .catch(error => {
                        console.error('Error fetching raw stats data:', error);
                        showToast('error', 'Error fetching raw stats data. Please try again.');
                    });
                
            } catch (error) {
                console.error('Error exporting raw stats data:', error);
                showToast('error', 'Error exporting raw stats data. Please try again.');
            }
        }

        function exportRawFraudData() {
            try {
                showToast('info', 'Preparing raw fraud data for export...');
                
                fetch('/export/fraud/raw?range=last10')
                    .then(response => response.json())
                    .then(result => {
                        if (result.error) {
                            showToast('error', result.error);
                            return;
                        }
                        
                        if (!result.data || result.data.length === 0) {
                            showToast('error', 'No raw fraud data found. Please run "Get All Stats" first.');
                            return;
                        }
                        
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        downloadCSV(result.data, `AppsFlyer_Fraud_RAW_DATA_${timestamp}.csv`);
                        
                        showToast('success', `Raw fraud data exported successfully! (${result.total_records} records from ${result.apps_count} apps)`);
                    })
                    .catch(error => {
                        console.error('Error fetching raw fraud data:', error);
                        showToast('error', 'Error fetching raw fraud data. Please try again.');
                    });
                
            } catch (error) {
                console.error('Error exporting raw fraud data:', error);
                showToast('error', 'Error exporting raw fraud data. Please try again.');
            }
        }

        // Original AppsFlyer Raw Data Export Functions
        function exportRawDailyReport() {
            try {
                showToast('info', 'Preparing original daily report data for export...');
                
                const url = '/export/raw/daily_report?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'Daily report export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting daily report:', error);
                showToast('error', 'Error exporting daily report. Please try again.');
            }
        }

        function exportRawBlockedInstalls() {
            try {
                showToast('info', 'Preparing original blocked installs data for export...');
                
                const url = '/export/raw/blocked_installs_report?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'Blocked installs export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting blocked installs:', error);
                showToast('error', 'Error exporting blocked installs. Please try again.');
            }
        }

        function exportRawDetection() {
            try {
                showToast('info', 'Preparing original detection (PA) data for export...');
                
                const url = '/export/raw/detection?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'Detection (PA) export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting detection data:', error);
                showToast('error', 'Error exporting detection data. Please try again.');
            }
        }

        function exportRawBlockedEvents() {
            try {
                showToast('info', 'Preparing original blocked in-app events data for export...');
                
                const url = '/export/raw/blocked_in_app_events_report?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'Blocked in-app events export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting blocked events:', error);
                showToast('error', 'Error exporting blocked events. Please try again.');
            }
        }

        function exportRawFraudPostInApps() {
            try {
                showToast('info', 'Preparing original fraud post-inapps data for export...');
                
                const url = '/export/raw/fraud_post_inapps?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'Fraud post-inapps export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting fraud post-inapps:', error);
                showToast('error', 'Error exporting fraud post-inapps. Please try again.');
            }
        }

        function exportRawBlockedClicks() {
            try {
                showToast('info', 'Preparing original blocked clicks data for export...');
                
                const url = '/export/raw/blocked_clicks_report?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'Blocked clicks export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting blocked clicks:', error);
                showToast('error', 'Error exporting blocked clicks. Please try again.');
            }
        }

        function exportRawBlockedPostbacks() {
            try {
                showToast('info', 'Preparing original blocked install postbacks data for export...');
                
                const url = '/export/raw/blocked_install_postbacks?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'Blocked install postbacks export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting blocked postbacks:', error);
                showToast('error', 'Error exporting blocked postbacks. Please try again.');
            }
        }

        function exportRawInAppEvents() {
            try {
                showToast('info', 'Preparing original in-app events data for export...');
                
                const url = '/export/raw/in_app_events_report?period=last10';
                window.open(url, '_blank');
                
                showToast('success', 'In-app events export started. Check your downloads folder.');
            } catch (error) {
                console.error('Error exporting in-app events:', error);
                showToast('error', 'Error exporting in-app events. Please try again.');
            }
        }
    </script>


</body>
</html> 